<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>長さのたし算とひき算</title>
  <style>
    /* デザインは赤系 */
    body {
      font-family: 'HiraMaruProN-W4', 'ヒラギノ丸ゴ ProN W4', 'メイリオ', Meiryo, sans-serif;
      background: #ffebee; margin: 20px; color: #333; font-size: 1.8rem; line-height: 1.6;
    }
    h1, h2 {
      text-align: center; margin: 15px 0; color: #c62828; text-shadow: 2px 2px 3px rgba(0,0,0,0.1); white-space: nowrap;
    }
    h1 { font-size: 3.2rem; }
    h2 { font-size: 2.2rem; margin-bottom: 30px; }
    #problems-wrapper {
      max-width: 850px; margin: 0 auto 30px; padding: 30px; border: 4px dashed #ef9a9a;
      background: #ffffff; box-shadow: 5px 5px 10px rgba(0,0,0,.15); border-radius: 20px;
    }
    .problem {
      display: flex; align-items: center; margin-bottom: 25px; background: #fce4ec; padding: 15px 20px; border-radius: 10px;
    }
    /* ▼▼▼修正点1: 番号欄の幅と余白を調整▼▼▼ */
    .problem-number {
      width: 60px; /* 2桁になっても余裕のある幅に */
      margin-right: 15px; /* 式との間に余白を追加 */
      flex-shrink: 0; /* 縮まないように設定 */
      font-weight: bold;
      font-size: 2.2rem;
      color: #880e4f;
    }
    .problem-equation {
      flex: 1; display: flex; align-items: center; font-size: 2.2rem; justify-content: space-between;
      min-width: 0; /* flexアイテムが親をはみ出さないようにする設定 */
    }
    .problem-text-part, .problem-answer-part { display: flex; align-items: center; gap: 5px; }
    /* ▼▼▼修正点2: 問題文の途中で改行されないようにする▼▼▼ */
    .problem-text-part > span {
        white-space: nowrap;
    }
    .problem-equation .unit { margin-left: 2px; }
    .problem-equation .op, .problem-equation .equals { margin: 0 5px; }
    input[type=number] {
      -moz-appearance: textfield; width: 100px; font-size: 2.2rem; padding: 8px;
      border: 2px solid #f48fb1; border-radius: 8px; text-align: center;
    }
    input[type=number].km { width: 90px; }
    input[type=number]::-webkit-outer-spin-button, input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .button-area { text-align: center; margin-bottom: 30px; }
    button {
      font-size: 2.2rem; margin: 0 15px; padding: 15px 30px; background: #e91e63; color: white;
      border: none; border-radius: 15px; cursor: pointer; box-shadow: 3px 3px 6px rgba(0,0,0,.2);
      transition: background 0.3s ease, transform 0.1s ease;
    }
    button:hover { background: #c2185b; transform: translateY(-2px); }
    button:disabled { background: #ccc; cursor: default; box-shadow: none; transform: none; }
    #result-area {
        max-width: 600px; margin: 0 auto; text-align: center; margin-bottom: 25px;
        background: #fce4ec; padding: 20px; border-radius: 15px; border: 2px solid #f8bbd0;
    }
    #result { font-size: 2.5rem; font-weight: bold; margin: 15px 0; color: #d32f2f; }
    #highScoreArea, #clearCountArea, #monthlyCountArea, #dailyCountArea, #overallStatusArea {
      font-size: 1.8rem; margin: 8px 0;
    }
    #highScoreValue, #clearCountValue, #monthlyCountValue, #dailyCountValue {
      font-weight: bold; margin: 0 10px; color: #880e4f;
    }
    #reset-highscore { font-size: 1.5rem; margin-left: 15px; padding: 6px 14px; background: #ef5350; color: white; border-radius: 10px; }
    #reset-highscore:hover { background: #c62828; }
    #history-area {
      font-size: 1.6rem; margin: 20px 0; text-align: left; max-width: 400px;
      margin-left: auto; margin-right: auto; padding: 10px; background: #f8bbd0;
      border-radius: 10px; border: 1px solid #f48fb1;
    }
    #history-list { list-style: none; padding: 0; margin: 0; }
    #history-list li { margin: 5px 0; color: #880e4f; }
    .result-icon { margin-left: 15px; font-size: 2.2rem; font-weight: bold; }
    .correct { color: #388e3c; }
    .wrong { color: #f57c00; }
    #overallStatusArea { display: flex; justify-content: center; align-items: center; }
    .status-stars{ display: inline-flex; font-size: 2rem; color: gold; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); line-height: 1; margin-left: 10px; }

    @media (max-width: 880px) {
        .problem-equation {
            flex-wrap: wrap; justify-content: normal; row-gap: 10px;
        }
        .problem-text-part, .problem-answer-part {
            flex-basis: 100%;
        }
        .problem-answer-part {
            justify-content: flex-end;
        }
        h1 { font-size: 2.8rem; }
        h2 { font-size: 2rem; }
    }
  </style>
</head>
<body>
  <h1>８　長さ</h1>
  <h2>長さのたし算とひき算</h2>

  <div id="start-area" style="text-align:center; margin:40px 0;"><button id="start-btn">スタート！</button></div>
  <div id="problems-section" style="display:none;">
    <div id="problems-wrapper"></div>
    <div class="button-area">
      <button id="check-answers">まるつけ</button>
      <button id="retry">もういちど</button>
    </div>
  </div>
  <div id="result-area"></div>

  <script>
    // JavaScript部分は変更ありません
    const APP_ID = '2_nagasa_keisan';
    const KEY_HS             = APP_ID + ':hs';
    const KEY_CLEAR          = APP_ID + ':clear';
    const KEY_MONTHLY_PREFIX = APP_ID + ':monthlyClear-';
    const KEY_DAILY_PREFIX   = APP_ID + ':dailyClear-';
    const KEY_HISTORY        = APP_ID + ':history';
    const KEY_OVERALL_STATUS = APP_ID + ':status';
    const NUM_QUESTIONS = 10, TIME_LIMIT = 100;
    const SCORE_STARS_THRESHOLD = { star_circle: 100, star1: 101, star2: 110, star3: 120, star4: 130, star5: 140, star6: 150 };
    let problems = [], startTime = 0, highScore = 0, totalClearCount = 0, monthlyCount = 0, dailyCount = 0, overallStatusStars = '―', incorrectIndices = [];
    const ls = localStorage;

    function loadAllData(){ highScore = +ls.getItem(KEY_HS) || 0; totalClearCount = +ls.getItem(KEY_CLEAR) || 0; overallStatusStars = ls.getItem(KEY_OVERALL_STATUS) || '―'; dailyCount = +ls.getItem(KEY_DAILY_PREFIX + new Date().toISOString().slice(0, 10)) || 0; monthlyCount = +ls.getItem(KEY_MONTHLY_PREFIX + new Date().toISOString().slice(0, 7)) || 0; }
    function loadHistory(){ try { return JSON.parse(ls.getItem(KEY_HISTORY)) || []; } catch { return []; } }
    function saveAllData(score) { if (score > highScore) { highScore = score; ls.setItem(KEY_HS, String(highScore)); } totalClearCount++; monthlyCount++; dailyCount++; ls.setItem(KEY_CLEAR, String(totalClearCount)); ls.setItem(KEY_DAILY_PREFIX + new Date().toISOString().slice(0, 10), String(dailyCount)); ls.setItem(KEY_MONTHLY_PREFIX + new Date().toISOString().slice(0, 7), String(monthlyCount)); ls.setItem(KEY_OVERALL_STATUS, overallStatusStars); const history = loadHistory(); history.unshift({ datetime: new Date().toLocaleString(), score: score }); if (history.length > 10) history.pop(); ls.setItem(KEY_HISTORY, JSON.stringify(history)); }
    function updateAllDisplays(){ document.querySelector('#highScoreValue').textContent = highScore; document.querySelector('#clearCountValue').textContent = totalClearCount; document.querySelector('#monthlyCountValue').textContent = monthlyCount; document.querySelector('#dailyCountValue').textContent = dailyCount; document.querySelector('#overallStars').innerHTML = overallStatusStars; renderHistory(); }
    function renderHistory(){ const ul = document.querySelector('#history-list'); ul.innerHTML = ''; loadHistory().forEach(item => { const li = document.createElement('li'); li.textContent = `${item.datetime}：${item.score}てん`; ul.appendChild(li); }); }
    function generateProblems() { const allFacts = []; for (let i = 0; i < 30; i++) { const kmA = Math.floor(Math.random() * 8) + 1; const mA1 = (Math.floor(Math.random() * 9) + 1) * 100; const mA2 = (Math.floor(Math.random() * (900 - mA1) / 100) + (1000 - mA1) / 100) * 100; const totalM_A = (kmA * 1000) + mA1 + mA2; allFacts.push({ type: 'add', text: `${kmA}km ${mA1}m`, op: '+', val: `${mA2}m`, answers: { km: Math.floor(totalM_A / 1000), m: totalM_A % 1000 } }); const kmB = Math.floor(Math.random() * 8) + 2; const mB1 = (Math.floor(Math.random() * 8) + 1) * 100; const mB2 = (Math.floor(Math.random() * (900 - mB1) / 100) + (mB1 / 100) + 1) * 100; const totalM_B = (kmB * 1000) + mB1 - mB2; allFacts.push({ type: 'sub', text: `${kmB}km ${mB1}m`, op: '-', val: `${mB2}m`, answers: { km: Math.floor(totalM_B / 1000), m: totalM_B % 1000 } }); const kmC = Math.floor(Math.random() * 8) + 2; const mC = (Math.floor(Math.random() * 9) + 1) * 100; const totalM_C = (kmC * 1000) - mC; allFacts.push({ type: 'sub', text: `${kmC}km`, op: '-', val: `${mC}m`, answers: { km: Math.floor(totalM_C / 1000), m: totalM_C % 1000 } }); } for (let i = allFacts.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [allFacts[i], allFacts[j]] = [allFacts[j], allFacts[i]]; } problems = allFacts.slice(0, NUM_QUESTIONS); }
    function displayProblems() { const wrap = document.querySelector('#problems-wrapper'); wrap.innerHTML = ''; problems.forEach((p, i) => { const row = document.createElement('div'); row.className = 'problem'; const num = document.createElement('div'); num.className = 'problem-number'; num.textContent = (i + 1) + '.'; const eq = document.createElement('div'); eq.className = 'problem-equation'; eq.innerHTML = `<div class="problem-text-part"><span>${p.text}</span><span class="op">${p.op}</span><span>${p.val}</span></div><div class="problem-answer-part"><span class="equals">＝</span><input type="number" id="ans-${i}-km" class="km"><span class="unit">km</span><input type="number" id="ans-${i}-m"><span class="unit">m</span><span id="icon-${i}" class="result-icon"></span></div>`; row.append(num, eq); wrap.appendChild(row); const inputs = eq.querySelectorAll('input'); inputs.forEach((input, inputIndex) => { input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); if (inputIndex < inputs.length - 1) { inputs[inputIndex + 1].focus(); inputs[inputIndex + 1].select(); } else { let nextProblemToFocus = -1; if (incorrectIndices.length > 0) { const currentIndexInIncorrect = incorrectIndices.indexOf(i); if (currentIndexInIncorrect !== -1 && currentIndexInIncorrect < incorrectIndices.length - 1) { nextProblemToFocus = incorrectIndices[currentIndexInIncorrect + 1]; } } else if (i < NUM_QUESTIONS - 1) { nextProblemToFocus = i + 1; } if (nextProblemToFocus !== -1) { const nextInput = document.querySelector(`#ans-${nextProblemToFocus}-km`); if (nextInput) { nextInput.focus(); nextInput.select(); } } else { document.querySelector('#check-answers').focus(); } } } }); }); }); }
    function checkAnswers() { document.querySelector('#check-answers').disabled = true; let currentCorrectCount = 0; incorrectIndices = []; problems.forEach((p, i) => { const userKm = +document.querySelector(`#ans-${i}-km`).value; const userM = +document.querySelector(`#ans-${i}-m`).value; const isCorrect = userKm === p.answers.km && userM === p.answers.m; const icon = document.querySelector(`#icon-${i}`); const inputs = document.querySelectorAll(`[id^="ans-${i}-"]`); if (inputs.length > 0 && inputs[0].disabled) { currentCorrectCount++; return; } if (isCorrect) { currentCorrectCount++; icon.textContent = '○'; icon.className = 'result-icon correct'; inputs.forEach(inp => { inp.disabled = true; inp.style.borderColor = '#e0e0e0'; }); } else { icon.textContent = '×'; icon.className = 'result-icon wrong'; incorrectIndices.push(i); inputs.forEach(inp => { inp.style.borderColor = '#ef9a9a'; }); } }); if (incorrectIndices.length === 0) { const elapsed = ((Date.now() - startTime) / 1000); let score = 100 + Math.floor(Math.max(0, TIME_LIMIT - elapsed) * (100 / TIME_LIMIT)); if (score >= SCORE_STARS_THRESHOLD.star6) overallStatusStars = '★★★★★★'; else if (score >= SCORE_STARS_THRESHOLD.star5) overallStatusStars = '★★★★★'; else if (score >= SCORE_STARS_THRESHOLD.star4) overallStatusStars = '★★★★'; else if (score >= SCORE_STARS_THRESHOLD.star3) overallStatusStars = '★★★'; else if (score >= SCORE_STARS_THRESHOLD.star2) overallStatusStars = '★★'; else if (score >= SCORE_STARS_THRESHOLD.star1) overallStatusStars = '★'; else if (score >= SCORE_STARS_THRESHOLD.star_circle) overallStatusStars = '○'; document.querySelector('#result').innerHTML = `スコア: <strong>${score}てん</strong><br>タイム: ${elapsed.toFixed(1)} 秒`; saveAllData(score); updateAllDisplays(); document.querySelector('#retry').focus(); } else { document.querySelector('#result').innerHTML = `あと<strong>${incorrectIndices.length}もん！</strong>がんばって！`; document.querySelector('#check-answers').disabled = false; const firstWrongInput = document.querySelector(`#ans-${incorrectIndices[0]}-km`); if (firstWrongInput) { firstWrongInput.focus(); firstWrongInput.select(); } } }
    function retry() { startTime = Date.now(); document.querySelector('#check-answers').disabled = false; document.querySelector('#result').textContent = ''; incorrectIndices = []; generateProblems(); displayProblems(); const firstInput = document.querySelector('#ans-0-km'); if (firstInput) firstInput.focus(); }
    function resetHighScore() { if(confirm('ハイスコアとステータスをリセットしますか？')){ highScore = 0; overallStatusStars = '―'; ls.removeItem(KEY_HS); ls.removeItem(KEY_OVERALL_STATUS); updateAllDisplays(); } }
    window.addEventListener('DOMContentLoaded', () => { document.querySelector('#result-area').innerHTML = `<div id="result"></div><div id="highScoreArea">ハイスコア：<span id="highScoreValue">0</span>てん <button id="reset-highscore">リセット</button></div><div id="dailyCountArea">今日のクリア：<span id="dailyCountValue">0</span>かい</div><div id="monthlyCountArea">今月のクリア：<span id="monthlyCountValue">0</span>かい</div><div id="clearCountArea">合計クリア：<span id="clearCountValue">0</span>かい</div><div id="overallStatusArea">ステータス：<span id="overallStars" class="status-stars">―</span></div><div id="history-area">りれき（さいきん１０件）<br><ul id="history-list"></ul></div>`; loadAllData(); updateAllDisplays(); const startBtn = document.querySelector('#start-btn'), startArea = document.querySelector('#start-area'), problemsSection = document.querySelector('#problems-section'); startBtn.onclick = () => { startArea.style.display = 'none'; problemsSection.style.display = 'block'; retry(); }; document.addEventListener('keydown', e => { if (e.key === 'Enter' && startArea.style.display !== 'none') { startBtn.click(); } }); document.querySelector('#check-answers').onclick = checkAnswers; document.querySelector('#retry').onclick = retry; document.querySelector('#reset-highscore').onclick = resetHighScore; });
  </script>
</body>
</html>