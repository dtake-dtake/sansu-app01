<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>３桁たし算　くり上がり1回まで</title>
  <style>
    :root { --cell-size: 70px; }
    html { scroll-behavior: smooth; }
    body { font-family: 'HiraMaruProN-W4','メイリオ',Meiryo,sans-serif; background:#f0f4c3; margin:20px; color:#333; font-size:1.8rem; line-height:1.6; }
    h1,h2 { text-align:center; margin:15px 0; color:#558b2f; text-shadow:2px 2px 3px rgba(0,0,0,.1); white-space:nowrap; }
    h1{font-size:3.5rem;} h2{font-size:2.5rem; margin-bottom:30px;}
    #problems-wrapper{max-width:550px; margin:0 auto 30px; padding:20px; border:4px dashed #aed581; background:#fff; box-shadow:5px 5px 10px rgba(0,0,0,.15); border-radius:20px;}
    .hissan-table{border-collapse:collapse; margin:40px auto; font-family:"Kyokasho","教科書体",serif; direction:rtl;}
    .hissan-table td{width:var(--cell-size); height:var(--cell-size); text-align:center; vertical-align:middle; font-size:3rem; padding:0; border:none; direction:ltr; position:relative;}
    .carry-row td{height:calc(var(--cell-size)*0.7);} 
    .answer-row td:not(.problem-number-cell){border-top:3px solid #333;}
    .sign-col{width:calc(var(--cell-size)*0.6);} .problem-number-cell{font-size:2.5rem; color:#33691e; font-weight:bold; width:auto; padding-right:15px; font-family:sans-serif;}
    input{width:100%; height:100%; border:1px solid #ccc; border-radius:8px; background:transparent; text-align:center; box-sizing:border-box; font-family:inherit;}
    .answer-input{border:2px solid #c5e1a5; font-size:3rem;} .carry-input{font-size:2rem; color:#d32f2f; border:1px solid #ddd;}
    .correct-field{background:#e8f5e9!important; border-color:#a5d6a7!important;} .incorrect-field{background:#ffebee!important;}
    input:disabled{color:#333;} input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none; margin:0;} input[type=number]{-moz-appearance:textfield;}
    .button-area,#result-area{text-align:center;} .button-area{margin-bottom:30px;}
    button{font-size:2.5rem; margin:0 15px; padding:15px 30px; background:#8bc34a; color:white; border:none; border-radius:15px; cursor:pointer;}
    button:disabled{background:#ccc; cursor:default;} #result-area{margin-bottom:25px; background:#f9fbe7; padding:20px; border-radius:15px; border:2px solid #dce775;}
    #result{font-size:2.8rem; font-weight:bold; margin:15px 0; min-height:3rem;}
    #highScoreArea,#clearCountArea,#monthlyCountArea,#dailyCountArea,#overallStatusArea{font-size:2.2rem; margin:8px 0;}
    #highScoreValue,#clearCountValue,#monthlyCountValue,#dailyCountValue,#overallStars{font-weight:bold; margin:0 12px; color:#2e7d32;}
    #reset-highscore{font-size:1.8rem; margin-left:15px; padding:8px 18px; background:#ef5350;}
    #history-area{font-size:1.8rem; margin-top:20px; text-align:left; max-width:500px; margin-left:auto; margin-right:auto;}
    #history-list{list-style:none; padding:0; margin:0;}
  </style>
</head>
<body>
  <h1>３　たし算とひき算の筆算</h1>
  <h2>３桁たし算　くり上がり1回まで</h2>

  <div id="start-area" style="text-align:center; margin:40px 0;"><button id="start-btn">スタート！</button></div>
  <div id="problems-section" style="display:none;">
    <div id="problems-wrapper"></div>
    <div class="button-area">
      <button id="check-answers">まるつけ</button>
      <button id="retry">もういちど</button>
    </div>
  </div>

  <div id="result-area">
    <div id="result"></div>
    <div id="highScoreArea">ハイスコア：<span id="highScoreValue">0</span> てん <button id="reset-highscore">リセット</button></div>
    <div id="dailyCountArea">今日のクリア：<span id="dailyCountValue">0</span> かい</div>
    <div id="monthlyCountArea">今月のクリア：<span id="monthlyCountValue">0</span> かい</div>
    <div id="clearCountArea">合計クリア：<span id="clearCountValue">0</span> かい</div>
    <div id="overallStatusArea">ステータス：<span id="overallStars">―</span></div>
    <div id="history-area">りれき（１０件）<br><ul id="history-list"></ul></div>
  </div>

  <script>
    /////////////////////////////////////////////////
    //  定数・共通ユーティリティ
    /////////////////////////////////////////////////
    const APP_ID = '01_kuriagari_10i';
    const KEY_HS             = APP_ID + ':hs';
    const KEY_CLEAR          = APP_ID + ':clear';
    const KEY_MONTHLY_PREFIX = APP_ID + ':monthlyClear-';
    const KEY_DAILY_PREFIX   = APP_ID + ':dailyClear-';
    const KEY_HISTORY        = APP_ID + ':history';
    const KEY_OVERALL_STATUS = APP_ID + ':status';

    const SCORE_STARS_THRESHOLD = { circle: 100, star1: 110, star2: 130, star3: 150 };

    const startArea = document.getElementById('start-area'), problemsSection = document.getElementById('problems-section'), resultArea = document.getElementById('result-area');
    const checkBtn = document.getElementById('check-answers'), resetHighScoreBtn = document.getElementById('reset-highscore');
    let retryBtn;

    const ls = localStorage;

    const toDigits = (num, len) => num.toString().padStart(len, '0').split('').map(Number);
    const scrollCenter = el => el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    const nowDT = () => new Date().toLocaleString();

    /////////////////////////////////////////////////
    //  状態変数
    /////////////////////////////////////////////////
    let problems = [];
    let incorrectFieldIds = [];
    let currentProblemInView = -1;
    let startTime = 0;
    let highScore = 0, totalClearCount = 0, monthlyCount = 0, dailyCount = 0, overallStatusStars = '―';

    /////////////////////////////////////////////////
    //  データの永続化
    /////////////////////////////////////////////////
    function loadData() {
      highScore = +ls.getItem(KEY_HS) || 0;
      const todayKey = KEY_DAILY_PREFIX + new Date().toISOString().slice(0, 10);
      const monthKey = KEY_MONTHLY_PREFIX + new Date().toISOString().slice(0, 7);
      totalClearCount = +ls.getItem(KEY_CLEAR) || 0;
      monthlyCount = +ls.getItem(monthKey) || 0;
      dailyCount = +ls.getItem(todayKey) || 0;
      overallStatusStars = ls.getItem(KEY_OVERALL_STATUS) || '―';
    }

    function saveData(score, starsHtml) {
      if (score > highScore) { highScore = score; ls.setItem(KEY_HS, highScore); }
      const todayKey = KEY_DAILY_PREFIX + new Date().toISOString().slice(0, 10);
      const monthKey = KEY_MONTHLY_PREFIX + new Date().toISOString().slice(0, 7);
      ls.setItem(KEY_CLEAR, ++totalClearCount);
      ls.setItem(monthKey, ++monthlyCount);
      ls.setItem(todayKey, ++dailyCount);
      overallStatusStars = starsHtml; ls.setItem(KEY_OVERALL_STATUS, starsHtml);
      const history = JSON.parse(ls.getItem(KEY_HISTORY) || '[]');
      history.unshift({ datetime: nowDT(), score });
      if (history.length > 10) history.pop();
      ls.setItem(KEY_HISTORY, JSON.stringify(history));
    }

    /////////////////////////////////////////////////
    //  表示更新
    /////////////////////////////////////////////////
    function updateDisplay() {
      document.getElementById('highScoreValue').textContent = highScore;
      document.getElementById('dailyCountValue').textContent = dailyCount;
      document.getElementById('monthlyCountValue').textContent = monthlyCount;
      document.getElementById('clearCountValue').textContent = totalClearCount;
      document.getElementById('overallStars').innerHTML = overallStatusStars;
      const history = JSON.parse(ls.getItem(KEY_HISTORY) || '[]');
      document.getElementById('history-list').innerHTML = history.map(h => `<li>${h.datetime}：${h.score}てん</li>`).join('');
    }

    /////////////////////////////////////////////////
    //  問題生成ロジック
    /////////////////////////////////////////////////
    function genProblem(cond, used) {
      for (let attempt = 0; attempt < 1000; attempt++) {
        const res = cond();
        if (!res) continue;
        const key = `${res.a}+${res.b}`;
        if (!used.has(key)) { used.add(key); return res; }
      }
      return null;
    }

    function generateProblems() {
      problems = [];
      const used = new Set();

      //////////////////////////////////////////
      //  各タイプの条件関数
      //////////////////////////////////////////
      const condType1 = () => { // 繰り上がりなし
        const a = Math.floor(Math.random() * 900) + 100;
        const b = Math.floor(Math.random() * 900) + 100;
        if (a + b >= 1000) return null;
        const [ah, at, ao] = toDigits(a, 3), [bh, bt, bo] = toDigits(b, 3);
        if (ao + bo < 10 && at + bt < 10 && ah + bh < 10) return { a, b };
        return null;
      };

      const condCarryOne = (makeB) => () => {
        const a = Math.floor(Math.random() * 900) + 100;
        const b = makeB();
        if (a + b >= 1000) return null;
        const [ah, at, ao] = toDigits(a, 3), [bh, bt, bo] = toDigits(b, 3);
        const carry1 = (ao + bo >= 10) ? 1 : 0;
        const carry2 = (at + bt + carry1 >= 10) ? 1 : 0;
        if (carry1 === 1 && carry2 === 0) return { a, b };
        return null;
      };

      const condType2a = condCarryOne(() => Math.floor(Math.random() * 900) + 100); // 3桁+3桁
      const condType2b = condCarryOne(() => Math.floor(Math.random() * 90) + 10);   // 3桁+2桁

      const condType3a = () => {
        const a = Math.floor(Math.random() * 900) + 100;
        let b;
        for (let i = 0; i < 1000; i++) {
          b = Math.floor(Math.random() * 900) + 100;
          const bt = toDigits(b, 3)[1];
          if (bt === 0) break;
        }
        if (a + b >= 1000) return null;
        const [ah, at, ao] = toDigits(a, 3), [bh, bt, bo] = toDigits(b, 3);
        const carry1 = (ao + bo >= 10) ? 1 : 0;
        const carry2 = (at + bt + carry1 >= 10) ? 1 : 0;
        if (bt === 0 && carry1 === 1 && carry2 === 0) return { a, b };
        return null;
      };

      const condType3b = () => {
        const a = Math.floor(Math.random() * 900) + 100;
        let b;
        for (let i = 0; i < 1000; i++) {
          b = Math.floor(Math.random() * 900) + 100;
          const [ , bt] = toDigits(b, 3);
          const [ , at] = toDigits(a, 3);
          if (at === 0 && bt === 0) break;
        }
        const [ah, at, ao] = toDigits(a, 3);
        const [bh, bt, bo] = toDigits(b, 3);
        if (at !== 0 || bt !== 0) return null;  // 十の位が双方0
        if (a + b >= 1000) return null;
        const carry1 = (ao + bo >= 10) ? 1 : 0;
        const carry2 = (at + bt + carry1 >= 10) ? 1 : 0; // ここは持ち越し計算上常に0
        if (carry1 === 1 && carry2 === 0) return { a, b };
        return null;
      };

      //////////////////////////////////////////
      //  問題を収集
      //////////////////////////////////////////
      const pushIf = (cond) => {
        const p = genProblem(cond, used);
        if (p) problems.push(p);
      };

      // タイプ1を 2 問生成
      pushIf(condType1);
      pushIf(condType1);
      // 残りタイプ
      pushIf(condType2a);
      pushIf(condType2b);
      pushIf(condType3a); // 3a と 3b のどちらかが生成出来なければ再試行
      if (problems.length < NUM_QUESTIONS) pushIf(condType3b);

      // まだ足りない場合、タイプ2a で穴埋め
      while (problems.length < NUM_QUESTIONS) pushIf(condType2a);

      // 問題オブジェクトを詳細化
      problems = problems.map(({ a, b }) => {
        const sum = a + b;
        const [ah, at, ao] = toDigits(a, 3);
        const [bh, bt, bo] = toDigits(b, 3);
        const [sh, st, so] = toDigits(sum, 3);
        const carryT = (ao + bo >= 10) ? 1 : 0;
        const carryH = (at + bt + carryT >= 10) ? 1 : 0; // 常に 0 になるはず
        return {
          numA: { h: ah, t: at, o: ao },
          numB: { h: bh, t: bt, o: bo },
          answer: { h: sh, t: st, o: so },
          carry: { t: carryT, h: carryH },
          navState: {}
        };
      });
    }

    /////////////////////////////////////////////////
    //  画面描画
    /////////////////////////////////////////////////
    function displayProblems() {
      const wrapper = document.getElementById('problems-wrapper');
      wrapper.innerHTML = '';

      problems.forEach((p, i) => {
        const table = document.createElement('table');
        table.className = 'hissan-table';
        table.id = `problem-table-${i}`;

        // 2 桁の表示を処理
        const numB_h_disp = p.numB.h > 0 ? p.numB.h : '';
        const numB_t_disp = (p.numB.h > 0 || p.numB.t > 0) ? p.numB.t : '';

        table.innerHTML = `
          <tr class="carry-row">
            <td></td>
            <td><input type="number" class="carry-input" id="carry-t-${i}" maxlength="1" ${p.carry.t === 0 ? 'style="visibility:hidden"' : ''}></td>
            <td><input type="number" class="carry-input" id="carry-h-${i}" maxlength="1" ${p.carry.h === 0 ? 'style="visibility:hidden"' : ''}></td>
            <td class="sign-col"></td>
            <td class="problem-number-cell"></td>
          </tr>
          <tr>
            <td>${p.numA.o}</td>
            <td>${p.numA.t}</td>
            <td>${p.numA.h}</td>
            <td class="sign-col"></td>
            <td class="problem-number-cell">${i + 1}.</td>
          </tr>
          <tr>
            <td>${p.numB.o}</td>
            <td>${numB_t_disp}</td>
            <td>${numB_h_disp}</td>
            <td class="sign-col">+</td>
            <td class="problem-number-cell"></td>
          </tr>
          <tr class="answer-row">
            <td><input type="number" class="answer-input" id="ans-o-${i}" maxlength="1"></td>
            <td><input type="number" class="answer-input" id="ans-t-${i}" maxlength="1"></td>
            <td><input type="number" class="answer-input" id="ans-h-${i}" maxlength="1"></td>
            <td class="sign-col"></td>
            <td class="problem-number-cell"></td>
          </tr>`;

        wrapper.appendChild(table);

        // ナビゲーション用イベント設定
        const inputIds = ['ans-o','ans-t','ans-h','carry-t','carry-h'].map(id => `${id}-${i}`);
        inputIds.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener('focus', () => {
            if (currentProblemInView !== i) {
              scrollCenter(table); currentProblemInView = i;
            }
            el.select();
          });
          el.addEventListener('keydown', e => handleNav(e, i, id));
        });
      });
    }

    /////////////////////////////////////////////////
    //  キーボード遷移ロジック
    /////////////////////////////////////////////////
    function handleNav(e, idx, id) {
      const [type, place] = id.split('-').slice(0,2); // ans-o, carry-t など
      const p = problems[idx];
      let nextId = null;
      if (e.key === 'Enter') {
        e.preventDefault();
        const order = incorrectFieldIds.length > 0 ? incorrectFieldIds : null;
        if (order) {
          const cur = order.indexOf(id);
          if (cur > -1 && cur < order.length - 1) nextId = order[cur + 1];
        } else {
          // 通常順
          if (type === 'ans' && place === 'o') {
            if (p.carry.t === 1 && !p.navState.carryTEntered) nextId = `carry-t-${idx}`; else nextId = `ans-t-${idx}`;
          } else if (type === 'carry' && place === 't') {
            p.navState.carryTEntered = true; nextId = `ans-o-${idx}`;
          } else if (type === 'ans' && place === 't') {
            if (p.carry.h === 1 && !p.navState.carryHEntered) nextId = `carry-h-${idx}`; else nextId = `ans-h-${idx}`;
          } else if (type === 'carry' && place === 'h') {
            p.navState.carryHEntered = true; nextId = `ans-h-${idx}`;
          } else if (type === 'ans' && place === 'h') {
            if (idx < NUM_QUESTIONS - 1) {
              const np = problems[idx + 1];
              nextId = np.carry.t === 1 ? `carry-t-${idx + 1}` : `ans-o-${idx + 1}`;
            }
          }
        }
      } else {
        // 矢印移動マップ
        const navMap = {
          [`ans-o-${idx}`]: { ArrowUp:`carry-t-${idx}`, ArrowRight:`ans-t-${idx}` },
          [`ans-t-${idx}`]: { ArrowUp:`carry-h-${idx}`, ArrowRight:`ans-h-${idx}`, ArrowLeft:`ans-o-${idx}` },
          [`ans-h-${idx}`]: { ArrowLeft:`ans-t-${idx}` },
          [`carry-t-${idx}`]: { ArrowDown:`ans-o-${idx}`, ArrowRight:`carry-h-${idx}` },
          [`carry-h-${idx}`]: { ArrowDown:`ans-t-${idx}`, ArrowLeft:`carry-t-${idx}` }
        };
        if (navMap[id] && navMap[id][e.key]) { e.preventDefault(); nextId = navMap[id][e.key]; }
      }
      if (nextId && document.getElementById(nextId) && document.getElementById(nextId).style.visibility !== 'hidden') {
        document.getElementById(nextId).focus();
      } else if (e.key === 'Enter' && !nextId) {
        checkBtn.focus();
      }
    }

    /////////////////////////////////////////////////
    //  採点処理
    /////////////////////////////////////////////////
    function checkAnswers() {
      incorrectFieldIds = [];
      currentProblemInView = -1;
      let allCorrect = true;
      problems.forEach((p, i) => {
        p.navState = {}; // ナビリセット
        const fields = [
          { id:`carry-t-${i}`, correct:p.carry.t },
          { id:`ans-o-${i}`, correct:p.answer.o },
          { id:`carry-h-${i}`, correct:p.carry.h },
          { id:`ans-t-${i}`, correct:p.answer.t },
          { id:`ans-h-${i}`, correct:p.answer.h }
        ];
        fields.forEach(f => {
          const el = document.getElementById(f.id);
          if (!el || el.style.visibility === 'hidden') return;
          const val = el.value.trim() === '' ? 0 : +el.value;
          el.classList.remove('incorrect-field','correct-field');
          if (val !== f.correct) {
            allCorrect = false; incorrectFieldIds.push(f.id); el.classList.add('incorrect-field'); el.disabled = false;
          } else {
            el.disabled = true; el.classList.add('correct-field');
          }
        });
      });

      // 結果表示
      const resultDiv = document.getElementById('result');
      if (allCorrect) {
        checkBtn.disabled = true; retryBtn.disabled = false; retryBtn.focus();
        const elapsed = ((Date.now() - startTime)/1000).toFixed(1);
        const baseScore = 100;
        const timeBonus = Math.max(0, Math.floor((TIME_LIMIT - elapsed) * 50 / TIME_LIMIT));
        const score = baseScore + timeBonus;
        let starsHtml = '―';
        if (score >= SCORE_STARS_THRESHOLD.star3) starsHtml = '★★★';
        else if (score >= SCORE_STARS_THRESHOLD.star2) starsHtml = '★★';
        else if (score >= SCORE_STARS_THRESHOLD.star1) starsHtml = '★';
        else if (score >= SCORE_STARS_THRESHOLD.circle) starsHtml = '○';
        resultDiv.style.color = '#33691e';
        resultDiv.innerHTML = `スコア: <strong>${score}点</strong><br>タイム: ${elapsed} 秒`;
        saveData(score, starsHtml); updateDisplay();
      } else {
        resultDiv.style.color = 'red';
        resultDiv.innerHTML = '❌ まちがいがあります。<br>赤いところを直そう！';
        // 間違い順を問題番号と列順で並べ替え
        const orderRank = { 'carry-t':0, 'ans-o':1, 'ans-t':2, 'carry-h':3, 'ans-h':4 };
        incorrectFieldIds.sort((a,b)=>{
          const ai = +a.split('-').pop(), bi = +b.split('-').pop();
          if (ai !== bi) return ai - bi;
          const atype = a.split('-').slice(0,2).join('-');
          const btype = b.split('-').slice(0,2).join('-');
          return orderRank[atype] - orderRank[btype];
        });
        if (incorrectFieldIds.length) document.getElementById(incorrectFieldIds[0]).focus();
      }
    }

    /////////////////////////////////////////////////
    //  リトライ
    /////////////////////////////////////////////////
    function retry() {
      incorrectFieldIds = []; currentProblemInView = -1;
      document.getElementById('result').textContent = '';
      checkBtn.disabled = false; retryBtn.disabled = true;
      startTime = Date.now();
      generateProblems(); displayProblems();
      // 最初の入力へフォーカス
      const first = problems[0];
      const firstId = first.carry.t === 1 ? 'carry-t-0':'ans-o-0';
      setTimeout(()=>{ const el=document.getElementById(firstId); if(el) el.focus(); },0);
    }

    /////////////////////////////////////////////////
    //  初期化
    /////////////////////////////////////////////////
    window.addEventListener('DOMContentLoaded', () => {
      retryBtn = document.getElementById('retry');
      const startBtn = document.getElementById('start-btn');
      startBtn.onclick = () => { startArea.style.display='none'; problemsSection.style.display='block'; resultArea.style.display='block'; retry(); };
      checkBtn.onclick = checkAnswers;
      retryBtn.onclick = retry; retryBtn.disabled = true;
      resetHighScoreBtn.onclick = () => {
        if (confirm('ハイスコアをリセットしますか？')) {
          highScore = 0; ls.removeItem(KEY_HS);
          overallStatusStars = '―'; ls.removeItem(KEY_OVERALL_STATUS);
          updateDisplay();
        }
      };
      loadData(); updateDisplay();
      startBtn.focus();
      // Enter キーで開始
      document.addEventListener('keydown', e => { if (e.key === 'Enter' && startArea.style.display !== 'none') { e.preventDefault(); startBtn.click(); } });
    });
  </script>
</body>
</html>