<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ひっ算（たし算）ドリル</title>
  <style>
    :root{
      /* 1マスの一辺(px) */
      --cell: 72px;
    }
    body{
      font-family:sans-serif;
      background:#eaf6ff;
      margin:0;
      padding:20px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:18px;
    }
    h1{margin:0;font-size:2.1rem;}

    /* ===== セル ===== */
    table{border-collapse:collapse;}
    td{
      width:var(--cell);
      height:var(--cell);
      border:1px solid #8ebde6;
      text-align:center;
      vertical-align:middle;
      font-size:2.1rem;
      user-select:none;
    }
    /* 入力欄 */
    input[type="text"]{
      width:100%;
      height:100%;
      font-size:2.1rem;
      text-align:center;
      border:none;
      outline:none;
      background:transparent;
    }
    /* キャリー段は小さめ */
    .carry-row td{font-size:1.4rem;}
    /* 答え欄の上ライン */
    #answer-table{border-top:4px solid #444;}

    button{
      font-size:1rem;
      padding:6px 18px;
      margin:0 8px;
      cursor:pointer;
    }
    #message{font-size:1.1rem;height:1.4rem;}
  </style>
</head>
<body>
  <h1>ひっ算（たし算）ドリル</h1>
  <div id="tables-wrapper"></div>
  <div>
    <button id="checkBtn">採点</button>
    <button id="nextBtn">次の問題</button>
  </div>
  <p id="message"></p>

<script>
(function(){
  const wrapper=document.getElementById('tables-wrapper');
  const msg=document.getElementById('message');
  const checkBtn=document.getElementById('checkBtn');
  const nextBtn=document.getElementById('nextBtn');
  let problem;

  // ---- Utility ----
  const rand=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;

  // 3桁配列
  const toDigitsArr3=(n)=>[...n.toString().padStart(3,' ')];

  /**
   * 繰り上がりを日本の教科書スタイルで取得
   * 例: 190+312 => carries=[1,0,0] (左から[百,十,一]の位置)
   */
  function getCarriesJP(a,b){
    const da=toDigitsArr3(a).map(d=>d===' '?0:+d);
    const db=toDigitsArr3(b).map(d=>d===' '?0:+d);
    const cArr=[0,0,0];          // 表示用: [百,十,一]
    let carry=0;
    for(let i=2;i>=0;i--){       // 右→左
      const sum=da[i]+db[i]+carry;
      if(sum>=10){
        if(i-1>=0) cArr[i-1]=1;  // 繰り上がりは左隣の桁へ書く
        carry=1;
      }else{
        carry=0;
      }
    }
    return cArr;
  }

  // ==== 生成 ====
  function render(){
    wrapper.innerHTML="";
    msg.textContent="";

    // 3桁＋3桁 (合計は3桁以内)
    let a,b;
    do{
      a=rand(100,999);
      b=rand(100,999);
    }while(a+b>=1000);

    const arrA=toDigitsArr3(a);
    const arrB=toDigitsArr3(b);
    const carries=getCarriesJP(a,b);
    const answerArr=toDigitsArr3(a+b);

    // ------ 問題表 ------
    const probTable=document.createElement('table');
    const carryTR=document.createElement('tr');carryTR.className='carry-row';
    const num1TR=document.createElement('tr');
    const num2TR=document.createElement('tr');

    // 列: [+専用] + [百][十][一]
    const blankTD=()=>document.createElement('td');
    carryTR.appendChild(blankTD());          // 左端(＋列)は空白
    num1TR.appendChild(blankTD());
    const plusTD=document.createElement('td');plusTD.textContent='+';num2TR.appendChild(plusTD);

    // 3桁ループ
    for(let i=0;i<3;i++){
      // carry row
      const ctd=document.createElement('td');
      const cInp=document.createElement('input');cInp.type='text';cInp.maxLength=1;ctd.appendChild(cInp);
      carryTR.appendChild(ctd);
      // 数字1
      const n1td=document.createElement('td');n1td.textContent=arrA[i];num1TR.appendChild(n1td);
      // 数字2
      const n2td=document.createElement('td');n2td.textContent=arrB[i];num2TR.appendChild(n2td);
    }
    probTable.appendChild(carryTR);
    probTable.appendChild(num1TR);
    probTable.appendChild(num2TR);

    // ------ 答え表 ------
    const answerTable=document.createElement('table');answerTable.id='answer-table';
    const ansTR=document.createElement('tr');
    ansTR.appendChild(blankTD());
    for(let i=0;i<3;i++){
      const td=document.createElement('td');
      const inp=document.createElement('input');inp.type='text';inp.maxLength=1;td.appendChild(inp);ansTR.appendChild(td);
    }
    answerTable.appendChild(ansTR);

    wrapper.appendChild(probTable);
    wrapper.appendChild(answerTable);

    problem={carries,answerArr};
  }

  // ---- 採点 ----
  function grade(){
    const [probTable,answerTable]=wrapper.querySelectorAll('table');
    const carryInputs=[...probTable.querySelectorAll('.carry-row input')];
    const ansInputs=[...answerTable.querySelectorAll('input')];
    let ok=true;
    // carry
    problem.carries.forEach((c,i)=>{
      const v=carryInputs[i].value.trim();
      const correct=c?"1":"";
      if(v===correct){carryInputs[i].style.background='#ccffd6';}
      else{carryInputs[i].style.background='#ffcccc';ok=false;}
    });
    // answer
    problem.answerArr.forEach((d,i)=>{
      const correct=d===' '?'':d;
      const v=ansInputs[i].value.trim();
      if(v===correct){ansInputs[i].style.background='#ccffd6';}
      else{ansInputs[i].style.background='#ffcccc';ok=false;}
    });
    msg.textContent=ok?'正解！おめでとう！':'間違いがあります。もう一度確認しよう。';
  }

  checkBtn.onclick=grade;
  nextBtn.onclick=render;
  render();
})();
</script>
</body>
</html>
