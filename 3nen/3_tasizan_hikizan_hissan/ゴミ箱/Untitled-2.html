<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>たし算の筆算ドリル</title>
  <style>
    :root {
      --cell-size: 70px; /* マスの基本サイズ */
    }
    body {
      font-family: 'HiraMaruProN-W4', 'ヒラギノ丸ゴ ProN W4', 'メイリオ', Meiryo, sans-serif;
      background: #e3f2fd;
      margin: 20px;
      color: #333;
      font-size: 1.8rem;
      line-height: 1.6;
    }
    h1, h2 {
      text-align: center;
      margin: 15px 0;
      color: #1e88e5;
      text-shadow: 2px 2px 3px rgba(0,0,0,0.1);
      white-space: nowrap;
    }
    h1 { font-size: 3.5rem; }
    h2 { font-size: 2.5rem; margin-bottom: 30px; }

    #problems-wrapper {
      max-width: 450px;
      margin: 0 auto 30px;
      padding: 20px;
      border: 4px dashed #90caf9;
      background: #ffffff;
      box-shadow: 5px 5px 10px rgba(0,0,0,.15);
      border-radius: 20px;
    }
    .hissan-problem {
      margin: 40px auto;
      font-family: "Kyokasho", "教科書体", serif;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      gap: 15px;
    }
    .problem-number {
      font-size: 2.5rem;
      color: #0d47a1;
      font-weight: bold;
      font-family: sans-serif;
      padding-top: calc(var(--cell-size) * 0.7);
    }

    table {
      border-collapse: collapse;
    }
    td {
      width: var(--cell-size);
      height: var(--cell-size);
      text-align: center;
      vertical-align: middle;
      font-size: 3rem;
      padding: 0;
    }
    .prob-table td, .answer-table td {
      border: none;
    }
    .carry-row td {
      height: calc(var(--cell-size) * 0.7);
    }
    .answer-table {
      border-top: 3px solid #333;
    }
    .sign-col {
      width: calc(var(--cell-size) * 0.6);
    }

    input {
      width: 100%;
      height: 100%;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: transparent;
      text-align: center;
      box-sizing: border-box;
      font-family: inherit;
    }
    input.answer-input {
        border: 2px solid #64b5f6;
    }
    input[type="number"] {
      font-size: 3rem;
    }
    .carry-input {
      font-size: 2rem;
      color: #d32f2f;
      border: 1px solid #ddd;
    }

    /* ★変更点: 正解・不正解・無効のスタイルをクラスで管理 */
    .correct-field {
      background-color: #e8fde3 !important;
      border-color: #a5d6a7 !important;
    }
    .incorrect-field {
      background-color: #ffdddd !important;
    }
    input:disabled {
      color: #333; /* 文字が薄くならないように */
    }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }

    .button-area, #result-area { text-align: center; }
    button { font-size: 2.5rem; margin: 0 15px; padding: 15px 30px; background: #42a5f5; color: white; border: none; border-radius: 15px; cursor: pointer; }
    button:disabled { background: #ccc; cursor: default; }
    #result { font-size: 2.8rem; font-weight: bold; margin: 15px 0; }
  </style>
</head>
<body>
  <h1>３　たし算とひき算の筆算</h1>
  <h2>たし算の筆算</h2>

  <div id="problems-section">
    <div id="problems-wrapper"></div>
    <div class="button-area">
      <button id="check-answers">まるつけ</button>
    </div>
  </div>

  <div id="result-area">
    <div id="result"></div>
  </div>

  <script>
    const NUM_QUESTIONS = 5;
    let problems = [];
    let incorrectFieldIds = []; 

    function toDigits(num, len) {
      return num.toString().padStart(len, '0').split('').map(Number);
    }

    function generateProblems() {
      let generated = 0;
      const usedPairs = new Set();
      problems = [];

      while (generated < NUM_QUESTIONS) {
        const a = Math.floor(Math.random() * 900) + 100;
        const b = (Math.random() < 0.5)
            ? Math.floor(Math.random() * 90) + 10
            : Math.floor(Math.random() * 900) + 100;

        const sum = a + b;
        if (sum >= 1000) continue;

        const [ah, at, ao] = toDigits(a, 3);
        const [bh, bt, bo] = toDigits(b, 3);

        const carry_t = (ao + bo >= 10) ? 1 : 0;
        const carry_h = (at + bt + carry_t >= 10) ? 1 : 0;
        
        const pairKey = `${a}-${b}`;
        if (usedPairs.has(pairKey)) continue;

        const [ansh, anst, anso] = toDigits(sum, 3);

        problems.push({
          numA:   { h: ah, t: at, o: ao },
          numB:   { h: bh, t: bt, o: bo },
          carry:  { h: carry_h, t: carry_t },
          answer: { h: ansh, t: anst, o: anso }
        });
        usedPairs.add(pairKey);
        generated++;
      }
    }

    function displayProblems() {
        const wrapper = document.getElementById('problems-wrapper');
        wrapper.innerHTML = '';

        problems.forEach((p, i) => {
            const problemContainer = document.createElement('div');
            problemContainer.className = 'hissan-problem';
            
            const numB_h_display = p.numB.h > 0 ? p.numB.h : '';

            problemContainer.innerHTML = `
              <div class="problem-number">${i + 1}.</div>
              <div class="calculator-container">
                <table class="prob-table">
                  <tr class="carry-row">
                    <td class="sign-col"></td>
                    <td><input type="number" class="carry-input" id="carry-h-${i}" maxlength="1"></td>
                    <td><input type="number" class="carry-input" id="carry-t-${i}" maxlength="1"></td>
                    <td></td>
                  </tr>
                  <tr>
                    <td class="sign-col"></td>
                    <td>${p.numA.h}</td>
                    <td>${p.numA.t}</td>
                    <td>${p.numA.o}</td>
                  </tr>
                  <tr>
                    <td class="sign-col">+</td>
                    <td>${numB_h_display}</td>
                    <td>${p.numB.t}</td>
                    <td>${p.numB.o}</td>
                  </tr>
                </table>
                <table class="answer-table">
                  <tr>
                    <td class="sign-col"></td>
                    <td><input type="number" class="answer-input" id="ans-h-${i}" maxlength="1"></td>
                    <td><input type="number" class="answer-input" id="ans-t-${i}" maxlength="1"></td>
                    <td><input type="number" class="answer-input" id="ans-o-${i}" maxlength="1"></td>
                  </tr>
                </table>
              </div>
            `;
            wrapper.appendChild(problemContainer);

            const navOrder = [
                `ans-o-${i}`, `carry-t-${i}`, `ans-t-${i}`, `carry-h-${i}`, `ans-h-${i}`
            ];

            // ★変更点: Enterキーの移動ロジックを改善
            navOrder.forEach((id, index) => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            let nextId = null;
                            
                            if (incorrectFieldIds.length > 0) { // 間違い修正モード
                               const currentIncorrectIndex = incorrectFieldIds.indexOf(id);
                               if (currentIncorrectIndex > -1 && currentIncorrectIndex < incorrectFieldIds.length - 1) {
                                   nextId = incorrectFieldIds[currentIncorrectIndex + 1];
                               }
                            } else { // 通常モード
                               if (index < navOrder.length - 1) {
                                   nextId = navOrder[index + 1];
                               } else if (i < NUM_QUESTIONS - 1) {
                                   // 次の問題の最初の入力欄へ
                                   nextId = `ans-o-${i + 1}`;
                               }
                            }

                            if (nextId && document.getElementById(nextId)) {
                                document.getElementById(nextId).focus();
                            } else {
                                document.getElementById('check-answers').focus();
                            }
                        }
                    });
                }
            });
        });
    }

    function checkAnswers() {
        incorrectFieldIds = []; 
        let allCorrect = true;

        problems.forEach((p, i) => {
            const fields = [
                { id: `carry-h-${i}`, correct: p.carry.h },
                { id: `carry-t-${i}`, correct: p.carry.t },
                { id: `ans-h-${i}`, correct: p.answer.h },
                { id: `ans-t-${i}`, correct: p.answer.t },
                { id: `ans-o-${i}`, correct: p.answer.o }
            ];

            fields.forEach(field => {
                const el = document.getElementById(field.id);
                if (!el) return;
                
                const userValue = el.value.trim() === '' ? 0 : +el.value;
                el.classList.remove('incorrect-field', 'correct-field');

                if (userValue !== field.correct) {
                    allCorrect = false;
                    incorrectFieldIds.push(field.id);
                    el.classList.add('incorrect-field');
                    el.disabled = false;
                } else {
                    el.disabled = true;
                    el.classList.add('correct-field'); // ★変更点: 正解クラスを追加
                }
            });
        });
        
        const resultDiv = document.getElementById('result');
        if (allCorrect) {
            resultDiv.textContent = '🎉 全問正解です！おめでとう！';
            resultDiv.style.color = 'green';
            document.getElementById('check-answers').disabled = true;
        } else {
            resultDiv.textContent = '❌ まちがいがあります。赤いところを直そう！';
            resultDiv.style.color = 'red';
            if (incorrectFieldIds.length > 0) {
                const firstErrorEl = document.getElementById(incorrectFieldIds[0]);
                firstErrorEl.focus();
                firstErrorEl.select();
            }
        }
    }

    window.addEventListener('DOMContentLoaded', () => {
        generateProblems();
        displayProblems();
        document.getElementById('check-answers').onclick = checkAnswers;
    });
  </script>
</body>
</html><!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>たし算の筆算ドリル</title>
  <style>
    :root {
      --cell-size: 70px; /* マスの基本サイズ */
    }
    body {
      font-family: 'HiraMaruProN-W4', 'ヒラギノ丸ゴ ProN W4', 'メイリオ', Meiryo, sans-serif;
      background: #e3f2fd;
      margin: 20px;
      color: #333;
      font-size: 1.8rem;
      line-height: 1.6;
    }
    h1, h2 {
      text-align: center;
      margin: 15px 0;
      color: #1e88e5;
      text-shadow: 2px 2px 3px rgba(0,0,0,0.1);
      white-space: nowrap;
    }
    h1 { font-size: 3.5rem; }
    h2 { font-size: 2.5rem; margin-bottom: 30px; }

    #problems-wrapper {
      max-width: 450px;
      margin: 0 auto 30px;
      padding: 20px;
      border: 4px dashed #90caf9;
      background: #ffffff;
      box-shadow: 5px 5px 10px rgba(0,0,0,.15);
      border-radius: 20px;
    }
    .hissan-problem {
      margin: 40px auto;
      font-family: "Kyokasho", "教科書体", serif;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      gap: 15px;
    }
    .problem-number {
      font-size: 2.5rem;
      color: #0d47a1;
      font-weight: bold;
      font-family: sans-serif;
      padding-top: calc(var(--cell-size) * 0.7);
    }

    table {
      border-collapse: collapse;
    }
    td {
      width: var(--cell-size);
      height: var(--cell-size);
      text-align: center;
      vertical-align: middle;
      font-size: 3rem;
      padding: 0;
    }
    .prob-table td, .answer-table td {
      border: none;
    }
    .carry-row td {
      height: calc(var(--cell-size) * 0.7);
    }
    .answer-table {
      border-top: 3px solid #333;
    }
    .sign-col {
      width: calc(var(--cell-size) * 0.6);
    }

    input {
      width: 100%;
      height: 100%;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: transparent;
      text-align: center;
      box-sizing: border-box;
      font-family: inherit;
    }
    input.answer-input {
        border: 2px solid #64b5f6;
    }
    input[type="number"] {
      font-size: 3rem;
    }
    .carry-input {
      font-size: 2rem;
      color: #d32f2f;
      border: 1px solid #ddd;
    }

    /* ★変更点: 正解・不正解・無効のスタイルをクラスで管理 */
    .correct-field {
      background-color: #e8fde3 !important;
      border-color: #a5d6a7 !important;
    }
    .incorrect-field {
      background-color: #ffdddd !important;
    }
    input:disabled {
      color: #333; /* 文字が薄くならないように */
    }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }

    .button-area, #result-area { text-align: center; }
    button { font-size: 2.5rem; margin: 0 15px; padding: 15px 30px; background: #42a5f5; color: white; border: none; border-radius: 15px; cursor: pointer; }
    button:disabled { background: #ccc; cursor: default; }
    #result { font-size: 2.8rem; font-weight: bold; margin: 15px 0; }
  </style>
</head>
<body>
  <h1>３　たし算とひき算の筆算</h1>
  <h2>たし算の筆算</h2>

  <div id="problems-section">
    <div id="problems-wrapper"></div>
    <div class="button-area">
      <button id="check-answers">まるつけ</button>
    </div>
  </div>

  <div id="result-area">
    <div id="result"></div>
  </div>

  <script>
    const NUM_QUESTIONS = 5;
    let problems = [];
    let incorrectFieldIds = []; 

    function toDigits(num, len) {
      return num.toString().padStart(len, '0').split('').map(Number);
    }

    function generateProblems() {
      let generated = 0;
      const usedPairs = new Set();
      problems = [];

      while (generated < NUM_QUESTIONS) {
        const a = Math.floor(Math.random() * 900) + 100;
        const b = (Math.random() < 0.5)
            ? Math.floor(Math.random() * 90) + 10
            : Math.floor(Math.random() * 900) + 100;

        const sum = a + b;
        if (sum >= 1000) continue;

        const [ah, at, ao] = toDigits(a, 3);
        const [bh, bt, bo] = toDigits(b, 3);

        const carry_t = (ao + bo >= 10) ? 1 : 0;
        const carry_h = (at + bt + carry_t >= 10) ? 1 : 0;
        
        const pairKey = `${a}-${b}`;
        if (usedPairs.has(pairKey)) continue;

        const [ansh, anst, anso] = toDigits(sum, 3);

        problems.push({
          numA:   { h: ah, t: at, o: ao },
          numB:   { h: bh, t: bt, o: bo },
          carry:  { h: carry_h, t: carry_t },
          answer: { h: ansh, t: anst, o: anso }
        });
        usedPairs.add(pairKey);
        generated++;
      }
    }

    function displayProblems() {
        const wrapper = document.getElementById('problems-wrapper');
        wrapper.innerHTML = '';

        problems.forEach((p, i) => {
            const problemContainer = document.createElement('div');
            problemContainer.className = 'hissan-problem';
            
            const numB_h_display = p.numB.h > 0 ? p.numB.h : '';

            problemContainer.innerHTML = `
              <div class="problem-number">${i + 1}.</div>
              <div class="calculator-container">
                <table class="prob-table">
                  <tr class="carry-row">
                    <td class="sign-col"></td>
                    <td><input type="number" class="carry-input" id="carry-h-${i}" maxlength="1"></td>
                    <td><input type="number" class="carry-input" id="carry-t-${i}" maxlength="1"></td>
                    <td></td>
                  </tr>
                  <tr>
                    <td class="sign-col"></td>
                    <td>${p.numA.h}</td>
                    <td>${p.numA.t}</td>
                    <td>${p.numA.o}</td>
                  </tr>
                  <tr>
                    <td class="sign-col">+</td>
                    <td>${numB_h_display}</td>
                    <td>${p.numB.t}</td>
                    <td>${p.numB.o}</td>
                  </tr>
                </table>
                <table class="answer-table">
                  <tr>
                    <td class="sign-col"></td>
                    <td><input type="number" class="answer-input" id="ans-h-${i}" maxlength="1"></td>
                    <td><input type="number" class="answer-input" id="ans-t-${i}" maxlength="1"></td>
                    <td><input type="number" class="answer-input" id="ans-o-${i}" maxlength="1"></td>
                  </tr>
                </table>
              </div>
            `;
            wrapper.appendChild(problemContainer);

            const navOrder = [
                `ans-o-${i}`, `carry-t-${i}`, `ans-t-${i}`, `carry-h-${i}`, `ans-h-${i}`
            ];

            // ★変更点: Enterキーの移動ロジックを改善
            navOrder.forEach((id, index) => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            let nextId = null;
                            
                            if (incorrectFieldIds.length > 0) { // 間違い修正モード
                               const currentIncorrectIndex = incorrectFieldIds.indexOf(id);
                               if (currentIncorrectIndex > -1 && currentIncorrectIndex < incorrectFieldIds.length - 1) {
                                   nextId = incorrectFieldIds[currentIncorrectIndex + 1];
                               }
                            } else { // 通常モード
                               if (index < navOrder.length - 1) {
                                   nextId = navOrder[index + 1];
                               } else if (i < NUM_QUESTIONS - 1) {
                                   // 次の問題の最初の入力欄へ
                                   nextId = `ans-o-${i + 1}`;
                               }
                            }

                            if (nextId && document.getElementById(nextId)) {
                                document.getElementById(nextId).focus();
                            } else {
                                document.getElementById('check-answers').focus();
                            }
                        }
                    });
                }
            });
        });
    }

    function checkAnswers() {
        incorrectFieldIds = []; 
        let allCorrect = true;

        problems.forEach((p, i) => {
            const fields = [
                { id: `carry-h-${i}`, correct: p.carry.h },
                { id: `carry-t-${i}`, correct: p.carry.t },
                { id: `ans-h-${i}`, correct: p.answer.h },
                { id: `ans-t-${i}`, correct: p.answer.t },
                { id: `ans-o-${i}`, correct: p.answer.o }
            ];

            fields.forEach(field => {
                const el = document.getElementById(field.id);
                if (!el) return;
                
                const userValue = el.value.trim() === '' ? 0 : +el.value;
                el.classList.remove('incorrect-field', 'correct-field');

                if (userValue !== field.correct) {
                    allCorrect = false;
                    incorrectFieldIds.push(field.id);
                    el.classList.add('incorrect-field');
                    el.disabled = false;
                } else {
                    el.disabled = true;
                    el.classList.add('correct-field'); // ★変更点: 正解クラスを追加
                }
            });
        });
        
        const resultDiv = document.getElementById('result');
        if (allCorrect) {
            resultDiv.textContent = '🎉 全問正解です！おめでとう！';
            resultDiv.style.color = 'green';
            document.getElementById('check-answers').disabled = true;
        } else {
            resultDiv.textContent = '❌ まちがいがあります。赤いところを直そう！';
            resultDiv.style.color = 'red';
            if (incorrectFieldIds.length > 0) {
                const firstErrorEl = document.getElementById(incorrectFieldIds[0]);
                firstErrorEl.focus();
                firstErrorEl.select();
            }
        }
    }

    window.addEventListener('DOMContentLoaded', () => {
        generateProblems();
        displayProblems();
        document.getElementById('check-answers').onclick = checkAnswers;
    });
  </script>
</body>
</html>