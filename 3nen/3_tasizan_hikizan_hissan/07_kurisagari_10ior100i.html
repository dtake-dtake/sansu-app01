<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ひき算の筆算（くりさがり1回）</title>
  <style>
    :root { --cell-size: 70px; }
    html { scroll-behavior: smooth; }
    body { font-family: 'HiraMaruProN-W4', 'ヒラギノ丸ゴ ProN W4', 'メイリオ', Meiryo, sans-serif; background: #e0f2f1; margin: 20px; color: #333; font-size: 1.8rem; line-height: 1.6; }
    h1, h2 { text-align: center; margin: 15px 0; color: #00897b; text-shadow: 2px 2px 3px rgba(0,0,0,0.1); white-space: nowrap; }
    h1 { font-size: 3.5rem; }
    h2 { font-size: 2.5rem; margin-bottom: 30px; }
    #problems-wrapper { max-width: 550px; margin: 0 auto 30px; padding: 20px; border: 4px dashed #80cbc4; background: #ffffff; box-shadow: 5px 5px 10px rgba(0,0,0,15); border-radius: 20px; }

    /* 筆算表。右→左の並びで見せるため rtl にしている */
    .hissan-table { border-collapse: collapse; margin: 40px auto; font-family: "Kyokasho", "教科書体", serif; direction: rtl; }
    .hissan-table td { width: var(--cell-size); height: var(--cell-size); text-align: center; vertical-align: middle; font-size: 3rem; padding: 0; border: none; direction: ltr; position: relative; }
    .problem-number-cell { font-size: 2.5rem; color: #004d40; font-weight: bold; font-family: sans-serif; width: auto; padding-right: 15px; }
    .borrow-row td { height: calc(var(--cell-size) * 0.7); }
    .answer-row td:not(.problem-number-cell) { border-top: 3px solid #333; }
    .sign-col { width: calc(var(--cell-size) * 0.6); }

    input { width: 100%; height: 100%; border: 1px solid #ccc; border-radius: 8px; background: transparent; text-align: center; box-sizing: border-box; font-family: inherit; }
    .answer-input { border: 2px solid #b2dfdb; font-size: 3rem; }
    .borrow-input { font-size: 2rem; color: #d32f2f; border: 1px solid #ddd; }
    .correct-field { background-color: #e8fde3 !important; border-color: #a5d6a7 !important; }
    .incorrect-field { background-color: #ffdddd !important; }
    input:disabled { color: #333; }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    .strikethrough { position: relative; color: #aaa; }
    .strikethrough::after {
      content: '＼'; position: absolute; color: #d32f2f; font-weight: bold;
      top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 3.5rem;
    }

    .button-area, #result-area { text-align: center; }
    .button-area { margin-bottom: 30px; }
    button { font-size: 2.5rem; margin: 0 15px; padding: 15px 30px; background: #009688; color: white; border: none; border-radius: 15px; cursor: pointer; }
    button:disabled { background: #ccc; cursor: default; }

    #result-area { margin-bottom: 25px; background: #e0f2f1; padding: 20px; border-radius: 15px; border: 2px solid #b2dfdb; }
    #result { font-size: 2.8rem; font-weight: bold; margin: 15px 0; min-height: 3rem; }
    #highScoreArea, #clearCountArea, #monthlyCountArea, #dailyCountArea, #overallStatusArea { font-size: 2.2rem; margin: 8px 0; }
    #highScoreValue, #clearCountValue, #monthlyCountValue, #dailyCountValue, #overallStars { font-weight: bold; margin: 0 12px; color: #2e7d32; }
    #reset-highscore { font-size: 1.8rem; margin-left: 15px; padding: 8px 18px; background: #ef5350; }
    #history-area { font-size: 1.8rem; margin-top: 20px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto; }
    #history-list { list-style: none; padding: 0; margin: 0; }

    /* number input のスピンボタンを非表示 */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
    }
    input[type="number"] {
    -moz-appearance: textfield; /* Firefox */
    }
  </style>
</head>
<body>
  <h1>３　たし算とひき算の筆算</h1>
  <h2>ひき算の筆算（くりさがり1回）</h2>

  <div id="start-area" style="text-align:center; margin:40px 0;"><button id="start-btn">スタート！</button></div>

  <div id="problems-section" style="display:none;">
    <div id="problems-wrapper"></div>
    <div class="button-area">
      <button id="check-answers">まるつけ</button>
      <button id="retry">もういちど</button>
    </div>
  </div>

  <div id="result-area">
    <div id="result"></div>
    <div id="highScoreArea">ハイスコア：<span id="highScoreValue">0</span> てん <button id="reset-highscore">リセット</button></div>
    <div id="dailyCountArea">今日のクリア：<span id="dailyCountValue">0</span> かい</div>
    <div id="monthlyCountArea">今月のクリア：<span id="monthlyCountValue">0</span> かい</div>
    <div id="clearCountArea">合計クリア：<span id="clearCountValue">0</span> かい</div>
    <div id="overallStatusArea">ステータス：<span id="overallStars">―</span></div>
    <div id="history-area">りれき（１０件）<br><ul id="history-list"></ul></div>
  </div>

  <script>
    const APP_NS = "hissan-hikizan-kurisagari1-final-v8_"; // バージョンを更新
    const NUM_QUESTIONS = 5;
    const TIME_LIMIT = NUM_QUESTIONS * 30;

    const startArea = document.getElementById('start-area'),
          problemsSection = document.getElementById('problems-section'),
          resultArea = document.getElementById('result-area'),
          checkBtn = document.getElementById('check-answers'),
          resetHighScoreBtn = document.getElementById('reset-highscore');
    let retryBtn;

    const KEY_HS = APP_NS + "highScore",
          KEY_HISTORY = APP_NS + "history",
          KEY_CLEAR = APP_NS + "clearCount",
          KEY_MONTHLY_PREFIX = APP_NS + "monthlyClear-",
          KEY_DAILY_PREFIX = APP_NS + "dailyClear-",
          KEY_OVERALL_STATUS = APP_NS + "overallStatus";

    const SCORE_STARS_THRESHOLD = { star_circle: 100, star1: 101, star2: 121, star3: 141 };

    let problems = [], incorrectFieldIds = [], startTime = 0, highScore = 0;
    let totalClearCount = 0, monthlyCount = 0, dailyCount = 0, overallStatusStars = '―';
    let currentProblemInView = -1;

    const scrollCenter = el => el.scrollIntoView({ behavior: "smooth", block: "center" });
    const toDigits = (num, len) => num.toString().padStart(len, '0').split('').map(Number);
    const nowDT = () => new Date().toLocaleString();
    const ls = localStorage;

    function loadData() {
      highScore = +ls.getItem(KEY_HS) || 0;
      const todayKey = KEY_DAILY_PREFIX + new Date().toISOString().slice(0, 10);
      const monthKey = KEY_MONTHLY_PREFIX + new Date().toISOString().slice(0, 7);
      totalClearCount = +ls.getItem(KEY_CLEAR) || 0;
      monthlyCount = +ls.getItem(monthKey) || 0;
      dailyCount = +ls.getItem(todayKey) || 0;
      overallStatusStars = ls.getItem(KEY_OVERALL_STATUS) || '―';
    }
    function saveData(score, starsHtml) {
      if (score > highScore) { highScore = score; ls.setItem(KEY_HS, highScore); }
      const todayKey = KEY_DAILY_PREFIX + new Date().toISOString().slice(0, 10);
      const monthKey = KEY_MONTHLY_PREFIX + new Date().toISOString().slice(0, 7);
      ls.setItem(KEY_CLEAR, ++totalClearCount);
      ls.setItem(monthKey, ++monthlyCount);
      ls.setItem(todayKey, ++dailyCount);
      overallStatusStars = starsHtml; ls.setItem(KEY_OVERALL_STATUS, starsHtml);

      const history = JSON.parse(ls.getItem(KEY_HISTORY) || '[]');
      history.unshift({ datetime: nowDT(), score });
      if (history.length > 10) history.pop();
      ls.setItem(KEY_HISTORY, JSON.stringify(history));
    }
    function resetHighScore() {
      if (confirm('ハイスコアをリセットしますか？')) {
        highScore = 0; ls.removeItem(KEY_HS);
        overallStatusStars = '―'; ls.removeItem(KEY_OVERALL_STATUS);
        updateDisplay();
      }
    }
    function updateDisplay() {
      document.getElementById('highScoreValue').textContent = highScore;
      document.getElementById('dailyCountValue').textContent = dailyCount;
      document.getElementById('monthlyCountValue').textContent = monthlyCount;
      document.getElementById('clearCountValue').textContent = totalClearCount;
      document.getElementById('overallStars').innerHTML = overallStatusStars;
      const history = JSON.parse(ls.getItem(KEY_HISTORY) || '[]');
      document.getElementById('history-list').innerHTML = history.map(item => `<li>${item.datetime}：${item.score}てん</li>`).join('');
    }

    function findProblem(condition, usedPairs) {
      let attempts = 0;
      while (attempts < 1000) {
        const problem = condition(usedPairs);
        if (problem) return problem;
        attempts++;
      }
      console.warn("A specific problem type could not be generated, using fallback.");
      return { a: 324, b: 182 };
    }

    function generateProblems() {
      problems = [];
      const usedPairs = new Set();

      // [変更点] 各条件の中に「ひかれる数の十の位が0でない」というチェックを追加
      const conditions = [
        // 1) くり下がり：百の位のみ
        (pairs) => {
          const a = Math.floor(Math.random() * 900) + 100;
          const b = Math.floor(Math.random() * 900) + 100;
          if (a <= b) return null;
          const [ah, at, ao] = toDigits(a, 3), [bh, bt, bo] = toDigits(b, 3);
          if (at === 0) return null; // 十の位が0なら除外
          const borrow_t = (ao < bo) ? 1 : 0, borrow_h = ((at - borrow_t) < bt) ? 1 : 0;
          if (borrow_t === 0 && borrow_h === 1) { const key = `${a}-${b}`; if (!pairs.has(key)) { pairs.add(key); return { a, b }; } }
          return null;
        },
        // 2) くり下がり：十の位のみ
        (pairs) => {
          const a = Math.floor(Math.random() * 900) + 100;
          const b = Math.floor(Math.random() * 900) + 100;
          if (a <= b) return null;
          const [ah, at, ao] = toDigits(a, 3), [bh, bt, bo] = toDigits(b, 3);
          if (at === 0) return null; // 十の位が0なら除外
          const borrow_t = (ao < bo) ? 1 : 0, borrow_h = ((at - borrow_t) < bt) ? 1 : 0;
          if (borrow_t === 1 && borrow_h === 0) { const key = `${a}-${b}`; if (!pairs.has(key)) { pairs.add(key); return { a, b }; } }
          return null;
        },
        // 3) B に 0 を含む・くり下がりは1回
        (pairs) => {
          const a = Math.floor(Math.random() * 900) + 100;
          const b = Math.floor(Math.random() * 900) + 100;
          if (a <= b || !b.toString().includes('0')) return null;
          const [ah, at, ao] = toDigits(a, 3), [bh, bt, bo] = toDigits(b, 3);
          if (at === 0) return null; // 十の位が0なら除外
          const borrow_t = (ao < bo) ? 1 : 0, borrow_h = ((at - borrow_t) < bt) ? 1 : 0;
          if (borrow_t + borrow_h === 1) { const key = `${a}-${b}`; if (!pairs.has(key)) { pairs.add(key); return { a, b }; } }
          return null;
        },
        // 4) A 三桁・B 二桁（1回だけくり下がり）
        (pairs) => {
          const a = Math.floor(Math.random() * 900) + 100;
          const b = Math.floor(Math.random() * 90) + 10;
          if (a <= b) return null;
          const [ah, at, ao] = toDigits(a, 3);
          if (at === 0) return null; // 十の位が0なら除外
          const [bh, bt, bo] = toDigits(b, 3);
          const borrow_t = (ao < bo) ? 1 : 0, borrow_h = ((at - borrow_t) < bt) ? 1 : 0;
          if (borrow_t + borrow_h === 1) { const key = `${a}-${b}`; if (!pairs.has(key)) { pairs.add(key); return { a, b }; } }
          return null;
        }
      ];

      // 1・2問目はタイプ1を確定、それ以降は順に種類を混ぜる
      problems.push(findProblem(conditions[0], usedPairs));
      problems.push(findProblem(conditions[0], usedPairs));
      for (let i = 2; i < conditions.length; i++) {
        problems.push(findProblem(conditions[i], usedPairs));
      }

      if (problems.some(p => p === null)) { console.error("Failed to generate all problems, retrying..."); generateProblems(); return; }

      problems = problems.map(({ a, b }) => {
        const [ah, at, ao] = toDigits(a, 3);
        const [bh, bt, bo] = toDigits(b, 3);
        const borrow_t = (ao < bo) ? 1 : 0;
        const borrow_h = ((at - borrow_t) < bt) ? 1 : 0;

        const result = a - b;
        const [ansh, anst, anso] = toDigits(result, 3);
        let H = ansh, T = anst, O = anso;
        if (result < 100) H = null;
        if (result < 10)  T = null;

        return {
          numA: { h: ah, t: at, o: ao },
          numB: { h: bh, t: bt, o: bo },
          borrow: { h: borrow_h, t: borrow_t },
            borrowed: {
                h: ah - borrow_h,
            t: at + (borrow_h ? 10 : 0) - borrow_t,
            o: ao
},
          answer: { h: H, t: T, o: O }
        };
      });
    }

    function displayProblems() {
      const wrapper = document.getElementById('problems-wrapper');
      wrapper.innerHTML = '';
      problems.forEach((p, i) => {
        const table = document.createElement('table');
        table.className = 'hissan-table';
        table.id = `problem-table-${i}`;

        const numB_h_display = p.numB.h > 0 ? p.numB.h : '';
        const numB_t_display = (p.numB.h > 0 || p.numB.t > 0) ? p.numB.t : '';

        table.innerHTML = `
          <tr class="borrow-row">
            <td><input type="number" class="borrow-input" id="borrow-o-${i}" maxlength="2"></td>
            <td><input type="number" class="borrow-input" id="borrow-t-${i}" maxlength="1"></td>
            <td><input type="number" class="borrow-input" id="borrow-h-${i}" maxlength="1"></td>
            <td class="sign-col"></td><td class="problem-number-cell"></td>
          </tr>
          <tr>
            <td><span id="numA-o-${i}">${p.numA.o}</span></td>
            <td><span id="numA-t-${i}">${p.numA.t}</span></td>
            <td><span id="numA-h-${i}">${p.numA.h}</span></td>
            <td class="sign-col"></td><td class="problem-number-cell">${i + 1}.</td>
          </tr>
          <tr>
            <td>${p.numB.o}</td><td>${numB_t_display}</td><td>${numB_h_display}</td>
            <td class="sign-col">-</td><td class="problem-number-cell"></td>
          </tr>
          <tr class="answer-row">
            <td><input type="number" class="answer-input" id="ans-o-${i}" maxlength="1"></td>
            <td><input type="number" class="answer-input" id="ans-t-${i}" maxlength="1"></td>
            <td><input type="number" class="answer-input" id="ans-h-${i}" maxlength="1"></td>
            <td class="sign-col"></td><td class="problem-number-cell"></td>
          </tr>`;

        wrapper.appendChild(table);

        const allInputs = ['ans-o', 'ans-t', 'ans-h', 'borrow-o', 'borrow-t', 'borrow-h'].map(id => `${id}-${i}`);
        allInputs.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;

          el.addEventListener('focus', () => {
            if (currentProblemInView !== i) { scrollCenter(table); currentProblemInView = i; }
            el.select();
          });
          el.addEventListener('keydown', (e) => handleNav(e, i, id));

          if (id.startsWith('borrow')) {
            el.addEventListener('input', (e) => {
              const place = id.split('-')[1];
              const numAEl = document.getElementById(`numA-${place}-${i}`);
              if (numAEl) numAEl.classList.toggle('strikethrough', e.target.value !== '');
            });
          }
        });
      });
    }

    function handleNav(e, i, id) {
      let nextId = null;
      const enterNavOrder = [`ans-o-${i}`, `ans-t-${i}`, `ans-h-${i}`];

      if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
        e.preventDefault();
      }

      if (e.key === 'Enter') {
        e.preventDefault();
        const order = (incorrectFieldIds.length > 0) ? incorrectFieldIds : enterNavOrder;
        const idx = order.indexOf(id);
        if (idx > -1 && idx < order.length - 1) {
          nextId = order[idx + 1];
        }
        if (!nextId && incorrectFieldIds.length === 0 && i < NUM_QUESTIONS - 1) {
          nextId = `ans-o-${i + 1}`;
        }
      } else {
        const navMap = {
          [`ans-o-${i}`]:    { ArrowUp: `borrow-o-${i}`, ArrowLeft: `ans-t-${i}` },
          [`ans-t-${i}`]:    { ArrowUp: `borrow-t-${i}`, ArrowLeft: `ans-h-${i}`, ArrowRight: `ans-o-${i}` },
          [`ans-h-${i}`]:    { ArrowUp: `borrow-h-${i}`, ArrowRight: `ans-t-${i}` },
          [`borrow-o-${i}`]: { ArrowDown: `ans-o-${i}`,   ArrowLeft: `borrow-t-${i}` },
          [`borrow-t-${i}`]: { ArrowDown: `ans-t-${i}`,   ArrowLeft: `borrow-h-${i}`, ArrowRight: `borrow-o-${i}` },
          [`borrow-h-${i}`]: { ArrowDown: `ans-h-${i}`,   ArrowRight:`borrow-t-${i}` }
        };
        
        if (navMap[id] && navMap[id][e.key]) {
          e.preventDefault();
          nextId = navMap[id][e.key];
        }
      }

      if (nextId && document.getElementById(nextId)) {
        document.getElementById(nextId).focus();
      } else if (e.key === 'Enter') {
        checkBtn.focus();
      }
    }

    function checkAnswers() {
      incorrectFieldIds = [];
      let allCorrect = true;
      currentProblemInView = -1;

      problems.forEach((p, i) => {
        const fields = [
          { id: `borrow-h-${i}`, correct: p.borrow.h === 1 ? p.borrowed.h : null },
          { id: `borrow-t-${i}`, correct: p.borrow.t === 1 ? p.borrowed.t : null },
          { id: `borrow-o-${i}`, correct: null },
          { id: `ans-h-${i}`, correct: p.answer.h },
          { id: `ans-t-${i}`, correct: p.answer.t },
          { id: `ans-o-${i}`, correct: p.answer.o }
        ];

        fields.forEach(field => {
          const el = document.getElementById(field.id);
          const userValue = el.value.trim() === '' ? null : +el.value;
          el.classList.remove('incorrect-field', 'correct-field');

          if (field.correct === null && userValue === null) {
            el.disabled = true;
          } else if (userValue !== field.correct) {
            allCorrect = false;
            incorrectFieldIds.push(field.id);
            el.classList.add('incorrect-field');
            el.disabled = false;
          } else {
            el.disabled = true;
            el.classList.add('correct-field');
          }
        });
      });

      const resultDiv = document.getElementById('result');
      if (allCorrect) {
        checkBtn.disabled = true;
        retryBtn.disabled = false;
        retryBtn.focus();
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        const baseScore = 100, timeBonus = Math.max(0, Math.floor((TIME_LIMIT - elapsed) * 50 / TIME_LIMIT));
        const score = baseScore + timeBonus;

        let starsHtml = '―';
        if (score >= SCORE_STARS_THRESHOLD.star3) starsHtml = '★★★';
        else if (score >= SCORE_STARS_THRESHOLD.star2) starsHtml = '★★';
        else if (score >= SCORE_STARS_THRESHOLD.star1) starsHtml = '★';
        else if (score >= SCORE_STARS_THRESHOLD.star_circle) starsHtml = '○';

        resultDiv.innerHTML = `スコア: <strong>${score}点</strong><br>タイム: ${elapsed} 秒`;
        saveData(score, starsHtml);
        updateDisplay();
      } else {
        resultDiv.innerHTML = '❌ まちがいがあります。<br>赤いところを直そう！';
        resultDiv.style.color = 'red';

        const orderMap = { 'borrow-o': 0, 'ans-o': 1, 'borrow-t': 2, 'ans-t': 3, 'borrow-h': 4, 'ans-h': 5 };
        incorrectFieldIds.sort((a, b) => {
          const indexA = parseInt(a.split('-').pop());
          const indexB = parseInt(b.split('-').pop());
          if (indexA !== indexB) return indexA - indexB;
          const typeA = a.split('-').slice(0, 2).join('-');
          const typeB = b.split('-').slice(0, 2).join('-');
          return orderMap[typeA.replace(/-\d+$/, '')] - orderMap[typeB.replace(/-\d+$/, '')];
        });
        if (incorrectFieldIds.length > 0) document.getElementById(incorrectFieldIds[0]).focus();
      }
    }

    function retry() {
      incorrectFieldIds = [];
      currentProblemInView = -1;
      document.getElementById('result').textContent = '';
      checkBtn.disabled = false;
      retryBtn.disabled = true;
      startTime = Date.now();
      generateProblems();
      displayProblems();
      document.getElementById('ans-o-0')?.focus();
    }

    window.addEventListener('DOMContentLoaded', () => {
      const startBtn = document.getElementById('start-btn');
      startBtn.onclick = () => {
        startArea.style.display = 'none';
        problemsSection.style.display = 'block';
        resultArea.style.display = 'block';
        retry();
      };
      checkBtn.onclick = checkAnswers;
      retryBtn = document.getElementById('retry');
      retryBtn.onclick = retry;
      resetHighScoreBtn.onclick = resetHighScore;

      loadData(); updateDisplay();
      startBtn.focus();

      document.addEventListener('keydown', e => {
        if (e.key === 'Enter' && startArea.style.display !== 'none') {
          e.preventDefault(); startBtn.click();
        }
      });
    });
  </script>
</body>
</html>