<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="app-title" content="åˆ†æ•°ã¨é•·ã•">
    <title>åˆ†æ•°ã¨é•·ã•</title>
    <style>
        :root {
            /* ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒï¼ˆJSã§ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰ */
            --primary-color: #4A90E2;
            --secondary-color: #f0f8ff;
            --accent-color: #FF9800;
            --text-color: #333;
            --bg-pattern: radial-gradient(#e0f7fa 10%, transparent 10%);
        }

        body {
            font-family: "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
            margin: 0;
            padding: 0;
            background-color: #fdfdfd;
            background-image: var(--bg-pattern);
            background-size: 20px 20px;
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 95%;
            max-width: 600px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
            position: relative;
            border-top: 8px solid var(--primary-color);
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ */
        h1 {
            font-size: 1.2rem;
            color: #666;
            margin: 0;
            margin-bottom: 5px;
        }

        h2 {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin: 0 0 15px 0;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-weight: bold;
            background: var(--secondary-color);
            padding: 10px;
            border-radius: 8px;
        }

        /* èª¬æ˜ãƒœã‚¿ãƒ³ */
        .hint-btn {
            background: #FFEB3B;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .instruction-card {
            display: none;
            background: #fff3e0;
            border: 2px solid #ffb74d;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: left;
            font-size: 0.95rem;
        }

        /* åˆ†æ•°è¡¨ç¤ºç”¨CSS */
        .fraction {
            display: inline-block;
            vertical-align: middle;
            text-align: center;
            font-size: 1.2em;
        }
        .fraction .top {
            border-bottom: 2px solid currentColor;
            display: block;
            padding: 0 2px;
        }
        .fraction .bottom {
            display: block;
            padding: 0 2px;
        }

        /* å•é¡Œã‚¨ãƒªã‚¢ */
        .question-row {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px dashed #ddd;
            font-size: 1.3rem;
            flex-wrap: wrap;
            gap: 5px;
        }

        .question-text {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        input[type="tel"] {
            width: 60px;
            height: 40px;
            font-size: 1.5rem;
            text-align: center;
            border: 2px solid #ccc;
            border-radius: 8px;
            margin: 0 5px;
            outline: none;
            transition: border-color 0.2s;
        }

        input[type="tel"]:focus {
            border-color: var(--primary-color);
            background-color: #f0f8ff;
        }

        input.correct {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        input.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .controls {
            margin-top: 20px;
        }

        button.primary-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.2rem;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }

        button.primary-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆãƒ»ãƒªã‚¶ãƒ«ãƒˆï¼‰ */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .hidden {
            display: none !important;
        }

        .start-title {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }

        .record-area {
            margin-top: 20px;
            font-size: 0.9rem;
            color: #666;
            background: #eee;
            padding: 10px;
            border-radius: 8px;
        }

        /* ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f00;
            animation: fall linear forwards;
            z-index: 999;
        }

        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); }
        }
    </style>
</head>
<body>

    <div id="start-screen" class="overlay">
        <h1 id="start-main-title" class="start-title">ãƒ­ãƒ¼ãƒ‰ä¸­...</h1>
        <div id="start-subtitle" style="font-size: 1.2rem; margin-bottom: 30px;"></div>
        <button class="primary-btn" onclick="startGame()">ã‚¹ã‚¿ãƒ¼ãƒˆ (Enter)</button>
        <div class="record-area" id="record-display">
            ãã‚ãï¼šã¾ã ã‚ã‚Šã¾ã›ã‚“
        </div>
    </div>

    <div class="container">
        <header>
            <h1 id="main-title"></h1>
            <h2 id="sub-title"></h2>
        </header>

        <div class="status-bar">
            <span>ã‚¿ã‚¤ãƒ : <span id="timer">0</span>ç§’</span>
            <span><button class="hint-btn" onclick="toggleInstruction()">ğŸ’¡</button></span>
        </div>

        <div id="instruction-area" class="instruction-card"></div>

        <div id="questions-container">
            </div>

        <div class="controls">
            <button id="check-btn" class="primary-btn" onclick="checkAnswers()">ã¾ã‚‹ã¤ã‘</button>
        </div>
    </div>

    <div id="result-screen" class="overlay hidden">
        <h2 style="color: var(--primary-color); font-size: 2rem;">ã‚¯ãƒªã‚¢ï¼</h2>
        <div style="font-size: 1.5rem; margin: 20px;">
            ã‚¹ã‚³ã‚¢: <span id="score-display"></span>ç‚¹
        </div>
        <div id="result-comment" style="font-size: 1.2rem; margin-bottom: 20px;"></div>
        <button class="primary-btn" onclick="resetGame()">ã‚‚ã†ä¸€å›</button>
        <button style="margin-top:10px; background:none; border:none; color:#666; text-decoration:underline; cursor:pointer;" onclick="resetRecords()">ãã‚ãã‚’æ¶ˆã™</button>
    </div>

<script>
/**
 * ä¸€å•ä¸€ç­”ç®—æ•°ã‚¢ãƒ—ãƒªé–‹ç™º1230ç‰ˆ
 * å˜å…ƒï¼šåˆ†æ•°ï¼ˆ3å¹´ä¸‹ p.41ï¼‰
 * è¦ä»¶ï¼šConfigæ§‹é€ åŒ–ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å¯¾å¿œã€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–ç‰ˆ
 */

// 1. Configã®å®šç¾©
const config = {
    appId: "bunsu_length_p41",
    page: 41,
    display: {
        title: "ï¼‘ï¼–ã€€åˆ†æ•°",
        subtitle: "åˆ†æ•°ã¨é•·ã•",
        startMessage: "Enterã‚­ãƒ¼ã§ã‚¹ã‚¿ãƒ¼ãƒˆï¼",
        instruction: `
            <strong>ãƒã‚¤ãƒ³ãƒˆ</strong><br>
            <span class="fraction"><span class="top">b</span><span class="bottom">a</span></span> m ã¯ã€
            <span class="fraction"><span class="top">1</span><span class="bottom">a</span></span> m ã® <strong>b</strong> ã“åˆ†ã§ã™ã€‚<br>
            <hr style="margin:5px 0; border:0; border-top:1px dashed #ccc;">
            ä¾‹ï¼š<span class="fraction"><span class="top">2</span><span class="bottom">7</span></span> m ã¯ã€
            <span class="fraction"><span class="top">1</span><span class="bottom">7</span></span> m ã® <strong>2</strong> ã“åˆ†ã€‚<br>
            â€» <strong>1m</strong> ã¯ã€
            <span class="fraction"><span class="top">7</span><span class="bottom">7</span></span> m ã¨åŒã˜ã ã‹ã‚‰ã€<strong>7</strong> ã“åˆ†ã ã‚ˆã€‚
        `
    },
    settings: {
        questionCount: 6,
        baseScore: 100,
        targetTime: 60, // ç§’
    },
    rank: {
        star5: 180, // ã‚¹ã‚³ã‚¢åŸºæº–
        star4: 160,
        star3: 140,
        star2: 120,
        star1: 100
    }
};

// çŠ¶æ…‹ç®¡ç†
let questions = [];
let startTime = 0;
let timerInterval = null;
let isGradingMode = false; // ã¾ã‚‹ã¤ã‘å¾Œã‹ã©ã†ã‹

// 2. åˆæœŸåŒ–å‡¦ç† (ãƒ†ãƒ¼ãƒè¨­å®šãƒ»ãƒ†ã‚­ã‚¹ãƒˆåæ˜ )
function init() {
    setRandomTheme();
    
    // HTMLã¸ã®ãƒ†ã‚­ã‚¹ãƒˆåæ˜ 
    document.getElementById('main-title').textContent = config.display.title;
    document.getElementById('sub-title').textContent = config.display.subtitle;
    document.getElementById('start-main-title').textContent = config.display.subtitle;
    document.getElementById('start-subtitle').textContent = config.display.title;
    document.getElementById('instruction-area').innerHTML = config.display.instruction;
    document.title = config.display.subtitle; // titleã‚¿ã‚°ã®åŒæœŸ

    updateRecordDisplay();

    // ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã§ã®ã‚¹ã‚¿ãƒ¼ãƒˆå¾…æ©Ÿ
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && document.getElementById('start-screen').classList.contains('hidden') === false) {
            startGame();
        }
    });
}

// ãƒ©ãƒ³ãƒ€ãƒ ãƒ†ãƒ¼ãƒä½œæˆ
function setRandomTheme() {
    const themes = [
        { primary: "#4A90E2", bg: "#e0f7fa" }, // ã‚¹ã‚«ã‚¤ãƒ–ãƒ«ãƒ¼
        { primary: "#66BB6A", bg: "#e8f5e9" }, // ãƒŸãƒ³ãƒˆã‚°ãƒªãƒ¼ãƒ³
        { primary: "#FF7043", bg: "#fbe9e7" }, // ã‚³ãƒ¼ãƒ©ãƒ«ã‚ªãƒ¬ãƒ³ã‚¸
        { primary: "#AB47BC", bg: "#f3e5f5" }, // ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼
        { primary: "#26A69A", bg: "#e0f2f1" }  // ãƒ†ã‚£ãƒ¼ãƒ«
    ];
    const theme = themes[Math.floor(Math.random() * themes.length)];
    
    const root = document.documentElement;
    root.style.setProperty('--primary-color', theme.primary);
    root.style.setProperty('--bg-pattern', `radial-gradient(${theme.bg} 20%, transparent 20%)`);
}

// 3. ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
function startGame() {
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('result-screen').classList.add('hidden');
    generateQuestions();
    
    startTime = Date.now();
    timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('timer').textContent = elapsed;
    }, 1000);
    
    isGradingMode = false;
    
    // æœ€åˆã®å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    setTimeout(() => {
        const firstInput = document.querySelector('input[type="tel"]');
        if(firstInput) firstInput.focus();
    }, 100);
}

function generateQuestions() {
    const container = document.getElementById('questions-container');
    container.innerHTML = '';
    questions = [];

    for (let i = 0; i < config.settings.questionCount; i++) {
        // åˆ†æ¯ (2ã€œ9)
        const denominator = Math.floor(Math.random() * 8) + 2;
        // åˆ†å­ (1ã€œdenominator)
        let numerator = Math.floor(Math.random() * denominator) + 1;
        
        // 5å›ã«1å›ãã‚‰ã„ã®ç¢ºç‡ã§ã€1m (denominator/denominator) ã‚’å‡ºã™
        let isOneMeter = false;
        if (i === config.settings.questionCount - 1 || Math.random() < 0.2) {
             numerator = denominator;
             // 50%ã®ç¢ºç‡ã§è¡¨è¨˜ã‚’ã€Œ1mã€ã«ã™ã‚‹
             if (Math.random() < 0.5) isOneMeter = true;
        }

        const qObj = {
            id: i,
            denominator: denominator,
            numerator: numerator,
            answer: numerator
        };
        questions.push(qObj);

        // HTMLç”Ÿæˆ
        const row = document.createElement('div');
        row.className = 'question-row';
        
        // å•é¡Œæ–‡: ã€ŒX m ã¯ 1/Y m ã® ä½•ã“åˆ†ï¼Ÿã€
        let displayFraction = "";
        if (isOneMeter) {
            displayFraction = `1m`;
        } else {
            displayFraction = `<span class="fraction"><span class="top">${numerator}</span><span class="bottom">${denominator}</span></span> m`;
        }

        const unitFraction = `<span class="fraction"><span class="top">1</span><span class="bottom">${denominator}</span></span> m`;

        row.innerHTML = `
            <div class="question-text">
                ${displayFraction} ã¯ã€${unitFraction} ã®
                <input type="tel" id="q-${i}" pattern="[0-9]*" onkeydown="handleInputKey(event, ${i})">
                ã“åˆ†
            </div>
        `;
        container.appendChild(row);
    }
}

// ã‚­ãƒ¼å…¥åŠ›åˆ¶å¾¡ï¼ˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–ï¼‰
function handleInputKey(event, currentIndex) {
    if (event.key === 'Enter') {
        event.preventDefault();
        
        if (!isGradingMode) {
            // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰: æ¬¡ã®å…¥åŠ›æ¬„ã¸
            const nextInput = document.getElementById(`q-${currentIndex + 1}`);
            if (nextInput) {
                nextInput.focus();
            } else {
                // æœ€å¾Œã®å•é¡Œãªã‚‰ã¾ã‚‹ã¤ã‘å®Ÿè¡Œ
                checkAnswers();
            }
        } else {
            // â–¼â–¼â–¼ é–“é•ã„è¨‚æ­£ãƒ¢ãƒ¼ãƒ‰ã®ç‰¹åˆ¥å‡¦ç† â–¼â–¼â–¼
            // ç¾åœ¨ã®å…¥åŠ›ãŒä¸æ­£è§£ã®ã¾ã¾ã‹ç¢ºèª
            const currentInput = document.getElementById(`q-${currentIndex}`);
            // æ¬¡ã®ã€Œä¸æ­£è§£ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¢ã™
            let nextWrongIndex = -1;
            
            for (let i = currentIndex + 1; i < config.settings.questionCount; i++) {
                const input = document.getElementById(`q-${i}`);
                if (input && input.classList.contains('incorrect')) {
                    nextWrongIndex = i;
                    break;
                }
            }
            
            if (nextWrongIndex !== -1) {
                // æ¬¡ã®é–“é•ã„ã¸ã‚¸ãƒ£ãƒ³ãƒ—
                const target = document.getElementById(`q-${nextWrongIndex}`);
                target.focus();
                target.select();
            } else {
                // ä»¥é™ã«é–“é•ã„ãŒãªã„å ´åˆã€å…ˆé ­ã‹ã‚‰æ¢ã™ï¼ˆãƒ«ãƒ¼ãƒ—ï¼‰ã‹ã€ãƒœã‚¿ãƒ³ã¸
                // ã“ã“ã§ã¯ã€Œä¿®æ­£å®Œäº†ã€ã¨ã¿ãªã—ã¦ãƒœã‚¿ãƒ³ã¸ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                document.getElementById('check-btn').focus();
            }
        }
    }
}

function checkAnswers() {
    clearInterval(timerInterval);
    let correctCount = 0;
    let firstIncorrectId = null;

    questions.forEach(q => {
        const input = document.getElementById(`q-${q.id}`);
        const userVal = parseInt(input.value);
        
        input.classList.remove('correct', 'incorrect');
        
        if (userVal === q.answer) {
            input.classList.add('correct');
            input.readOnly = true; // æ­£è§£ã¯ç·¨é›†ä¸å¯ã«
            correctCount++;
        } else {
            input.classList.add('incorrect');
            input.readOnly = false; // ä¸æ­£è§£ã¯ç·¨é›†å¯èƒ½
            if (firstIncorrectId === null) {
                firstIncorrectId = q.id;
            }
        }
    });

    if (correctCount === questions.length) {
        showResult();
    } else {
        // ã¾ã‚‹ã¤ã‘å¾Œãƒ¢ãƒ¼ãƒ‰ã¸
        isGradingMode = true;
        // ã‚¿ã‚¤ãƒ è¨ˆæ¸¬å†é–‹ï¼ˆä¿®æ­£æ™‚é–“ã‚‚å«ã‚€ãŸã‚ï¼‰
        timerInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('timer').textContent = elapsed;
        }, 1000);

        // â–¼â–¼â–¼ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–ï¼šæœ€åˆã®é–“é•ã„ã¸ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ»å…¨é¸æŠ â–¼â–¼â–¼
        if (firstIncorrectId !== null) {
            const target = document.getElementById(`q-${firstIncorrectId}`);
            setTimeout(() => {
                target.focus();
                target.select(); // æ•°å€¤ã‚’å…¨é¸æŠã—ã¦æ›¸ãæ›ãˆã‚„ã™ãã™ã‚‹
            }, 100);
        }
    }
}

function showResult() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    
    // ã‚¹ã‚³ã‚¢è¨ˆç®—
    let score = config.settings.baseScore;
    const timeBonus = Math.max(0, config.settings.targetTime - elapsed);
    score += timeBonus;
    
    // ãƒ©ãƒ³ã‚¯åˆ¤å®š
    let stars = "";
    if (score >= config.rank.star5) stars = "â˜…â˜…â˜…â˜…â˜…";
    else if (score >= config.rank.star4) stars = "â˜…â˜…â˜…â˜…";
    else if (score >= config.rank.star3) stars = "â˜…â˜…â˜…";
    else if (score >= config.rank.star2) stars = "â˜…â˜…";
    else stars = "â˜…";

    document.getElementById('score-display').textContent = score;
    document.getElementById('result-comment').innerHTML = `ã‚¿ã‚¤ãƒ : ${elapsed}ç§’<br>ãƒ©ãƒ³ã‚¯: ${stars}`;
    document.getElementById('result-screen').classList.remove('hidden');
    
    saveRecord(score, elapsed, stars);
    celebrate();
}

// 4. ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
function saveRecord(score, time, rank) {
    const record = {
        date: new Date().toLocaleString(),
        score: score,
        time: time,
        rank: rank
    };
    localStorage.setItem(config.appId, JSON.stringify(record));
    updateRecordDisplay();
}

function updateRecordDisplay() {
    const data = localStorage.getItem(config.appId);
    const display = document.getElementById('record-display');
    if (data) {
        const r = JSON.parse(data);
        display.innerHTML = `
            <strong>å‰å›ã®ãã‚ã</strong><br>
            æ—¥æ™‚: ${r.date}<br>
            ã‚¹ã‚³ã‚¢: ${r.score} (${r.rank})<br>
            ã‚¿ã‚¤ãƒ : ${r.time}ç§’
        `;
    } else {
        display.innerHTML = "ãã‚ãï¼šã¾ã ã‚ã‚Šã¾ã›ã‚“";
    }
}

function resetRecords() {
    if(confirm("ãã‚ãã‚’æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) {
        localStorage.removeItem(config.appId);
        updateRecordDisplay();
    }
}

function resetGame() {
    document.getElementById('result-screen').classList.add('hidden');
    document.getElementById('start-screen').classList.remove('hidden');
}

function toggleInstruction() {
    const area = document.getElementById('instruction-area');
    area.style.display = area.style.display === 'block' ? 'none' : 'block';
}

// ç´™å¹é›ªã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
function celebrate() {
    for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
        confetti.style.animationDuration = Math.random() * 3 + 2 + 's';
        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 5000);
    }
}

// èµ·å‹•æ™‚å®Ÿè¡Œ
window.onload = init;

</script>
</body>
</html>