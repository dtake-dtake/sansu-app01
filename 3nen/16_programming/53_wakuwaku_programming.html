<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚ãã‚ãã€€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°</title>
    <script src="https://unpkg.com/blockly/blockly_compressed.js"></script>
    <script src="https://unpkg.com/blockly/blocks_compressed.js"></script>
    <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
    <script src="https://unpkg.com/blockly/msg/ja.js"></script>
    <style>
        /* ç”»é¢å…¨ä½“ã®è¨­å®š */
        body { font-family: "Hiragino Kaku Gothic ProN", sans-serif; margin: 0; display: flex; height: 100vh; background-color: #eceff1; overflow: hidden; }
        
        #blocklyDiv { flex-grow: 1; height: 100%; min-width: 300px; }
        
        #gutter {
            width: 12px; background-color: #cfd8dc; cursor: col-resize;
            display: flex; align-items: center; justify-content: center; z-index: 10;
        }
        #gutter:hover { background-color: #b0bec5; }
        
        /* ============== ã€èª¿æ•´ç®‡æ‰€ã€‘å³å´ã‚¨ãƒªã‚¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³ ============== */
        #gameArea { 
            /* â˜…åˆæœŸçŠ¶æ…‹ã®å³å´ã®æ¨ªå¹…ã‚’å¤‰ãˆãŸã„å ´åˆã¯ã€ä¸‹ã® 500px ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ */
            width: 900px; 
            
            min-width: 350px; 
            padding: 5px 10px; /* ä½™ç™½ã‚’å°‘ã—è©°ã‚ã¾ã—ãŸ */
            display: flex; flex-direction: column; align-items: center; 
            background-color: #fff; box-sizing: border-box; 
            overflow-y: auto; /* ã©ã†ã—ã¦ã‚‚å…¥ã‚Šåˆ‡ã‚‰ãªã„æ™‚ã ã‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
            border-left: 1px solid #ccc; position: relative;
        }

        .panel { width: 100%; padding: 6px; margin-bottom: 5px; border-radius: 6px; box-sizing: border-box; font-size: 14px;}
        #questPanel { background-color: #e3f2fd; border: 2px solid #2196F3; color: #0d47a1; }
        
        #scoreBoard { 
            width: 100%; display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 5px; font-weight: bold; color: #333; flex-wrap: wrap; gap: 5px; font-size: 14px;
        }
        .badge { padding: 3px 10px; border-radius: 12px; white-space: nowrap; display: inline-block; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .clear-badge { color: #E91E63; background: #fce4ec; border: 1px solid #f8bbd0; }
        .score-badge { color: #FF8F00; background: #FFF8E1; border: 1px solid #FFECB3; }

        .score-hint {
            width: 100%; font-size: 11px; color: #555; background: #f1f8e9; 
            padding: 4px; border-radius: 4px; margin-bottom: 5px; text-align: center;
            border: 1px dashed #81c784;
        }
        .score-hint strong { color: #2E7D32; }
        .score-hint .bad { color: #d32f2f; }

        #limitPanel { background-color: #fff3e0; border: 2px solid #ff9800; color: #e65100; font-weight: bold; display: flex; justify-content: space-between;}
        .limit-warning { color: #d32f2f; animation: blink 1s infinite; }
        
        /* Canvasï¼ˆåœ°å›³ï¼‰ã®ãƒãƒ¼ã‚¸ãƒ³ã‚‚è©°ã‚ã‚‹ */
        canvas { background-color: #fff; border: 2px solid #546e7a; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 5px; max-width: 100%; height: auto; }
        
        .controls { display: flex; gap: 5px; width: 100%; flex-wrap: wrap; margin-bottom: 10px; }
        button { flex: 1; padding: 10px; font-size: 14px; cursor: pointer; border-radius: 20px; border: none; font-weight: bold; transition: 0.2s; white-space: nowrap; }
        #runBtn { background-color: #4CAF50; color: white; flex-grow: 2; }
        #runBtn:disabled { background-color: #ccc; cursor: not-allowed; }
        #newMapBtn { background-color: #FFC107; color: black; }
        #status { margin-top: 2px; font-size: 14px; font-weight: bold; height: 20px; color: #333; text-align: center;}

        /* ãƒªã‚¶ãƒ«ãƒˆç”»é¢ */
        #resultModal {
            display: none; position: absolute; top: 40px; left: 50%; transform: translateX(-50%);
            width: 85%; background: rgba(255, 255, 255, 0.98); border: 4px solid #4CAF50;
            border-radius: 15px; padding: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.4); z-index: 100;
        }
        #resultTitle { font-size: 20px; color: #2E7D32; margin-bottom: 5px; }
        .result-score { font-size: 32px; color: #FF8F00; font-weight: bold; margin: 5px 0; text-shadow: 2px 2px 0px #fff; }
        .result-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 5px 0; font-size: 13px; }
        .result-label { color: #555; font-weight: bold;}
        .result-val { font-weight: bold; color: #000; }
        .score-plus { color: #2E7D32; font-size: 13px; } 
        .score-minus { color: #d32f2f; font-size: 13px; } 
        .score-formula { font-size: 10px; color: #888; text-align: right; }
        #closeModalBtn { margin-top: 10px; background-color: #2196F3; color: white; padding: 8px 25px; border-radius: 20px; border: none; cursor: pointer; font-size: 14px; font-weight: bold; }

        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="blocklyDiv"></div>
    <div id="gutter"></div>

    <div id="gameArea">
        <div id="resultModal">
            <h2 id="resultTitle"></h2>
            <div id="resultSub" style="font-size:11px; color:#666; margin-bottom:8px;"></div>
            
            <div id="scoreDisplayArea" style="display:none;">
                <div class="result-score"><span id="finalScore">0</span> pts</div>
                <div style="background:#f9f9f9; padding:8px; border-radius:8px; margin-bottom:8px; border:1px solid #ddd;">
                    <div class="result-row">
                        <span class="result-label">ğŸ ã‚¯ãƒªã‚¢å ±é…¬</span>
                        <span class="result-val score-plus">+ 1,000</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">ğŸ§© ãƒ–ãƒ­ãƒƒã‚¯ç¯€ç´„ (<span id="savedBlocks">0</span>å€‹)</span>
                        <span class="result-val score-plus">+ <span id="resBlockBonus">0</span></span>
                    </div>
                    <div class="score-formula">ç¯€ç´„1å€‹ã«ã¤ã +300ç‚¹</div>
                    <div class="result-row">
                        <span class="result-label">ğŸ¦¶ ç§»å‹•ã‚³ã‚¹ãƒˆ (<span id="totalMoves">0</span>æ­©)</span>
                        <span class="result-val score-minus">- <span id="resMoveCost">0</span></span>
                    </div>
                    <div class="score-formula">1æ­©ã«ã¤ã -10ç‚¹</div>
                </div>
            </div>

            <div id="resultContent" style="margin-top:10px;"></div>
            <button id="closeModalBtn" onclick="closeResult()">é–‰ã˜ã‚‹</button>
        </div>

        <div id="scoreBoard">
            <span class="badge clear-badge">ğŸ† ã‚¯ãƒªã‚¢: <span id="clearCountNum">0</span>å›</span>
            <span class="badge score-badge">ğŸ‘‘ ãƒã‚¤ã‚¹ã‚³ã‚¢: <span id="highScoreNum">0</span></span>
        </div>

        <div class="score-hint">
            ğŸ’¡ <strong>å°‘ãªã„ãƒ–ãƒ­ãƒƒã‚¯</strong> ã§ã‚´ãƒ¼ãƒ«ã™ã‚‹ã¨ãƒœãƒ¼ãƒŠã‚¹ï¼<br>
            ã§ã‚‚ <span class="bad">æ­©ãã™ã</span> ã‚‹ã¨ç‚¹æ•°ãŒæ¸›ã£ã¡ã‚ƒã†ãã€‚
        </div>

        <div id="questPanel" class="panel">
            <strong>ğŸ¯ ãƒŸãƒƒã‚·ãƒ§ãƒ³:</strong> <span id="questTarget">...</span>ã‚’é›†ã‚ã‚ˆã†<br>
            ï¼ˆç¾åœ¨: <span id="questProgress">0</span> / <span id="questGoalCount">0</span>ï¼‰
        </div>

        <div id="limitPanel" class="panel">
            <span>ğŸ§© ãƒ–ãƒ­ãƒƒã‚¯: <span id="blockCount">0</span> / <span id="blockLimit">30</span></span>
            <span id="limitAlert"></span>
        </div>

        <canvas id="gameCanvas"></canvas>
        
        <div id="status">æº–å‚™OK</div>

        <div class="controls">
            <button id="runBtn" onclick="runCode()">â–¶ å®Ÿè¡Œ</button>
            <button id="newMapBtn" onclick="generateNewLevel()">ğŸ”„ æ–°ã—ã„åœ°å›³</button>
        </div>
    </div>

    <script>
        /* ==========================================
           0. è¨­å®š
           ========================================== */
        const GRID_SIZE = 13;

        // â˜…ãƒã‚¹ã®ã‚µã‚¤ã‚ºèª¿æ•´ï¼ˆç”»é¢ã«åã‚ã‚‹ãŸã‚ï¼‰
        const CELL_SIZE = 40; 
        
        const BLOCK_LIMIT = 30;

        // ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
        const BASE_SCORE = 1000;          
        const BONUS_PER_SAVED_BLOCK = 300; 
        const COST_PER_MOVE = 10;          

        const ITEMS = {
            4: { emoji: "â˜…", name: "ã‚¹ã‚¿ãƒ¼", color: "#FFD700" },
            5: { emoji: "ğŸª–", name: "ãƒ˜ãƒ«ãƒ¡ãƒƒãƒˆ" },
            6: { emoji: "ğŸ›¢ï¸", name: "ç¯æ²¹" }, 
            7: { emoji: "ğŸ†", name: "ãƒˆãƒ­ãƒ•ã‚£ãƒ¼" },
            8: { emoji: "ğŸ›", name: "ã‚¿ã‚¤ãƒ¤" }
        };
        const ITEM_IDS = Object.keys(ITEMS).map(Number);

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚­ãƒ¼
        const KEY_CLEAR_COUNT = 'progApp_clearCount_v3'; 
        const KEY_HIGH_SCORE = 'progApp_highScore_v3';

        let savedMapData = [];
        let savedQuest = {};
        let mapData = [];
        let car = { x: 0, y: 0, dir: 1 };
        let isRunning = false;
        let actions = [];
        let currentQuest = { targetId: 4, requiredNum: 3, collectedNum: 0 };
        
        let totalClearCount = 0;
        let highScore = 0;
        let isCurrentLevelCleared = false; 

        let sessionStats = { moves: 0, collected: {} };

        const canvas = document.getElementById('gameCanvas');
        canvas.width = GRID_SIZE * CELL_SIZE;
        canvas.height = GRID_SIZE * CELL_SIZE;
        const ctx = canvas.getContext('2d');

        /* ==========================================
           1. ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
           ========================================== */
        function loadSaveData() {
            const savedCount = localStorage.getItem(KEY_CLEAR_COUNT);
            const savedScore = localStorage.getItem(KEY_HIGH_SCORE);
            if (savedCount) { totalClearCount = parseInt(savedCount, 10); }
            if (savedScore) { highScore = parseInt(savedScore, 10); }
            updateScoreBoard();
        }

        function saveData() {
            localStorage.setItem(KEY_CLEAR_COUNT, totalClearCount);
            localStorage.setItem(KEY_HIGH_SCORE, highScore);
        }

        function updateScoreBoard() {
            document.getElementById("clearCountNum").innerText = totalClearCount;
            document.getElementById("highScoreNum").innerText = highScore;
        }

        /* ==========================================
           2. ç”»é¢ãƒªã‚µã‚¤ã‚º
           ========================================== */
        const gutter = document.getElementById('gutter');
        const gameArea = document.getElementById('gameArea');
        let isResizing = false;
        gutter.addEventListener('mousedown', function(e) { isResizing = true; document.body.style.cursor = 'col-resize'; e.preventDefault(); });
        window.addEventListener('mousemove', function(e) {
            if (!isResizing) return;
            let newWidth = window.innerWidth - e.clientX;
            if (newWidth < 300) newWidth = 300; // æœ€å°å¹…
            if (newWidth > window.innerWidth - 200) newWidth = window.innerWidth - 200;
            gameArea.style.width = newWidth + 'px';
            Blockly.svgResize(workspace);
        });
        window.addEventListener('mouseup', function() { if(isResizing) { isResizing = false; document.body.style.cursor = 'default'; Blockly.svgResize(workspace); } });
        window.addEventListener('resize', () => Blockly.svgResize(workspace));

        /* ==========================================
           3. Blocklyè¨­å®š
           ========================================== */
        Blockly.Blocks['move_steps'] = {
            init: function() {
                this.jsonInit({
                    "message0": "å‰ã« %1 ãƒã‚¹é€²ã‚€",
                    "args0": [{ "type": "field_number", "name": "STEPS", "value": 1, "min": 1, "max": 12 }],
                    "previousStatement": null, "nextStatement": null, "colour": 160
                });
            }
        };
        javascript.javascriptGenerator.forBlock['move_steps'] = function(block) {
            var steps = block.getFieldValue('STEPS');
            var code = '';
            for(var i=0; i < steps; i++) code += 'actions.push("move");\n';
            return code;
        };
        Blockly.Blocks['turn_right'] = { init: function() { this.jsonInit({ "message0": "å³ã‚’å‘ã â†·", "previousStatement": null, "nextStatement": null, "colour": 210 }); } };
        javascript.javascriptGenerator.forBlock['turn_right'] = function(block) { return 'actions.push("turnR");\n'; };
        Blockly.Blocks['turn_left'] = { init: function() { this.jsonInit({ "message0": "å·¦ã‚’å‘ã â†¶", "previousStatement": null, "nextStatement": null, "colour": 210 }); } };
        javascript.javascriptGenerator.forBlock['turn_left'] = function(block) { return 'actions.push("turnL");\n'; };

        const workspace = Blockly.inject('blocklyDiv', {
            toolbox: {
                "kind": "flyoutToolbox",
                "contents": [
                    { "kind": "block", "type": "move_steps" },
                    { "kind": "block", "type": "turn_right" },
                    { "kind": "block", "type": "turn_left" },
                    { "kind": "block", "type": "controls_repeat_ext", "inputs": { "TIMES": { "shadow": { "type": "math_number", "fields": { "NUM": 3 } } } } } 
                ]
            },
            zoom: { controls: true, startScale: 0.9 },
            scrollbars: true
        });

        function checkBlockLimit() {
            const count = workspace.getAllBlocks(false).length;
            document.getElementById('blockCount').innerText = count;
            document.getElementById('blockLimit').innerText = BLOCK_LIMIT;
            const runBtn = document.getElementById('runBtn');
            const alertSpan = document.getElementById('limitAlert');
            if (count > BLOCK_LIMIT) { runBtn.disabled = true; alertSpan.innerText = "âš ï¸ å¤šã™ãï¼"; alertSpan.className = "limit-warning"; } 
            else { runBtn.disabled = false; alertSpan.innerText = ""; alertSpan.className = ""; }
        }
        workspace.addChangeListener(checkBlockLimit);

        /* ==========================================
           4. ãƒãƒƒãƒ—ç”Ÿæˆ
           ========================================== */
        function generateNewLevel() {
            closeResult(); 
            isCurrentLevelCleared = false; 
            let newMap = [];
            let roadCells = []; 
            for (let y = 0; y < GRID_SIZE; y++) {
                let row = [];
                for (let x = 0; x < GRID_SIZE; x++) {
                    if (y % 2 === 1 && x % 2 === 1) row.push(1);
                    else {
                        row.push(0); 
                        if (!(x===0 && y===0) && !(x===GRID_SIZE-1 && y===GRID_SIZE-1)) roadCells.push({x, y});
                    }
                }
                newMap.push(row);
            }
            newMap[0][0] = 2; // Start
            newMap[GRID_SIZE-1][GRID_SIZE-1] = 3; // Goal

            const randomItemIndex = Math.floor(Math.random() * ITEM_IDS.length);
            const targetId = ITEM_IDS[randomItemIndex];
            const requiredNum = Math.floor(Math.random() * 4) + 5; 
            savedQuest = { targetId: targetId, requiredNum: requiredNum, collectedNum: 0 };
            
            for(let i=0; i < requiredNum + 3; i++) placeItemRandomly(newMap, roadCells, targetId);
            for(let i=0; i < 18; i++) {
                 const otherId = ITEM_IDS[Math.floor(Math.random() * ITEM_IDS.length)];
                 placeItemRandomly(newMap, roadCells, otherId);
            }
            savedMapData = JSON.parse(JSON.stringify(newMap));
            resetToStart();
        }

        function resetToStart() {
            isRunning = false;
            mapData = JSON.parse(JSON.stringify(savedMapData));
            currentQuest = { ...savedQuest, collectedNum: 0 };
            car = { x: 0, y: 0, dir: 1 };
            sessionStats = { moves: 0, collected: {} };
            ITEM_IDS.forEach(id => sessionStats.collected[ITEMS[id].name] = 0);
            updateQuestUI();
            draw();
            document.getElementById("status").innerText = "æº–å‚™OK";
            checkBlockLimit();
        }

        function placeItemRandomly(map, roadCells, itemId) {
            if(roadCells.length === 0) return;
            const idx = Math.floor(Math.random() * roadCells.length);
            const pos = roadCells[idx];
            if(map[pos.y][pos.x] === 0) { map[pos.y][pos.x] = itemId; roadCells.splice(idx, 1); }
        }

        function updateQuestUI() {
            const targetItem = ITEMS[currentQuest.targetId];
            document.getElementById('questTarget').innerHTML = `${targetItem.name} ${currentQuest.requiredNum}å€‹`;
            document.getElementById('questProgress').innerText = currentQuest.collectedNum;
            document.getElementById('questGoalCount').innerText = currentQuest.requiredNum;
        }

        /* ==========================================
           5. æç”»
           ========================================== */
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for(let y=0; y<GRID_SIZE; y++) {
                for(let x=0; x<GRID_SIZE; x++) {
                    let type = mapData[y][x];
                    let px = x * CELL_SIZE; py = y * CELL_SIZE;
                    let cx = px + CELL_SIZE/2; cy = py + CELL_SIZE/2;
                    if (type === 1) { ctx.fillStyle = "#455A64"; ctx.fillRect(px, py, CELL_SIZE, CELL_SIZE); } 
                    else {
                        ctx.strokeStyle = "#e0e0e0"; ctx.lineWidth = 1; ctx.strokeRect(px, py, CELL_SIZE, CELL_SIZE);
                        if(type !== 3 && type !== 2) { ctx.beginPath(); ctx.arc(cx, cy, 2, 0, Math.PI*2); ctx.fillStyle = "#ccc"; ctx.fill(); }
                    }
                    if(type === 2) { ctx.font = "20px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText("ğŸ ", cx, cy); }
                    else if(type === 3) { ctx.font = "20px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText("ğŸ", cx, cy); }
                    else if(ITEMS[type]) {
                        if(type === 4) drawStarShape(cx, cy, CELL_SIZE * 0.4, 5, "#FFD700", "#FF8F00");
                        else { ctx.font = "20px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText(ITEMS[type].emoji, cx, cy); }
                    }
                }
            }
            drawRacingCar();
        }
        function drawStarShape(cx, cy, radius, spikes, fillColor, strokeColor) {
            let rot = Math.PI/2*3; let x=cx; let y=cy; let step=Math.PI/spikes;
            ctx.beginPath(); ctx.moveTo(cx, cy-radius);
            for(let i=0; i<spikes; i++){ x=cx+Math.cos(rot)*radius; y=cy+Math.sin(rot)*radius; ctx.lineTo(x,y); rot+=step; x=cx+Math.cos(rot)*(radius/2); y=cy+Math.sin(rot)*(radius/2); ctx.lineTo(x,y); rot+=step; }
            ctx.lineTo(cx, cy-radius); ctx.closePath(); ctx.fillStyle=fillColor; ctx.fill(); ctx.strokeStyle=strokeColor; ctx.lineWidth=2; ctx.stroke();
        }
        function drawRacingCar() {
            let cx = car.x * CELL_SIZE + CELL_SIZE/2; let cy = car.y * CELL_SIZE + CELL_SIZE/2; let size = CELL_SIZE * 0.8;
            ctx.save(); ctx.translate(cx, cy);
            let deg = 0; if (car.dir === 0) deg = -90; if (car.dir === 1) deg = 0; if (car.dir === 2) deg = 90; if (car.dir === 3) deg = 180;
            ctx.rotate(deg * Math.PI / 180);
            ctx.fillStyle = "#333"; let wW = size*0.3, wH = size*0.15, wOX = size*0.25, wOY = size*0.3;
            ctx.fillRect(-wOX-wW/2, -wOY, wW, wH); ctx.fillRect(wOX-wW/2, -wOY, wW, wH); ctx.fillRect(-wOX-wW/2, wOY-wH, wW, wH); ctx.fillRect(wOX-wW/2, wOY-wH, wW, wH);
            ctx.fillStyle = "#D32F2F"; ctx.beginPath(); ctx.moveTo(-size/2, -size/4); ctx.lineTo(size/4, -size/4); ctx.lineTo(size/2, 0); ctx.lineTo(size/4, size/4); ctx.lineTo(-size/2, size/4); ctx.closePath(); ctx.fill();
            ctx.fillStyle = "#212121"; ctx.fillRect(-size/2 - 2, -size/3, size/8, size*0.66);
            ctx.fillStyle = "#eee"; ctx.fillRect(size/2 - 2, -size/3, size/10, size*0.66);
            ctx.fillStyle = "#FFEB3B"; ctx.beginPath(); ctx.arc(-size/10, 0, size/7, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle = "#333"; ctx.lineWidth = 1; ctx.stroke();
            ctx.restore();
        }

        /* ==========================================
           6. å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯
           ========================================== */
        function runCode() {
            if(isRunning) return;
            resetToStart(); closeResult();
            if (workspace.getAllBlocks(false).length > BLOCK_LIMIT) { alert("ãƒ–ãƒ­ãƒƒã‚¯ãŒå¤šã™ãã¾ã™ï¼"); return; }
            isRunning = true;
            document.getElementById("status").innerText = "ğŸï¸ GO!";
            actions = [];
            const code = javascript.javascriptGenerator.workspaceToCode(workspace);
            try { eval(code); } catch (e) { console.error(e); }
            executeNextAction(0);
        }

        function executeNextAction(index) {
            if(!isRunning) return;
            if(index >= actions.length) { finishGame(false); return; }
            processCommand(actions[index]);
            draw();
            if(mapData[car.y][car.x] === 3) { setTimeout(() => finishGame(true), 100); return; }
            setTimeout(() => { executeNextAction(index + 1); }, 120); 
        }

        function processCommand(cmd) {
            if(cmd === "turnR") car.dir = (car.dir + 1) % 4;
            else if (cmd === "turnL") car.dir = (car.dir + 3) % 4;
            else if (cmd === "move") {
                let nx = car.x, ny = car.y;
                if(car.dir === 0) ny--; if(car.dir === 1) nx++; if(car.dir === 2) ny++; if(car.dir === 3) nx--;
                if(nx < 0 || nx >= GRID_SIZE || ny < 0 || ny >= GRID_SIZE || mapData[ny][nx] === 1) {
                    document.getElementById("status").innerText = "ğŸ’¥ ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ï¼"; isRunning = false;
                } else {
                    car.x = nx; car.y = ny;
                    sessionStats.moves++;
                    let cellType = mapData[ny][nx];
                    if(ITEMS[cellType]) {
                        let itemName = ITEMS[cellType].name;
                        sessionStats.collected[itemName]++;
                        if(cellType === currentQuest.targetId) { currentQuest.collectedNum++; document.getElementById("status").innerText = `ğŸ‘ ${itemName}ã‚²ãƒƒãƒˆ!`; } 
                        else { document.getElementById("status").innerText = `ğŸ“¥ ${itemName}ã‚’æ‹¾ã£ãŸ`; }
                        mapData[ny][nx] = 0; updateQuestUI();
                    }
                }
            }
        }

        function finishGame(reachedGoal) {
            isRunning = false;
            if(reachedGoal) {
                if(currentQuest.collectedNum >= currentQuest.requiredNum) {
                     let isNewClear = false;
                     if(!isCurrentLevelCleared) {
                         totalClearCount++;
                         isCurrentLevelCleared = true;
                         isNewClear = true;
                     }
                     document.getElementById("status").innerText = "ğŸ† ã‚´ãƒ¼ãƒ«ï¼";
                     calculateAndShowResult(true, isNewClear);
                     saveData();
                } else {
                     document.getElementById("status").innerText = "ã‚¢ã‚¤ãƒ†ãƒ ä¸è¶³â€¦";
                     calculateAndShowResult(false, false);
                }
            } else {
                document.getElementById("status").innerText = "ğŸ›‘ åœæ­¢";
            }
        }

        /* ==========================================
           7. ãƒªã‚¶ãƒ«ãƒˆï¼†ã‚¹ã‚³ã‚¢è¨ˆç®— (åŠ ç‚¹å¼ + ç§»å‹•ã‚³ã‚¹ãƒˆ)
           ========================================== */
        function calculateAndShowResult(isSuccess, isNewClear) {
            const modal = document.getElementById('resultModal');
            const title = document.getElementById('resultTitle');
            const sub = document.getElementById('resultSub');
            const scoreArea = document.getElementById('scoreDisplayArea');
            const content = document.getElementById('resultContent');
            
            modal.style.display = 'block';

            const usedBlocks = workspace.getAllBlocks(false).length;
            const movedSteps = sessionStats.moves;
            
            // ã‚¹ã‚³ã‚¢è¨ˆç®—
            let finalScore = 0;
            let savedBlocks = 0;
            let blockBonus = 0;
            let moveCost = 0;

            if(isSuccess) {
                // 1. åŸºç¤ç‚¹ (ã‚¯ãƒªã‚¢å ±é…¬)
                finalScore = BASE_SCORE;

                // 2. ãƒ–ãƒ­ãƒƒã‚¯ãƒœãƒ¼ãƒŠã‚¹ (ç¯€ç´„ * 300)
                savedBlocks = Math.max(0, BLOCK_LIMIT - usedBlocks);
                blockBonus = savedBlocks * BONUS_PER_SAVED_BLOCK;
                finalScore += blockBonus;

                // 3. ç§»å‹•ã‚³ã‚¹ãƒˆ (æ­©æ•° * 10)
                moveCost = movedSteps * COST_PER_MOVE;
                finalScore -= moveCost;

                if(finalScore < 0) finalScore = 0; 
            }

            // ãƒã‚¤ã‚¹ã‚³ã‚¢æ›´æ–°
            if(finalScore > highScore) {
                highScore = finalScore;
                updateScoreBoard();
                sub.innerText += " ğŸ‘‘ ãƒã‚¤ã‚¹ã‚³ã‚¢æ›´æ–°!!";
                title.innerText += " (NEW RECORD!)";
                saveData();
            } else {
                updateScoreBoard();
            }

            if(isSuccess) {
                title.innerText = "ğŸ‰ ãƒŸãƒƒã‚·ãƒ§ãƒ³é”æˆï¼";
                title.style.color = "#2E7D32";
                
                let clearMsg = isNewClear ? "æ–°ã—ã„åœ°å›³ã‚¯ãƒªã‚¢ (+1å›)" : "â€»ã‚¯ãƒªã‚¢æ¸ˆã®åœ°å›³ã§ã™";
                if(finalScore >= 5000) clearMsg += " ã€Sãƒ©ãƒ³ã‚¯!!ã€‘";
                else if(finalScore >= 3000) clearMsg += " ã€Aãƒ©ãƒ³ã‚¯!ã€‘";
                else clearMsg += " ã€Good!ã€‘";
                
                sub.innerText = clearMsg;
                
                scoreArea.style.display = 'block';
                document.getElementById('finalScore').innerText = finalScore;
                
                document.getElementById('savedBlocks').innerText = savedBlocks;
                document.getElementById('resBlockBonus').innerText = blockBonus;
                
                document.getElementById('totalMoves').innerText = movedSteps;
                document.getElementById('resMoveCost').innerText = moveCost;

            } else {
                title.innerText = "ğŸ˜¢ å¤±æ•—...";
                title.style.color = "#d32f2f";
                sub.innerText = "ã‚¢ã‚¤ãƒ†ãƒ ãŒè¶³ã‚Šãªã„ã‹ã€æ­¢ã¾ã£ã¦ã—ã¾ã„ã¾ã—ãŸ";
                scoreArea.style.display = 'none';
            }

            let itemsHtml = "";
            for(let key in sessionStats.collected) {
                let count = sessionStats.collected[key];
                if(count > 0) itemsHtml += `<div class="result-row"><span class="result-label">${key}</span><span class="result-val">${count}å€‹</span></div>`;
            }
            if(itemsHtml === "") itemsHtml = "<div class='result-row'>ãªã—</div>";

            content.innerHTML = `
                <div style="margin-top:10px; font-weight:bold; background:#eee; padding:5px;">é›†ã‚ãŸã‚¢ã‚¤ãƒ†ãƒ </div>
                ${itemsHtml}
            `;
        }

        function closeResult() { document.getElementById('resultModal').style.display = 'none'; }

        // èµ·å‹•æ™‚ã®å‡¦ç†
        loadSaveData();      
        generateNewLevel();  
        setTimeout(()=>Blockly.svgResize(workspace), 100);
    </script>
</body>
</html>