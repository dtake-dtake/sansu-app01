<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚ãã‚ããƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°</title>
    <script src="https://unpkg.com/blockly/blockly_compressed.js"></script>
    <script src="https://unpkg.com/blockly/blocks_compressed.js"></script>
    <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
    <script src="https://unpkg.com/blockly/msg/ja.js"></script>
    <style>
        /* ç”»é¢å…¨ä½“ã®è¨­å®š */
        body { font-family: "Hiragino Kaku Gothic ProN", sans-serif; margin: 0; display: flex; height: 100vh; background-color: #fff9c4; overflow: hidden; }
        
        #blocklyDiv { flex-grow: 1; height: 100%; min-width: 300px; }
        
        #gutter {
            width: 12px; background-color: #fbc02d; cursor: col-resize;
            display: flex; align-items: center; justify-content: center; z-index: 10;
        }
        #gutter:hover { background-color: #fdd835; }
        
        #gameArea { 
            width: 500px; 
            min-width: 350px; 
            padding: 5px 10px;
            display: flex; flex-direction: column; align-items: center; 
            background-color: #fff; box-sizing: border-box; 
            overflow-y: auto; 
            border-left: 2px solid #f9a825; position: relative;
        }

        .panel { width: 100%; padding: 6px; margin-bottom: 5px; border-radius: 6px; box-sizing: border-box; font-size: 14px;}
        #questPanel { background-color: #fff3e0; border: 2px solid #ff9800; color: #e65100; }
        
        #scoreBoard { 
            width: 100%; display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 5px; font-weight: bold; color: #333; flex-wrap: wrap; gap: 5px; font-size: 14px;
        }
        .badge { padding: 3px 10px; border-radius: 12px; white-space: nowrap; display: inline-block; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .clear-badge { color: #fff; background: #e91e63; }
        .score-badge { color: #fff; background: #ff9800; }

        .score-hint {
            width: 100%; font-size: 12px; color: #555; background: #f1f8e9; 
            padding: 5px; border-radius: 4px; margin-bottom: 5px; text-align: center;
            border: 1px dashed #81c784;
        }
        .score-hint strong { color: #2E7D32; font-weight: bold; font-size: 14px; }

        #limitPanel { background-color: #eceff1; border: 2px solid #607d8b; color: #455a64; font-weight: bold; display: flex; justify-content: space-between;}
        .limit-warning { color: #d32f2f; animation: blink 1s infinite; }
        
        canvas { background-color: #fff; border: 2px solid #795548; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 5px; max-width: 100%; height: auto; border-radius: 4px; }
        
        .controls { display: flex; gap: 5px; width: 100%; flex-wrap: wrap; margin-bottom: 10px; }
        button { flex: 1; padding: 10px; font-size: 14px; cursor: pointer; border-radius: 20px; border: none; font-weight: bold; transition: 0.2s; white-space: nowrap; }
        #runBtn { background-color: #4CAF50; color: white; flex-grow: 2; box-shadow: 0 4px #2e7d32; }
        #runBtn:active { transform: translateY(2px); box-shadow: 0 2px #2e7d32; }
        #runBtn:disabled { background-color: #ccc; cursor: not-allowed; box-shadow: none; }
        #newMapBtn { background-color: #03A9F4; color: white; box-shadow: 0 4px #0277bd; }
        #newMapBtn:active { transform: translateY(2px); box-shadow: 0 2px #0277bd; }

        #status { margin-top: 2px; font-size: 14px; font-weight: bold; height: 20px; color: #333; text-align: center;}

        /* ãƒªã‚¶ãƒ«ãƒˆç”»é¢ */
        #resultModal {
            display: none; position: absolute; top: 40px; left: 50%; transform: translateX(-50%);
            width: 85%; background: rgba(255, 255, 255, 0.98); border: 4px solid #FF9800;
            border-radius: 15px; padding: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.4); z-index: 100;
        }
        #resultTitle { font-size: 22px; color: #e65100; margin-bottom: 5px; }
        .result-score { font-size: 36px; color: #e65100; font-weight: bold; margin: 5px 0; text-shadow: 2px 2px 0px #fff; }
        .result-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 6px 0; font-size: 13px; }
        .result-label { color: #555; font-weight: bold;}
        .result-val { font-weight: bold; color: #000; }
        .score-plus { color: #2E7D32; font-size: 13px; } 
        .score-formula { font-size: 10px; color: #888; text-align: right; }
        #closeModalBtn { margin-top: 10px; background-color: #2196F3; color: white; padding: 8px 25px; border-radius: 20px; border: none; cursor: pointer; font-size: 14px; font-weight: bold; }

        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="blocklyDiv"></div>
    <div id="gutter"></div>

    <div id="gameArea">
        <div id="resultModal">
            <h2 id="resultTitle"></h2>
            <div id="resultSub" style="font-size:11px; color:#666; margin-bottom:8px;"></div>
            
            <div id="scoreDisplayArea" style="display:none;">
                <div class="result-score"><span id="finalScore">0</span> pts</div>
                <div style="background:#fff3e0; padding:8px; border-radius:8px; margin-bottom:8px; border:1px solid #ffe0b2;">
                    <div class="result-row">
                        <span class="result-label">ğŸš© ã‚¯ãƒªã‚¢å ±é…¬</span>
                        <span class="result-val score-plus">+ 500</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">ğŸ’ é›†ã‚ãŸæ•° (<span id="collectedCount">0</span>å€‹)</span>
                        <span class="result-val score-plus">+ <span id="resItemBonus">0</span></span>
                    </div>
                    <div class="score-formula">1å€‹ã«ã¤ã +300ç‚¹</div>
                    <div class="result-row">
                        <span class="result-label">ğŸ§© ãƒ–ãƒ­ãƒƒã‚¯ç¯€ç´„ (<span id="savedBlocks">0</span>å€‹)</span>
                        <span class="result-val score-plus">+ <span id="resBlockBonus">0</span></span>
                    </div>
                    <div class="score-formula">1å€‹ã«ã¤ã +500ç‚¹</div>
                </div>
            </div>

            <div id="resultContent" style="margin-top:10px;"></div>
            <button id="closeModalBtn" onclick="closeResult()">é–‰ã˜ã‚‹</button>
        </div>

        <div id="scoreBoard">
            <span class="badge clear-badge">ğŸ† ã‚¯ãƒªã‚¢: <span id="clearCountNum">0</span>å›</span>
            <span class="badge score-badge">ğŸ‘‘ ãƒã‚¤ã‚¹ã‚³ã‚¢: <span id="highScoreNum">0</span></span>
        </div>

        <div class="score-hint">
            ğŸ’¡ <strong>ä¸­ã«ã‚ã‚‹ã‚¢ã‚¤ãƒ†ãƒ </strong> ã‚’å–ã‚Šã«è¡Œã“ã†ï¼<br>
            ã¤ã‹ã£ãŸãƒ–ãƒ­ãƒƒã‚¯ã®æ•°ãŒã™ããªã„ã»ã©ã€ã‚¹ã‚³ã‚¢ãŒã‚¢ãƒƒãƒ—ã—ã¾ã™ï¼
        </div>

        <div id="questPanel" class="panel">
            <strong>ğŸ¯ ãƒŸãƒƒã‚·ãƒ§ãƒ³:</strong> <span id="questTarget">...</span>ã‚’é›†ã‚ã‚ˆã†<br>
            ï¼ˆç¾åœ¨: <span id="questProgress">0</span> / <span id="questGoalCount">0</span>ï¼‰
        </div>

        <div id="limitPanel" class="panel">
            <span>ğŸ§© ãƒ–ãƒ­ãƒƒã‚¯æ•°: <span id="blockCount">0</span> / <span id="blockLimit">30</span></span>
            <span id="limitAlert"></span>
        </div>

        <canvas id="gameCanvas"></canvas>
        
        <div id="status">æº–å‚™OK</div>

        <div class="controls">
            <button id="runBtn" onclick="runCode()">â–¶ å®Ÿè¡Œ</button>
            <button id="newMapBtn" onclick="generateNewLevel()">ğŸ”„ æ–°ã—ã„åœ°å›³</button>
        </div>
    </div>

    <script>
        /* ==========================================
           0. è¨­å®š & ã‚¹ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯
           ========================================== */
        const GRID_SIZE = 13;
        const CELL_SIZE = 32; 
        const BLOCK_LIMIT = 30;

        // ã‚¹ã‚³ã‚¢è¨­å®š
        const BASE_SCORE = 500;            
        const SCORE_PER_ITEM = 300;        
        const SCORE_PER_SAVED_BLOCK = 500; 

        // ã‚¢ã‚¤ãƒ†ãƒ å®šç¾©
        const ITEMS = {
            4: { emoji: "ğŸ’", name: "å®çŸ³", color: "#29b6f6" },      // æ°´è‰²
            5: { emoji: "ğŸ’°", name: "ãŠé‡‘è¢‹", color: "#fdd835" },    // é‡‘è‰²
            6: { emoji: "ğŸ‘‘", name: "ç‹å† ", color: "#ffca28" },      // æ¿ƒã„é»„è‰²
            7: { emoji: "ğŸ†", name: "ãƒˆãƒ­ãƒ•ã‚£ãƒ¼", color: "#fff176" }, // è–„ã„é»„è‰²
            8: { emoji: "ğŸ”‘", name: "ã‚«ã‚®", color: "#bdbdbd" },      // éŠ€è‰²
            9: { emoji: "ğŸ", name: "ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ", color: "#ef5350" } // èµ¤è‰²
        };
        const ITEM_IDS = Object.keys(ITEMS).map(Number);

        const KEY_CLEAR_COUNT = 'progApp_fruit_clear'; 
        const KEY_HIGH_SCORE = 'progApp_fruit_score';

        let savedMapData = [];
        let savedQuest = {};
        let mapData = [];
        let car = { x: 0, y: 0, dir: 1 };
        let isRunning = false;
        let actions = [];
        let currentQuest = { targetId: 4, requiredNum: 5, collectedNum: 0 };
        
        let totalClearCount = 0;
        let highScore = 0;
        let isCurrentLevelCleared = false; 

        let sessionStats = { moves: 0, collectedTotal: 0, collectedDetails: {} };

        const canvas = document.getElementById('gameCanvas');
        canvas.width = GRID_SIZE * CELL_SIZE;
        canvas.height = GRID_SIZE * CELL_SIZE;
        const ctx = canvas.getContext('2d');

        /* ==========================================
           1. ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
           ========================================== */
        function loadSaveData() {
            const savedCount = localStorage.getItem(KEY_CLEAR_COUNT);
            const savedScore = localStorage.getItem(KEY_HIGH_SCORE);
            if (savedCount) { totalClearCount = parseInt(savedCount, 10); }
            if (savedScore) { highScore = parseInt(savedScore, 10); }
            updateScoreBoard();
        }

        function saveData() {
            localStorage.setItem(KEY_CLEAR_COUNT, totalClearCount);
            localStorage.setItem(KEY_HIGH_SCORE, highScore);
        }

        function updateScoreBoard() {
            document.getElementById("clearCountNum").innerText = totalClearCount;
            document.getElementById("highScoreNum").innerText = highScore;
        }

        /* ==========================================
           2. ç”»é¢ãƒªã‚µã‚¤ã‚º
           ========================================== */
        const gutter = document.getElementById('gutter');
        const gameArea = document.getElementById('gameArea');
        let isResizing = false;
        gutter.addEventListener('mousedown', function(e) { isResizing = true; document.body.style.cursor = 'col-resize'; e.preventDefault(); });
        window.addEventListener('mousemove', function(e) {
            if (!isResizing) return;
            let newWidth = window.innerWidth - e.clientX;
            if (newWidth < 300) newWidth = 300; 
            if (newWidth > window.innerWidth - 200) newWidth = window.innerWidth - 200;
            gameArea.style.width = newWidth + 'px';
            Blockly.svgResize(workspace);
        });
        window.addEventListener('mouseup', function() { if(isResizing) { isResizing = false; document.body.style.cursor = 'default'; Blockly.svgResize(workspace); } });
        window.addEventListener('resize', () => Blockly.svgResize(workspace));

        /* ==========================================
           3. Blocklyè¨­å®š
           ========================================== */
        Blockly.Blocks['move_steps'] = {
            init: function() {
                this.jsonInit({
                    "message0": "å‰ã« %1 ãƒã‚¹é€²ã‚€",
                    "args0": [{ "type": "field_number", "name": "STEPS", "value": 1, "min": 1, "max": 12 }],
                    "previousStatement": null, "nextStatement": null, "colour": 160
                });
            }
        };
        javascript.javascriptGenerator.forBlock['move_steps'] = function(block) {
            var steps = block.getFieldValue('STEPS');
            var code = '';
            for(var i=0; i < steps; i++) code += 'actions.push("move");\n';
            return code;
        };
        Blockly.Blocks['turn_right'] = { init: function() { this.jsonInit({ "message0": "å³ã‚’å‘ã â†·", "previousStatement": null, "nextStatement": null, "colour": 210 }); } };
        javascript.javascriptGenerator.forBlock['turn_right'] = function(block) { return 'actions.push("turnR");\n'; };
        Blockly.Blocks['turn_left'] = { init: function() { this.jsonInit({ "message0": "å·¦ã‚’å‘ã â†¶", "previousStatement": null, "nextStatement": null, "colour": 210 }); } };
        javascript.javascriptGenerator.forBlock['turn_left'] = function(block) { return 'actions.push("turnL");\n'; };

        const workspace = Blockly.inject('blocklyDiv', {
            toolbox: {
                "kind": "flyoutToolbox",
                "contents": [
                    { "kind": "block", "type": "move_steps" },
                    { "kind": "block", "type": "turn_right" },
                    { "kind": "block", "type": "turn_left" },
                    { "kind": "block", "type": "controls_repeat_ext", "inputs": { "TIMES": { "shadow": { "type": "math_number", "fields": { "NUM": 3 } } } } } 
                ]
            },
            zoom: { controls: true, startScale: 0.9 },
            scrollbars: true
        });

        function checkBlockLimit() {
            const count = workspace.getAllBlocks(false).length;
            document.getElementById('blockCount').innerText = count;
            document.getElementById('blockLimit').innerText = BLOCK_LIMIT;
            const runBtn = document.getElementById('runBtn');
            const alertSpan = document.getElementById('limitAlert');
            if (count > BLOCK_LIMIT) { runBtn.disabled = true; alertSpan.innerText = "âš ï¸ å¤šã™ãï¼"; alertSpan.className = "limit-warning"; } 
            else { runBtn.disabled = false; alertSpan.innerText = ""; alertSpan.className = ""; }
        }
        workspace.addChangeListener(checkBlockLimit);

        /* ==========================================
           4. ãƒãƒƒãƒ—ç”Ÿæˆ (å¤–å‘¨åˆ¶é™ã®å®Ÿè£…)
           ========================================== */
        const MAX_EDGE_ITEMS = 4; // å¤–å‘¨ã«ç½®ã‘ã‚‹æœ€å¤§æ•°

        function generateNewLevel() {
            closeResult(); 
            isCurrentLevelCleared = false; 
            let newMap = [];
            let roadCells = []; 
            for (let y = 0; y < GRID_SIZE; y++) {
                let row = [];
                for (let x = 0; x < GRID_SIZE; x++) {
                    if (y % 2 === 1 && x % 2 === 1) row.push(1);
                    else {
                        row.push(0); 
                        if (!(x===0 && y===0) && !(x===GRID_SIZE-1 && y===GRID_SIZE-1)) roadCells.push({x, y});
                    }
                }
                newMap.push(row);
            }
            newMap[0][0] = 2; // Start
            newMap[GRID_SIZE-1][GRID_SIZE-1] = 3; // Goal

            const randomItemIndex = Math.floor(Math.random() * ITEM_IDS.length);
            const targetId = ITEM_IDS[randomItemIndex];
            
            // è¦æ±‚æ•°ã‚’4ã€œ6å€‹ã«ä¸‹æ–¹ä¿®æ­£ï¼ˆã¡ã‚‡ã†ã©ã„ã„é›£æ˜“åº¦ï¼‰
            const requiredNum = Math.floor(Math.random() * 3) + 4; 
            savedQuest = { targetId: targetId, requiredNum: requiredNum, collectedNum: 0 };
            
            let edgeItemCount = 0; // å¤–å‘¨ã‚¢ã‚¤ãƒ†ãƒ ã‚«ã‚¦ãƒ³ã‚¿

            // ãƒŸãƒƒã‚·ãƒ§ãƒ³å¯¾è±¡ã®ã‚¢ã‚¤ãƒ†ãƒ é…ç½® (å¿…è¦æ•° + äºˆå‚™)
            for(let i=0; i < requiredNum + 2; i++) {
                edgeItemCount = placeItemWithConstraint(newMap, roadCells, targetId, edgeItemCount);
            }
            
            // ãã®ä»–ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’é©é‡é…ç½® (å°‘ã—æ§ãˆã‚ã«)
            for(let i=0; i < 6; i++) {
                const otherId = ITEM_IDS[Math.floor(Math.random() * ITEM_IDS.length)];
                edgeItemCount = placeItemWithConstraint(newMap, roadCells, otherId, edgeItemCount);
            }

            savedMapData = JSON.parse(JSON.stringify(newMap));
            resetToStart();
        }

        // å¤–å‘¨åˆ¶é™ä»˜ãã®é…ç½®é–¢æ•°
        function placeItemWithConstraint(map, roadCells, itemId, currentEdgeCount) {
            if(roadCells.length === 0) return currentEdgeCount;

            // å€™è£œåœ°ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            // (å¤–å‘¨ã®æ•°ãŒä¸Šé™ã«é”ã—ã¦ã„ãŸã‚‰ã€å¤–å‘¨ä»¥å¤–ã®ãƒã‚¹ã ã‘ã‚’å€™è£œã«ã™ã‚‹)
            let candidates = roadCells;
            if (currentEdgeCount >= MAX_EDGE_ITEMS) {
                candidates = roadCells.filter(pos => {
                    const isEdge = (pos.x === 0 || pos.x === GRID_SIZE - 1 || pos.y === 0 || pos.y === GRID_SIZE - 1);
                    return !isEdge; // å¤–å‘¨ã˜ã‚ƒãªã„å ´æ‰€ã ã‘æ®‹ã™
                });
            }

            if(candidates.length === 0) return currentEdgeCount; // ç½®ãå ´æ‰€ãŒãªã„

            const idx = Math.floor(Math.random() * candidates.length);
            const pos = candidates[idx];
            
            // é…ç½®
            if(map[pos.y][pos.x] === 0) {
                map[pos.y][pos.x] = itemId;
            }

            // é¸ã‚“ã å ´æ‰€ãŒå¤–å‘¨ãªã‚‰ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
            if (pos.x === 0 || pos.x === GRID_SIZE - 1 || pos.y === 0 || pos.y === GRID_SIZE - 1) {
                currentEdgeCount++;
            }

            // å…ƒã®roadCellsã‹ã‚‰å‰Šé™¤ï¼ˆé‡è¤‡é…ç½®é˜²æ­¢ï¼‰
            const originalIdx = roadCells.findIndex(p => p.x === pos.x && p.y === pos.y);
            if(originalIdx > -1) {
                roadCells.splice(originalIdx, 1);
            }

            return currentEdgeCount;
        }

        function resetToStart() {
            isRunning = false;
            mapData = JSON.parse(JSON.stringify(savedMapData));
            currentQuest = { ...savedQuest, collectedNum: 0 };
            car = { x: 0, y: 0, dir: 1 };
            sessionStats = { moves: 0, collectedTotal: 0, collectedDetails: {} };
            ITEM_IDS.forEach(id => sessionStats.collectedDetails[ITEMS[id].name] = 0);
            updateQuestUI();
            draw();
            document.getElementById("status").innerText = "æº–å‚™OK";
            checkBlockLimit();
        }

        function updateQuestUI() {
            const targetItem = ITEMS[currentQuest.targetId];
            document.getElementById('questTarget').innerHTML = `${targetItem.emoji} ${targetItem.name} ${currentQuest.requiredNum}å€‹`;
            document.getElementById('questProgress').innerText = currentQuest.collectedNum;
            document.getElementById('questGoalCount').innerText = currentQuest.requiredNum;
        }

        /* ==========================================
           5. æç”»
           ========================================== */
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for(let y=0; y<GRID_SIZE; y++) {
                for(let x=0; x<GRID_SIZE; x++) {
                    let type = mapData[y][x];
                    let px = x * CELL_SIZE; py = y * CELL_SIZE;
                    let cx = px + CELL_SIZE/2; cy = py + CELL_SIZE/2;
                    if (type === 1) { ctx.fillStyle = "#8d6e63"; ctx.fillRect(px, py, CELL_SIZE, CELL_SIZE); } 
                    else {
                        ctx.strokeStyle = "#ffe0b2"; ctx.lineWidth = 1; ctx.strokeRect(px, py, CELL_SIZE, CELL_SIZE);
                        if(type !== 3 && type !== 2) { ctx.beginPath(); ctx.arc(cx, cy, 2, 0, Math.PI*2); ctx.fillStyle = "#ffe0b2"; ctx.fill(); }
                    }
                    if(type === 2) { ctx.font = "20px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText("ğŸ ", cx, cy); }
                    else if(type === 3) { ctx.font = "20px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText("ğŸ", cx, cy); }
                    else if(ITEMS[type]) {
                        ctx.font = "22px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; 
                        ctx.fillText(ITEMS[type].emoji, cx, cy);
                    }
                }
            }
            drawRacingCar();
        }
// â˜…ä¸Šã‹ã‚‰è¦‹ãŸã‚¹ãƒªãƒ ãªã‚¹ãƒãƒ¼ãƒ„ã‚«ãƒ¼ã‚’æç”»ã™ã‚‹é–¢æ•°
        function drawRacingCar() {
            let cx = car.x * CELL_SIZE + CELL_SIZE/2;
            let cy = car.y * CELL_SIZE + CELL_SIZE/2;
            let size = CELL_SIZE;

            ctx.save();
            ctx.translate(cx, cy);
            
            // å‘ãã®èª¿æ•´ï¼ˆå³å‘ãã‚’åŸºæº–ã«å›è»¢ï¼‰
            let deg = 0; 
            if (car.dir === 0) deg = -90; 
            if (car.dir === 1) deg = 0;   
            if (car.dir === 2) deg = 90;  
            if (car.dir === 3) deg = 180; 
            ctx.rotate(deg * Math.PI / 180);

            // ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ï¼ˆç´°é•·ããªã‚‹ã®ã§å°‘ã—ç¸®å°ï¼‰
            let scale = size / 28; 
            ctx.scale(scale, scale);

            // 1. ã‚¿ã‚¤ãƒ¤ï¼ˆãƒœãƒ‡ã‚£ã‚ˆã‚Šå°‘ã—å¤–å´ã«å‡ºã™ï¼‰
            ctx.fillStyle = "#222";
            // å·¦=å¾Œã‚ã€å³=å‰ã€‚å¹…ã‚’ç´°ãã€å°‘ã—å¤–å´ã«é…ç½®
            ctx.fillRect(-10, -8, 5, 3); // å·¦ä¸Š(å¾Œè¼ª)
            ctx.fillRect(-10,  5, 5, 3); // å·¦ä¸‹(å¾Œè¼ª)
            ctx.fillRect( 6, -8, 4, 3);  // å³ä¸Š(å‰è¼ª)
            ctx.fillRect( 6,  5, 4, 3);  // å³ä¸‹(å‰è¼ª)

            // 2. ãƒœãƒ‡ã‚£æœ¬ä½“ï¼ˆã‚¹ãƒªãƒ ã§é‹­ãï¼‰
            ctx.fillStyle = "#D50000"; // ã‚ˆã‚Šæ·±ã„èµ¤
            ctx.beginPath();
            // å¾Œã‚ã‹ã‚‰å‰ã¸ã€‚å¹…ã‚’ç‹­ãè¨­å®š(-5ã€œ+5)
            ctx.moveTo(-11, -5); 
            ctx.lineTo( 0, -5);  
            ctx.lineTo( 12, -2); // ãƒãƒ¼ã‚ºã‚’é‹­ãé•·ã
            ctx.quadraticCurveTo(13, 0, 12, 2); // å…ˆç«¯ã®å°ã•ãªä¸¸ã¿
            ctx.lineTo( 0,  5);  
            ctx.lineTo(-11,  5); 
            ctx.closePath();
            ctx.fill();
            
            // ãƒœãƒ‡ã‚£ã®ã‚¨ãƒƒã‚¸ãƒªãƒ³ã‚°
            ctx.strokeStyle = "#FF1744";
            ctx.lineWidth = 0.5;
            ctx.stroke();

            // 3. ã‚³ãƒƒã‚¯ãƒ”ãƒƒãƒˆï¼ˆç´°é•·ãï¼‰
            ctx.fillStyle = "#263238"; // æ¿ƒã„ã‚°ãƒ¬ãƒ¼
            ctx.beginPath();
            ctx.moveTo(-4, -3);
            ctx.lineTo( 1, -2);
            ctx.lineTo( 1,  2);
            ctx.lineTo(-4,  3);
            ctx.quadraticCurveTo(-5, 0, -4, -3);
            ctx.fill();

            // 4. ãƒªã‚¢ã‚¦ã‚¤ãƒ³ã‚°ï¼ˆè–„ãåºƒãï¼‰
            ctx.fillStyle = "#B71C1C"; // æš—ã„èµ¤
            ctx.fillRect(-12, -7, 2, 14);

            // 5. ã‚¹ãƒˆãƒ©ã‚¤ãƒ—ï¼ˆç´°ãï¼‰
            ctx.fillStyle = "#fff";
            ctx.fillRect(-11, -0.5, 23, 1); // ä¸­å¿ƒã®ç´°ã„ç·š

            // 6. ãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒˆï¼ˆå°ã•ãé‹­ãï¼‰
            ctx.fillStyle = "#FFEB3B";
            ctx.beginPath();
            ctx.moveTo(11, -3); ctx.lineTo(12.5, -2); ctx.lineTo(11, -1); ctx.fill();
            ctx.beginPath();
            ctx.moveTo(11,  3); ctx.lineTo(12.5,  2); ctx.lineTo(11,  1); ctx.fill();

            ctx.restore();
        }

        /* ==========================================
           6. å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯
           ========================================== */
        function runCode() {
            if(isRunning) return;
            resetToStart(); closeResult();
            if (workspace.getAllBlocks(false).length > BLOCK_LIMIT) { alert("ãƒ–ãƒ­ãƒƒã‚¯ãŒå¤šã™ãã¾ã™ï¼"); return; }
            isRunning = true;
            document.getElementById("status").innerText = "ğŸï¸ å‡ºç™ºï¼";
            actions = [];
            const code = javascript.javascriptGenerator.workspaceToCode(workspace);
            try { eval(code); } catch (e) { console.error(e); }
            executeNextAction(0);
        }

        function executeNextAction(index) {
            if(!isRunning) return;
            if(index >= actions.length) { finishGame(false); return; }
            processCommand(actions[index]);
            draw();
            if(mapData[car.y][car.x] === 3) { setTimeout(() => finishGame(true), 100); return; }
            setTimeout(() => { executeNextAction(index + 1); }, 100); 
        }

        function processCommand(cmd) {
            if(cmd === "turnR") car.dir = (car.dir + 1) % 4;
            else if (cmd === "turnL") car.dir = (car.dir + 3) % 4;
            else if (cmd === "move") {
                let nx = car.x, ny = car.y;
                if(car.dir === 0) ny--; if(car.dir === 1) nx++; if(car.dir === 2) ny++; if(car.dir === 3) nx--;
                if(nx < 0 || nx >= GRID_SIZE || ny < 0 || ny >= GRID_SIZE || mapData[ny][nx] === 1) {
                    document.getElementById("status").innerText = "ğŸ’¥ è¡çªï¼"; isRunning = false;
                } else {
                    car.x = nx; car.y = ny;
                    sessionStats.moves++;
                    let cellType = mapData[ny][nx];
                    if(ITEMS[cellType]) {
                        let itemName = ITEMS[cellType].name;
                        sessionStats.collectedDetails[itemName]++;
                        sessionStats.collectedTotal++; 
                        if(cellType === currentQuest.targetId) { currentQuest.collectedNum++; document.getElementById("status").innerText = `ğŸ‘ ${itemName}ã‚²ãƒƒãƒˆ!`; } 
                        else { document.getElementById("status").innerText = `ğŸ§º ${itemName}ã‚’æ‹¾ã£ãŸ`; }
                        mapData[ny][nx] = 0; updateQuestUI();
                    }
                }
            }
        }

        function finishGame(reachedGoal) {
            isRunning = false;
            if(reachedGoal) {
                if(currentQuest.collectedNum >= currentQuest.requiredNum) {
                     let isNewClear = false;
                     if(!isCurrentLevelCleared) {
                         totalClearCount++;
                         isCurrentLevelCleared = true;
                         isNewClear = true;
                     }
                     document.getElementById("status").innerText = "ğŸ† ã‚´ãƒ¼ãƒ«ï¼";
                     calculateAndShowResult(true, isNewClear);
                     saveData();
                } else {
                     document.getElementById("status").innerText = "ã‚¢ã‚¤ãƒ†ãƒ ä¸è¶³â€¦";
                     calculateAndShowResult(false, false);
                }
            } else {
                document.getElementById("status").innerText = "ğŸ›‘ åœæ­¢";
            }
        }

        /* ==========================================
           7. ãƒªã‚¶ãƒ«ãƒˆ
           ========================================== */
        function calculateAndShowResult(isSuccess, isNewClear) {
            const modal = document.getElementById('resultModal');
            const title = document.getElementById('resultTitle');
            const sub = document.getElementById('resultSub');
            const scoreArea = document.getElementById('scoreDisplayArea');
            const content = document.getElementById('resultContent');
            
            modal.style.display = 'block';

            const usedBlocks = workspace.getAllBlocks(false).length;
            const collectedCount = sessionStats.collectedTotal;
            
            let finalScore = 0;
            let savedBlocks = 0;
            let blockBonus = 0;
            let itemBonus = 0;

            if(isSuccess) {
                finalScore = BASE_SCORE;
                itemBonus = collectedCount * SCORE_PER_ITEM;
                finalScore += itemBonus;
                savedBlocks = Math.max(0, BLOCK_LIMIT - usedBlocks);
                blockBonus = savedBlocks * SCORE_PER_SAVED_BLOCK;
                finalScore += blockBonus;
            }

            if(finalScore > highScore) {
                highScore = finalScore;
                updateScoreBoard();
                sub.innerText += " ğŸ‘‘ ãƒã‚¤ã‚¹ã‚³ã‚¢æ›´æ–°!!";
                title.innerText += " (NEW RECORD!)";
                saveData();
            } else {
                updateScoreBoard();
            }

            if(isSuccess) {
                title.innerText = "ğŸ‰ å¤§åç©«ï¼ï¼";
                title.style.color = "#e65100";
                
                let clearMsg = isNewClear ? "æ–°ã—ã„åœ°å›³ã‚¯ãƒªã‚¢ (+1å›)" : "â€»ã‚¯ãƒªã‚¢æ¸ˆã®åœ°å›³ã§ã™";
                sub.innerText = clearMsg;
                
                scoreArea.style.display = 'block';
                document.getElementById('finalScore').innerText = finalScore;
                
                document.getElementById('collectedCount').innerText = collectedCount;
                document.getElementById('resItemBonus').innerText = itemBonus;
                
                document.getElementById('savedBlocks').innerText = savedBlocks;
                document.getElementById('resBlockBonus').innerText = blockBonus;

            } else {
                title.innerText = "ğŸ˜¢ å¤±æ•—...";
                title.style.color = "#d32f2f";
                sub.innerText = "ã‚¢ã‚¤ãƒ†ãƒ ãŒè¶³ã‚Šãªã„ã‹ã€æ­¢ã¾ã£ã¦ã—ã¾ã„ã¾ã—ãŸ";
                scoreArea.style.display = 'none';
            }

            let itemsHtml = "";
            for(let key in sessionStats.collectedDetails) {
                let count = sessionStats.collectedDetails[key];
                if(count > 0) itemsHtml += `<div class="result-row"><span class="result-label">${key}</span><span class="result-val">${count}å€‹</span></div>`;
            }
            if(itemsHtml === "") itemsHtml = "<div class='result-row'>ãªã—</div>";

            content.innerHTML = `
                <div style="margin-top:10px; font-weight:bold; background:#eee; padding:5px;">åç©«ã—ãŸã‚¢ã‚¤ãƒ†ãƒ </div>
                ${itemsHtml}
            `;
        }

        function closeResult() { document.getElementById('resultModal').style.display = 'none'; }

        loadSaveData();      
        generateNewLevel();  
        setTimeout(()=>Blockly.svgResize(workspace), 100);
    </script>
</body>
</html>