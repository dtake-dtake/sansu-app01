<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥å¤«ã—ã¦è¨ˆç®—ã—ã‚ˆã†</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
        /* â–¼â–¼â–¼ ãƒ†ãƒ¼ãƒï¼šãƒŸãƒ³ãƒˆãƒ»ã‚­ãƒ£ãƒ³ãƒã‚¹ â–¼â–¼â–¼ */
        :root {
            --c-bg-body: #F1F8E9;
            --c-bg-board: #ffffff;
            --c-primary: #009688;         /* çŸ¥çš„ãªãƒ†ã‚£ãƒ¼ãƒ«ã‚°ãƒªãƒ¼ãƒ³ */
            --c-accent: #FF7043;          /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã®ã‚ªãƒ¬ãƒ³ã‚¸ */
            --c-text: #263238;
            
            --board-shadow: 0 4px 10px rgba(0,0,0,0.1);
            --border-color: #B0BEC5;
        }

        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: var(--c-bg-body);
            color: var(--c-text);
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; box-sizing: border-box;
            overscroll-behavior: none;
        }

        h1 { margin: 0 0 10px 0; font-size: 1.4rem; color: var(--c-primary); }
        h2 { 
            margin: 0 0 15px 0; font-size: 1.1rem; 
            background: #E0F2F1; padding: 5px 15px; border-radius: 20px; 
            color: #00695C;
        }

        /* ãƒ¡ã‚¤ãƒ³ã®æç”»ãƒ»å•é¡Œã‚¨ãƒªã‚¢ */
        #board-area {
            position: relative;
            width: 100%; max-width: 700px;
            height: 60vh; 
            min-height: 300px;
            background-color: var(--c-bg-board);
            border: 3px solid var(--c-primary);
            border-radius: 12px;
            box-shadow: var(--board-shadow);
            overflow: hidden;
            touch-action: none;
            cursor: crosshair;
        }

        /* å•é¡Œã®è¡¨ç¤º */
        #problem-text {
            position: absolute;
            top: 40px; left: 0; right: 0;
            text-align: center;
            font-size: 3.5rem;
            font-weight: bold;
            color: #37474F;
            z-index: 1; /* ãƒšãƒ³ã®ä¸‹ */
            user-select: none;
            font-family: 'Courier New', Courier, monospace; 
            letter-spacing: 2px;
            pointer-events: none; /* ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚’é€éã•ã›ã‚‹ */
        }

        /* æç”»ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        #drawing-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ */
        #controls {
            width: 100%; max-width: 700px;
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 15px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tool-btn {
            background: #ECEFF1; border: 1px solid #CFD8DC;
            border-radius: 8px; padding: 10px 15px;
            font-size: 1rem; cursor: pointer; color: #455A64;
            font-weight: bold; display: flex; align-items: center; gap: 5px;
        }
        .tool-btn:active { background: #CFD8DC; }
        
        .answer-area {
            display: flex; align-items: center; gap: 10px;
            background: #fff; padding: 5px 15px; border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        #answer-input {
            font-size: 1.8rem; width: 4em; padding: 5px; text-align: center;
            border: 2px solid var(--border-color); border-radius: 6px;
            outline: none;
        }
        #answer-input:focus { border-color: var(--c-primary); background: #E0F2F1; }

        #check-btn {
            background-color: var(--c-primary); color: #fff;
            border: none; padding: 10px 25px; font-size: 1.2rem;
            border-radius: 8px; cursor: pointer; font-weight: bold;
            box-shadow: 0 3px 0 #00695C;
        }
        #check-btn:active { transform: translateY(3px); box-shadow: none; }
        
        #message-area {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95); padding: 20px 40px;
            border-radius: 15px; border: 4px solid var(--c-primary);
            font-size: 2rem; font-weight: bold; color: var(--c-primary);
            display: none; z-index: 100; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        /* ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        #status-bar {
            position: absolute; top: 10px; right: 20px;
            font-size: 0.9rem; color: var(--c-text);
            background: rgba(255,255,255,0.8); padding: 5px 10px;
            border-radius: 15px; font-weight: bold;
        }

        .color-picker { display: flex; gap: 8px; }
        .color-dot {
            width: 28px; height: 28px; border-radius: 50%; cursor: pointer;
            border: 2px solid #fff; box-shadow: 0 0 2px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        .color-dot.active { transform: scale(1.2); border-color: #333; }

    </style>
</head>
<body>

    <div id="status-bar">
        ä»Šæ—¥ï¼š<span id="daily-count">0</span>å› | åˆè¨ˆï¼š<span id="total-count">0</span>å›
    </div>

    <h1>ï¼”å¹´ã€€ã‚ã‚Šç®—ã®ã›ã„ã—ã¤</h1>
    <h2>å·¥å¤«ã—ã¦è¨ˆç®—ã—ã‚ˆã†ï¼ˆãƒ¡ãƒ¢æ›¸ãOKï¼‰</h2>

    <div id="board-area">
        <div id="problem-text"></div>
        <canvas id="drawing-canvas"></canvas>
    </div>

    <div id="controls">
        <div style="display:flex; flex-direction:column; gap:8px;">
            <div class="color-picker">
                <div class="color-dot active" style="background:#333;" data-color="#333333"></div>
                <div class="color-dot" style="background:#E91E63;" data-color="#E91E63"></div>
                <div class="color-dot" style="background:#2196F3;" data-color="#2196F3"></div>
            </div>
            <button id="clear-btn" class="tool-btn">ğŸ—‘ï¸ å…¨ã¦æ¶ˆã™</button>
        </div>

        <div class="answer-area">
            <span style="font-weight:bold; font-size:1.2rem;">ç­”ãˆ</span>
            <input type="tel" inputmode="numeric" id="answer-input">
            <button id="check-btn">æ±ºå®š</button>
        </div>
    </div>
    
    <div id="message-area"></div>

    <script>
    (function(){
        // --- è¨­å®š ---
        const config = {
            appId: "115_kufu_shite_keisan", // ID
            DIVISORS: [5, 25, 50, 250, 500]
        };
        
        let currentProblem = {};
        
        // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
        const ls = localStorage;
        const KEY_CLEAR = `${config.appId}:clearCount`;
        const KEY_DAILY_PREFIX = `${config.appId}:dailyClear-`;
        
        let totalClearCount = 0;
        let dailyCount = 0;

        function loadData() {
            totalClearCount = parseInt(ls.getItem(KEY_CLEAR) || "0", 10);
            const todayKey = KEY_DAILY_PREFIX + new Date().toISOString().slice(0, 10);
            dailyCount = parseInt(ls.getItem(todayKey) || "0", 10);
            updateDisplay();
        }

        function saveData() {
            ls.setItem(KEY_CLEAR, String(totalClearCount));
            const todayKey = KEY_DAILY_PREFIX + new Date().toISOString().slice(0, 10);
            ls.setItem(todayKey, String(dailyCount));
        }

        function updateDisplay() {
            document.getElementById('total-count').textContent = totalClearCount;
            document.getElementById('daily-count').textContent = dailyCount;
        }

        // --- Canvas é–¢é€£ ---
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let penColor = "#333333";
        
        function resizeCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.lineWidth = 3;
        }
        window.addEventListener('resize', resizeCanvas);
        
        // --- å•é¡Œç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ---
        function generateProblem() {
            // 1. ã‚ã‚‹æ•°ã‚’ãƒªã‚¹ãƒˆã‹ã‚‰ç­‰ç¢ºç‡ã§é¸ã¶
            const divisor = config.DIVISORS[Math.floor(Math.random() * config.DIVISORS.length)];
            
            // 2. ã€Œã‚ã‚‰ã‚Œã‚‹æ•°ã€ãŒ4ã‘ãŸ(1000ã€œ9999)ã«ãªã‚‹ãŸã‚ã®ã€Œå•†ã€ã®ç¯„å›²ã‚’é€†ç®—
            const minQ = Math.ceil(1000 / divisor);
            const maxQ = Math.floor(9999 / divisor);
            
            // 3. ç¯„å›²å†…ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«å•†ã‚’é¸ã¶
            const quotient = Math.floor(Math.random() * (maxQ - minQ + 1)) + minQ;
            
            // 4. ã‚ã‚‰ã‚Œã‚‹æ•°ã‚’è¨ˆç®—
            const dividend = divisor * quotient;
            
            return {
                dividend,
                divisor,
                answer: quotient
            };
        }

        function setNextProblem() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const input = document.getElementById('answer-input');
            input.value = '';
            input.style.backgroundColor = '#fff';
            
            currentProblem = generateProblem();
            document.getElementById('problem-text').textContent = 
                `${currentProblem.dividend} Ã· ${currentProblem.divisor} = `;
            
            input.focus();
        }

        // --- æç”»å‡¦ç† ---
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            const pos = getPos(e);
            lastX = pos.x;
            lastY = pos.y;
            ctx.beginPath();
            ctx.arc(lastX, lastY, 1.5, 0, Math.PI * 2);
            ctx.fillStyle = penColor;
            ctx.fill();
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault(); 
            const pos = getPos(e);
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(pos.x, pos.y);
            ctx.strokeStyle = penColor;
            ctx.lineWidth = 3;
            ctx.stroke();
            
            lastX = pos.x;
            lastY = pos.y;
        }

        function stopDrawing() {
            isDrawing = false;
        }

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        canvas.addEventListener('touchstart', startDrawing, {passive: false});
        canvas.addEventListener('touchmove', draw, {passive: false});
        canvas.addEventListener('touchend', stopDrawing);

        // --- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å‡¦ç† ---
        document.getElementById('clear-btn').onclick = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        };

        document.querySelectorAll('.color-dot').forEach(dot => {
            dot.onclick = (e) => {
                document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
                e.target.classList.add('active');
                penColor = e.target.dataset.color;
            };
        });

        function checkAnswer() {
            const inputVal = document.getElementById('answer-input').value;
            if (inputVal === '') return;
            
            const userAns = parseInt(inputVal, 10);
            const msgArea = document.getElementById('message-area');
            
            if (userAns === currentProblem.answer) {
                // æ­£è§£ï¼
                msgArea.style.color = '#00897B';
                msgArea.innerHTML = "æ­£è§£ï¼ğŸ‰";
                msgArea.style.display = 'block';
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#00897B', '#FF7043', '#FFD54F'] });
                
                // â–¼â–¼â–¼ ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—å‡¦ç† â–¼â–¼â–¼
                dailyCount++;
                totalClearCount++;
                saveData();
                updateDisplay();
                
                setTimeout(() => {
                    msgArea.style.display = 'none';
                    setNextProblem();
                }, 1500);
            } else {
                // ä¸æ­£è§£
                msgArea.style.color = '#D32F2F';
                msgArea.innerHTML = "ãŠã—ã„ï¼";
                msgArea.style.display = 'block';
                document.getElementById('answer-input').style.backgroundColor = '#FFEBEE';
                
                setTimeout(() => {
                    msgArea.style.display = 'none';
                    document.getElementById('answer-input').focus();
                }, 1000);
            }
        }

        document.getElementById('check-btn').onclick = checkAnswer;
        document.getElementById('answer-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') checkAnswer();
        });

        // --- åˆæœŸåŒ– ---
        loadData();
        
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒªã‚µã‚¤ã‚º
        setTimeout(() => {
            resizeCanvas();
            setNextProblem();
        }, 100);

    })();
    </script>
</body>
</html>