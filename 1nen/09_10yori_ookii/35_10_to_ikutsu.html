<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ï¼‘ï¼ã¨ã€€ã„ãã¤</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@500;800&display=swap" rel="stylesheet">
    <style>
        /* â–¼â–¼â–¼ ãƒ†ãƒ¼ãƒï¼šãƒãƒƒãƒ”ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒãƒ¼ï¼ˆã‚„ã•ã—ã„ç·‘ï¼‰ â–¼â–¼â–¼ */
        :root {
            --c-bg-main: #F1F8E9;         
            --c-primary: #689F38;         
            --c-primary-dark: #33691E;    
            --c-primary-light: #DCEDC8;   
            --c-accent: #FF6F00;
            --c-button-bg: #8BC34A;       
            --c-button-hover: #7CB342;    
            
            --c-result-area-bg: #ffffff;
            --c-problem-bg: #ffffff;
            --c-history-bg: #F9FBE7;      
            
            --c-text-main: #37474F;       
            --c-text-on-button: #ffffff;
            
            --c-correct: #C8E6C9; 
            --c-wrong: #FFCDD2;   
            
            --font-family: "M PLUS Rounded 1c", sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--c-bg-main); color: var(--c-text-main);
            padding: 20px; display: flex; flex-direction: column; align-items: center;
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
            background-image: radial-gradient(var(--c-primary-light) 20%, transparent 20%);
            background-position: 0 0;
            background-size: 20px 20px;
        }

        h1, h2 { text-align: center; color: var(--c-primary-dark); margin: 10px 0; letter-spacing: 1px;}
        h1 { font-size: 1.4rem; }
        
        h2 { 
            font-size: 1.3rem; 
            background: #fff;
            border: 2px solid var(--c-primary);
            padding: 8px 20px; 
            border-radius: 50px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }

        .page-circle {
            display: inline-flex; justify-content: center; align-items: center;
            width: 2.2rem; height: 2.2rem; border-radius: 50%;
            background-color: var(--c-accent); color: #fff;
            font-weight: 800; font-size: 1.2rem; line-height: 1; flex-shrink: 0;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        /* å…±é€šãƒœã‚¿ãƒ³ */
        button {
            font-family: var(--font-family);
            font-size: 1.4rem; padding: 12px 30px; border: none; border-radius: 50px;
            background-color: var(--c-button-bg); color: var(--c-text-on-button);
            cursor: pointer; transition: transform 0.1s; font-weight: 800;
            box-shadow: 0 5px 0 var(--c-primary-dark);
            margin: 10px;
        }
        button:active { transform: translateY(4px); box-shadow: 0 1px 0 var(--c-primary-dark); }
        button:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed; transform: none; }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */
        #start-area {
            text-align: center; margin-top: 40px;
            background: rgba(255,255,255,0.95);
            padding: 30px; border-radius: 20px;
            border: 4px solid var(--c-primary);
            width: 90%; max-width: 500px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .stats-box {
            background: var(--c-primary-light);
            border-radius: 10px;
            padding: 10px;
            margin: 15px 0;
            color: var(--c-primary-dark);
            font-weight: bold;
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ï¼ˆä¸€å•ä¸€ç­”ï¼‰ */
        #game-area { display: none; width: 100%; max-width: 600px; flex-direction: column; align-items: center; }
        
        .progress-bar {
            width: 100%; max-width: 400px; height: 10px;
            background: #fff; border-radius: 5px; margin: 10px 0;
            overflow: hidden; border: 1px solid var(--c-primary);
        }
        .progress-fill {
            height: 100%; background: var(--c-accent); width: 0%;
            transition: width 0.3s;
        }
        .question-counter {
            font-size: 1.2rem; font-weight: bold; color: var(--c-primary-dark); margin-bottom: 5px;
        }

        .problem-card {
            background: var(--c-problem-bg);
            border: 4px solid var(--c-primary);
            border-radius: 25px;
            padding: 30px 20px;
            margin: 20px 0;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 8px 0 rgba(0,0,0,0.1);
            position: relative;
            width: 100%;
            max-width: 450px;
            min-height: 300px;
            justify-content: center;
        }

        .problem-text {
            font-size: 1.8rem; font-weight: bold; margin-bottom: 30px;
            color: var(--c-text-main);
            text-align: center;
        }

        /* ã‚µã‚¯ãƒ©ãƒ³ãƒœå›³ */
        .cherry-diagram {
            position: relative; width: 220px; height: 180px;
            display: flex; justify-content: center;
            margin-bottom: 20px;
        }
        
        .cherry-node {
            width: 70px; height: 70px;
            border-radius: 50%;
            border: 5px solid;
            display: flex; justify-content: center; align-items: center;
            font-size: 2.2rem; font-weight: 800;
            background: #fff;
            position: absolute; z-index: 2;
        }

        .node-top { top: 0; left: 70px; border-color: var(--c-accent); color: var(--c-accent); }
        .node-left { bottom: 0; left: 10px; border-color: var(--c-primary); color: var(--c-primary); }
        .node-right { bottom: 0; right: 10px; border-color: var(--c-primary); color: var(--c-primary); }

        .cherry-line {
            position: absolute; z-index: 1;
            background: #aaa; width: 6px; height: 80px;
            border-radius: 3px;
        }
        .line-left { top: 45px; left: 70px; transform: rotate(30deg); }
        .line-right { top: 45px; right: 70px; transform: rotate(-30deg); }

        /* å…¥åŠ›æ¬„ */
        input.answer-input {
            width: 100%; height: 100%;
            border: none; border-radius: 50%;
            text-align: center; font-size: 2.2rem; font-weight: 800;
            color: #333; background: #fff; outline: none;
            font-family: var(--font-family);
            padding: 0; margin: 0;
        }
        input.answer-input:focus { background: #FFF9C4; }
        
        /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .feedback-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            pointer-events: none; z-index: 10; opacity: 0; transition: opacity 0.2s;
            border-radius: 20px;
        }
        .mark { font-size: 10rem; font-weight: bold; -webkit-text-stroke: 4px #fff; }
        .mark-correct { color: #E91E63; }
        .mark-wrong { color: #2196F3; }

        /* ãƒªã‚¶ãƒ«ãƒˆ */
        #result-area {
            display: none;
            width: 90%; max-width: 500px; margin: 20px auto; padding: 25px;
            background: var(--c-result-area-bg); border-radius: 20px; 
            border: 4px solid var(--c-primary); text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        .status-stars { font-size: 3rem; color: #FFD700; text-shadow: 2px 2px 0 #FFB300; display:block; margin: 10px 0;}
        
        #history-area { margin-top: 20px; font-size: 0.85rem; text-align: left; background: var(--c-history-bg); padding:15px; border-radius:10px;}
        #history-list { list-style: none; padding: 0; }
        #history-list li { 
            border-bottom: 1px dashed var(--c-primary); padding: 8px 0; 
            display: flex; justify-content: space-between; align-items: center;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #bulb-btn {
            position: absolute; top: 15px; right: 15px;
            width: 50px; height: 50px; padding:0; margin:0;
            border-radius: 50%; background: #fff; border: 3px solid #FFD700; 
            color: #FFD700; font-size: 2rem; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 100;
        }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 30px; border: 4px solid var(--c-primary); border-radius: 20px; width: 85%; max-width: 450px; position:relative;}
        .close-modal { position:absolute; right:15px; top:10px; font-size: 30px; cursor: pointer; color:var(--c-primary);}
        
        .hint-box {
            background: var(--c-primary-light); color: var(--c-primary-dark);
            padding: 15px; border-radius: 10px; margin: 15px 0;
            font-weight: bold; line-height: 1.8;
        }
    </style>
</head>
<body>
    <button id="bulb-btn" aria-label="ã›ã¤ã‚ã„">ï¼Ÿ</button>

    <div id="info-modal" class="modal">
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h3 style="text-align:center; color:var(--c-primary); margin-top:0;">ã‚ãã³ã‹ãŸ</h3>
        <div id="instruction-content"></div>
        <button onclick="document.getElementById('info-modal').style.display='none'" style="width:100%; margin:20px 0 0 0;">ã‚ã‹ã£ãŸï¼</button>
      </div>
    </div>

    <h1 id="main-title"></h1>
    <h2 id="sub-title">
        <span id="page-circle" class="page-circle"></span>
        <span id="sub-title-text"></span>
    </h2>

    <div id="start-area">
        <div style="font-size:4rem; margin:10px 0;">ğŸ’</div>
        <p style="font-weight:bold; font-size:1.3rem; margin:10px 0;">ï¼‘ï¼ã¨ ã„ãã¤ã§ ã§ãã‚‹ã‹ãªï¼Ÿ<br>ã‚ã‘ãŸã‚Š ã‚ã‚ã›ãŸã‚Š ã—ã‚ˆã†ï¼</p>
        
        <div class="stats-box">
            ãƒã‚¤ã‚¹ã‚³ã‚¢: <span id="high-score-display" style="font-size:1.5rem; color:#E65100;">0</span> ç‚¹
        </div>
        
        <div style="margin:15px 0; font-size:0.95rem; color:#555;">
            ãã‚‡ã†ã®ã‚¯ãƒªã‚¢ï¼š<span id="daily-count-start">0</span> ã‹ã„<br>
            ã”ã†ã‘ã„ã‚¯ãƒªã‚¢ï¼š<span id="total-count-start">0</span> ã‹ã„
        </div>

        <button id="start-btn">ã¯ã˜ã‚ã‚‹ (Enter)</button>
    </div>

    <div id="game-area">
        <div class="question-counter">ã‚‚ã‚“ã ã„ <span id="current-q-num">1</span> / <span id="total-q-num">5</span></div>
        <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>

        <div class="problem-card" id="current-problem-card">
            <div class="feedback-overlay" id="feedback-overlay">
                <div class="mark" id="feedback-mark"></div>
            </div>

            <div class="problem-text" id="problem-text"></div>
            
            <div class="cherry-diagram">
                <div class="cherry-line line-left"></div>
                <div class="cherry-line line-right"></div>
                <div class="cherry-node node-top" id="node-top"></div>
                <div class="cherry-node node-left" id="node-left"></div>
                <div class="cherry-node node-right" id="node-right"></div>
            </div>
        </div>

        <button id="answer-btn" style="width:200px;">ã“ãŸãˆã‚‹</button>
    </div>

    <div id="result-area">
        <h2 style="border:none; background:none; font-size:2rem; color:var(--c-accent); margin:0;">ã‘ã£ã‹ ã¯ã£ã´ã‚‡ã†</h2>
        <div id="result-stars" class="status-stars"></div>
        <div id="result-msg" style="font-size:1.5rem; font-weight:bold; margin:10px 0;"></div>
        <div id="result-score" style="font-size:1.2rem;"></div>
        
        <div style="font-weight:bold; color:#E65100; margin:10px 0;">
            ãƒã‚¤ã‚¹ã‚³ã‚¢: <span id="high-score-result">0</span> ç‚¹
        </div>
        
        <div class="stats-box" style="margin:20px 0;">
            ãã‚‡ã†ã®ã‚¯ãƒªã‚¢ï¼š<span id="daily-count-result" style="color:#E65100; font-size:1.2rem;">0</span> ã‹ã„<br>
            ã”ã†ã‘ã„ã‚¯ãƒªã‚¢ï¼š<span id="total-count-result" style="color:#E65100; font-size:1.2rem;">0</span> ã‹ã„
        </div>

        <div id="history-area">
            <strong>ã“ã‚Œã¾ã§ã® ãã‚ãï¼ˆã•ã„ã—ã‚“5ã‘ã‚“ï¼‰</strong>
            <ul id="history-list"></ul>
        </div>
        
        <button id="back-to-start-btn" style="margin-top:20px;">ã•ã„ã—ã‚‡ã« ã‚‚ã©ã‚‹ (Enter)</button>
        <div style="margin-top:10px;">
            <button id="reset-rank-btn" style="font-size:0.8rem; background:#90A4AE; padding:8px 15px;">ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’ã‘ã™</button>
        </div>
    </div>

    <script>
    (function(){
        // â–¼â–¼â–¼ ã‚³ãƒ³ãƒ•ã‚£ã‚°è¨­å®š â–¼â–¼â–¼
        const config = {
            appId: "10_to_ikutsu",
            mainTitle: "ï¼™ã€€ï¼‘ï¼ã‚ˆã‚Šã€€ãŠãŠãã„ã€€ã‹ãš",
            title: "ï¼‘ï¼ã¨ã€€ã„ãã¤",
            page: 35,
            baseScore: 100,
            targetTimePerQuestion: 8, // 1å•ã‚ãŸã‚Šã®ç›®å®‰ç§’æ•°ï¼ˆ8x5=40ç§’ï¼‰
            questionCount: 5, 
            starThresholds: { star5: 180, star4: 150, star3: 100, star2: 80 }, 
            instructionHtml: `
                <p>ï¼‘ï¼‘ã‹ã‚‰ï¼‘ï¼™ã¾ã§ã®ã€€ã‹ãšã«ã¤ã„ã¦ã®ã€€ã‚‚ã‚“ã ã„ã§ã™ã€‚</p>
                <div class="hint-box">
                    <strong>â‘  ã‚ã‚ã›ã‚‹</strong><br>
                    ã€Œï¼‘ï¼ã€ã¨ã€Œï¼“ã€ã§ãƒ»ãƒ»ãƒ»ã€Œï¼‘ï¼“ã€ï¼<br>
                    <br>
                    <strong>â‘¡ ã‚ã‘ã‚‹</strong><br>
                    ã€Œï¼‘ï¼•ã€ã¯ã€Œï¼‘ï¼ã€ã¨ãƒ»ãƒ»ãƒ»ã€Œï¼•ã€ï¼
                </div>
                <p>ã™ã†ã˜ã‚’ã€€ã«ã‚…ã†ã‚Šã‚‡ãã—ã¦ã€<br>ã€Œã“ãŸãˆã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã€€ãŠã—ã¦ã­ã€‚</p>
            `
        };

        // çŠ¶æ…‹å¤‰æ•°
        let problems = [];
        let currentProblemIndex = 0;
        let startTime = 0;
        let currentMistakeCount = 0; // ç¾åœ¨ã®å•é¡Œã®ãƒŸã‚¹å›æ•°
        let totalMistakeCount = 0; // å…¨ä½“ã®ãƒŸã‚¹å›æ•°

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼
        const KEY_HS = `${config.appId}:highScore`;
        const KEY_CLEAR = `${config.appId}:totalClear`;
        const KEY_DAILY_PREFIX = `${config.appId}:dailyClear_`;
        const KEY_HISTORY = `${config.appId}:history`;

        // DOMè¦ç´ å–å¾—
        const els = {
            mainTitle: document.getElementById('main-title'),
            subTitleText: document.getElementById('sub-title-text'),
            pageCircle: document.getElementById('page-circle'),
            instruction: document.getElementById('instruction-content'),
            startArea: document.getElementById('start-area'),
            startBtn: document.getElementById('start-btn'),
            
            highScoreDisplay: document.getElementById('high-score-display'),
            highScoreResult: document.getElementById('high-score-result'),
            dailyCountStart: document.getElementById('daily-count-start'),
            totalCountStart: document.getElementById('total-count-start'),
            
            gameArea: document.getElementById('game-area'),
            currentQNum: document.getElementById('current-q-num'),
            totalQNum: document.getElementById('total-q-num'),
            progressFill: document.getElementById('progress-fill'),
            
            problemText: document.getElementById('problem-text'),
            nodeTop: document.getElementById('node-top'),
            nodeLeft: document.getElementById('node-left'),
            nodeRight: document.getElementById('node-right'),
            feedbackOverlay: document.getElementById('feedback-overlay'),
            feedbackMark: document.getElementById('feedback-mark'),
            answerBtn: document.getElementById('answer-btn'),
            
            resultArea: document.getElementById('result-area'),
            dailyCountResult: document.getElementById('daily-count-result'),
            totalCountResult: document.getElementById('total-count-result'),
            historyList: document.getElementById('history-list'),
            backStartBtn: document.getElementById('back-to-start-btn'),
            resetRankBtn: document.getElementById('reset-rank-btn')
        };

        // åˆæœŸåŒ–
        function init() {
            els.mainTitle.textContent = config.mainTitle;
            els.subTitleText.textContent = config.title;
            els.pageCircle.textContent = config.page;
            els.instruction.innerHTML = config.instructionHtml;
            els.totalQNum.textContent = config.questionCount;
            
            loadStats();
            updateHistoryDisplay();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            els.startBtn.addEventListener('click', startGame);
            els.answerBtn.addEventListener('click', checkCurrentAnswer);
            els.backStartBtn.addEventListener('click', () => location.reload());
            els.resetRankBtn.addEventListener('click', resetRank);
            
            // Enterã‚­ãƒ¼åˆ¶å¾¡
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    if (els.startArea.style.display !== 'none') {
                        // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ãªã‚‰ã‚²ãƒ¼ãƒ é–‹å§‹
                        startGame();
                    } else if (els.gameArea.style.display !== 'none') {
                        // ã‚²ãƒ¼ãƒ ä¸­ãªã‚‰å›ç­”ãƒœã‚¿ãƒ³
                        els.answerBtn.click();
                        e.preventDefault();
                    } else if (els.resultArea.style.display !== 'none') {
                        // ãƒªã‚¶ãƒ«ãƒˆç”»é¢ãªã‚‰æœ€åˆã«æˆ»ã‚‹ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
                        location.reload();
                    }
                }
            });

            // ãƒ¢ãƒ¼ãƒ€ãƒ«
            const modal = document.getElementById('info-modal');
            document.getElementById('bulb-btn').onclick = () => modal.style.display = 'block';
            document.querySelector('.close-modal').onclick = () => modal.style.display = 'none';
            window.onclick = (e) => { if(e.target == modal) modal.style.display = 'none'; };
        }

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadStats() {
            const todayKey = KEY_DAILY_PREFIX + new Date().toLocaleDateString('ja-JP');
            const daily = localStorage.getItem(todayKey) || 0;
            const total = localStorage.getItem(KEY_CLEAR) || 0;
            const highScore = localStorage.getItem(KEY_HS) || 0;

            els.dailyCountStart.textContent = daily;
            els.totalCountStart.textContent = total;
            els.highScoreDisplay.textContent = highScore;
            els.highScoreResult.textContent = highScore;
            
            els.dailyCountResult.textContent = daily;
            els.totalCountResult.textContent = total;
        }

        function updateHistoryDisplay() {
            const history = JSON.parse(localStorage.getItem(KEY_HISTORY) || '[]');
            // å±¥æ­´è¡¨ç¤ºï¼šæ—¥ä»˜  â˜…  ç‚¹æ•° (ã‚¿ã‚¤ãƒ )
            els.historyList.innerHTML = history.map(h => `
                <li>
                    <span style="font-size:0.8rem; color:#555;">${h.date}</span>
                    <span>${h.stars}</span>
                    <span style="font-weight:bold; color:var(--c-primary);">
                        ${h.score}ç‚¹ <span style="font-size:0.85rem; color:#333; margin-left:5px;">(${h.time}ã³ã‚‡ã†)</span>
                    </span>
                </li>
            `).join('');
        }

        // å•é¡Œç”Ÿæˆ
        function generateProblems() {
            const arr = [];
            for (let i = 0; i < config.questionCount; i++) {
                // ãƒ‘ã‚¿ãƒ¼ãƒ³: 0=åˆ†è§£(14->10+4), 1=åˆæˆ(10+4->14)
                const type = Math.random() < 0.5 ? 0 : 1;
                const ones = Math.floor(Math.random() * 9) + 1; // 1~9
                const ten = 10;
                const sum = ten + ones;
                
                arr.push({ type, ones, ten, sum });
            }
            return arr;
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGame() {
            problems = generateProblems();
            currentProblemIndex = 0;
            totalMistakeCount = 0;
            startTime = Date.now();
            
            els.startArea.style.display = 'none';
            els.resultArea.style.display = 'none';
            els.gameArea.style.display = 'flex';
            
            showProblem(0);
        }

        // 1å•è¡¨ç¤º
        function showProblem(index) {
            currentMistakeCount = 0;
            els.currentQNum.textContent = index + 1;
            els.progressFill.style.width = `${(index / config.questionCount) * 100}%`;
            
            const p = problems[index];
            const isDecomposition = (p.type === 0);
            
            // å•é¡Œæ–‡
            els.problemText.textContent = isDecomposition 
                ? `${p.sum}ã¯ã€€ï¼‘ï¼ã¨ãƒ»ãƒ»ãƒ»ï¼Ÿ` 
                : `ï¼‘ï¼ã¨ã€€${p.ones}ã§ãƒ»ãƒ»ãƒ»ï¼Ÿ`;

            // ãƒãƒ¼ãƒ‰æ§‹ç¯‰
            let topContent, leftContent, rightContent;
            
            // å…¥åŠ›æ¬„HTML
            const inputHtml = `<input type="tel" class="answer-input" id="current-input" maxlength="2" autocomplete="off">`;

            if (isDecomposition) {
                topContent = p.sum;
                leftContent = 10;
                rightContent = inputHtml;
                p.correctVal = p.ones; // æ­£è§£å€¤ä¿æŒ
            } else {
                topContent = inputHtml;
                leftContent = 10;
                rightContent = p.ones;
                p.correctVal = p.sum; // æ­£è§£å€¤ä¿æŒ
            }
            
            els.nodeTop.innerHTML = topContent;
            els.nodeLeft.innerHTML = leftContent;
            els.nodeRight.innerHTML = rightContent;

            // å…¥åŠ›åˆ¶å¾¡
            const input = document.getElementById('current-input');
            if (input) {
                input.focus();
                input.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                });
            }
            
            // ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
            els.answerBtn.disabled = false;
        }

        // ç­”ãˆåˆã‚ã›
        function checkCurrentAnswer() {
            const input = document.getElementById('current-input');
            if (!input) return;
            
            const userVal = parseInt(input.value);
            const p = problems[currentProblemIndex];
            
            if (userVal === p.correctVal) {
                // æ­£è§£
                input.disabled = true;
                input.style.backgroundColor = '#C8E6C9'; // è–„ç·‘
                showFeedback(true);
                
                els.answerBtn.disabled = true;
                
                setTimeout(() => {
                    nextProblem();
                }, 1000);
            } else {
                // ä¸æ­£è§£
                showFeedback(false);
                currentMistakeCount++;
                totalMistakeCount++;
                input.value = "";
                input.focus();
                
                // æŒ¯å‹•ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                input.parentElement.animate([
                    { transform: 'translateX(0)' },
                    { transform: 'translateX(-5px)' },
                    { transform: 'translateX(5px)' },
                    { transform: 'translateX(0)' }
                ], { duration: 200 });
            }
        }
        
        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
        function showFeedback(isCorrect) {
            const overlay = els.feedbackOverlay;
            const mark = els.feedbackMark;
            
            overlay.style.opacity = '1';
            if (isCorrect) {
                mark.textContent = 'ã€‡';
                mark.className = 'mark mark-correct';
            } else {
                mark.textContent = 'Ã—';
                mark.className = 'mark mark-wrong';
            }
            
            setTimeout(() => {
                overlay.style.opacity = '0';
            }, 600);
        }

        // æ¬¡ã®å•é¡Œã¸
        function nextProblem() {
            currentProblemIndex++;
            if (currentProblemIndex < config.questionCount) {
                showProblem(currentProblemIndex);
            } else {
                finishGame();
            }
        }

        // ã‚²ãƒ¼ãƒ çµ‚äº†
        function finishGame() {
            els.gameArea.style.display = 'none';
            els.resultArea.style.display = 'block';
            
            const endTime = Date.now();
            const elapsedSec = Math.floor((endTime - startTime) / 1000);
            
            // ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
            // ç›®æ¨™ï¼šæ—©ã„äººï¼ˆä¾‹:10ç§’å°ï¼‰ã¯200ç‚¹è¿‘ãå‡ºã‚‹ã€‚
            const standardTime = config.targetTimePerQuestion * config.questionCount; // 40ç§’
            
            let timeBonus = 0;
            if (elapsedSec < standardTime) {
                // ä¾‹: 10ç§’ã§ã‚¯ãƒªã‚¢ -> (40 - 10) * 3.5 = 105ç‚¹ãƒœãƒ¼ãƒŠã‚¹ -> åˆè¨ˆ205ç‚¹
                timeBonus = Math.floor((standardTime - elapsedSec) * 3.5); 
            }
            
            const mistakePenalty = totalMistakeCount * 5;
            let finalScore = config.baseScore + timeBonus - mistakePenalty;
            
            // ä¸‹é™0
            if (finalScore < 0) finalScore = 0;
            
            // â˜…ã€ŒãƒŸã‚¹ãªã—ãªã‚‰æœ€ä½100ç‚¹ä¿è¨¼ã€
            // ã‚¿ã‚¤ãƒ ãƒœãƒ¼ãƒŠã‚¹ãŒãƒã‚¤ãƒŠã‚¹ã«ãªã‚‹ã“ã¨ã¯ãªã„ãŒã€ã‚‚ã—éå¸¸ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã‚‚ãƒŸã‚¹0ãªã‚‰100ç‚¹
            if (totalMistakeCount === 0 && finalScore < 100) {
                finalScore = 100;
            }
            
            // â˜…ã€å¤‰æ›´ç‚¹ã€‘ãƒŸã‚¹ãŒã‚ã£ã¦ã‚‚ã‚­ãƒ£ãƒƒãƒ—ï¼ˆä¸Šé™100ç‚¹ï¼‰ã‚’é©ç”¨ã—ãªã„ã€‚
            // ã“ã‚Œã«ã‚ˆã‚Šã€é€Ÿã‘ã‚Œã°ãƒŸã‚¹ãŒã‚ã£ã¦ã‚‚100ç‚¹ä»¥ä¸Šï¼ˆä¾‹ï¼š195ç‚¹ãªã©ï¼‰ãŒå‡ºã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

            // ã‚¹ã‚¿ãƒ¼åˆ¤å®š
            let stars = "â˜…â˜†â˜†â˜†â˜†";
            if (finalScore >= config.starThresholds.star5) stars = "â˜…â˜…â˜…â˜…â˜…";
            else if (finalScore >= config.starThresholds.star4) stars = "â˜…â˜…â˜…â˜…â˜†";
            else if (finalScore >= config.starThresholds.star3) stars = "â˜…â˜…â˜…â˜†â˜†";
            else if (finalScore >= config.starThresholds.star2) stars = "â˜…â˜…â˜†â˜†â˜†";

            document.getElementById('result-stars').textContent = stars;
            document.getElementById('result-msg').textContent = 
                (totalMistakeCount === 0 && finalScore >= config.starThresholds.star5) ? "ã™ã”ã„ï¼ ã‹ã‚“ãºãï¼" : 
                (totalMistakeCount === 0) ? "ãœã‚“ã‚‚ã‚“ ã›ã„ã‹ã„ï¼" : "ã‚ˆããŒã‚“ã°ã£ãŸã­ï¼";
            
            document.getElementById('result-score').innerHTML = 
                `ã‚¹ã‚³ã‚¢: <strong>${finalScore}</strong> ç‚¹<br>` +
                `<span style="font-size:0.9rem; color:#555;">(ã‚¿ã‚¤ãƒ : ${elapsedSec}ã³ã‚‡ã† / ãƒŸã‚¹: ${totalMistakeCount}ã‹ã„)</span>`;

            // èŠ±å¹é›ª
            if (finalScore >= config.starThresholds.star3) {
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#8BC34A', '#FFCA28', '#FFFFFF']
                });
            }

            saveData(finalScore, stars, elapsedSec);
        }

        function saveData(score, stars, elapsedSec) {
            // åˆè¨ˆã‚¯ãƒªã‚¢å›æ•°
            const total = parseInt(localStorage.getItem(KEY_CLEAR) || 0) + 1;
            localStorage.setItem(KEY_CLEAR, total);

            // æœ¬æ—¥ã‚¯ãƒªã‚¢å›æ•°
            const todayKey = KEY_DAILY_PREFIX + new Date().toLocaleDateString('ja-JP');
            const daily = parseInt(localStorage.getItem(todayKey) || 0) + 1;
            localStorage.setItem(todayKey, daily);

            // ãƒã‚¤ã‚¹ã‚³ã‚¢
            const oldHigh = parseInt(localStorage.getItem(KEY_HS) || 0);
            if (score > oldHigh) {
                localStorage.setItem(KEY_HS, score);
            }

            // å±¥æ­´ä¿å­˜ (YYYY/MM/DD HH:mm, timeä»˜ã)
            const history = JSON.parse(localStorage.getItem(KEY_HISTORY) || '[]');
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth()+1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            const dateStr = `${yyyy}/${mm}/${dd} ${hh}:${min}`;
            
            history.unshift({
                date: dateStr,
                score: score,
                stars: stars,
                time: elapsedSec
            });
            
            if (history.length > 5) history.pop();
            localStorage.setItem(KEY_HISTORY, JSON.stringify(history));

            loadStats();
            updateHistoryDisplay();
        }

        function resetRank() {
            if(confirm("ãƒã‚¤ã‚¹ã‚³ã‚¢ã¨ã€€ãƒ©ãƒ³ã‚¯ã‚’ã€€ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem(KEY_HS);
                alert("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
                location.reload();
            }
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        init();
    })();
    </script>
</body>
</html>