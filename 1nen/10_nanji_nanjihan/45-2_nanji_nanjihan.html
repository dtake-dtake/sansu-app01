<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãªã‚“ã˜ãƒ»ãªã‚“ã˜ã¯ã‚“ï¼ˆ5å•ï¼‹ã‚¹ã‚³ã‚¢ï¼‰</title>
  <link rel="stylesheet" href="common.css" />
  <style>
    /* æ™‚è¨ˆUIï¼ˆæ—¢å­˜ãƒ™ãƒ¼ã‚¹ï¼‰ */
    #wrap{max-width:1100px;margin:0 auto;background:#fff;border:2px solid #ccc;box-shadow:3px 3px 8px rgba(0,0,0,.2);padding:18px;border-radius:14px}
    .topRow{display:grid;grid-template-columns:minmax(420px,1fr) 360px;gap:24px;align-items:start}
    .qbox{border:3px solid #39b0a5;border-radius:12px;padding:18px;line-height:2;font-size:2.2rem;background:#fbfffd}
    .rightBox{display:flex;flex-direction:column;align-items:center}
    .label{font-size:2.2rem;margin-bottom:8px}

    /* æ™‚è¨ˆ */
    .clock{width:320px;aspect-ratio:1/1;margin:0 auto}
    .face{fill:#fff;stroke:#58a3d3;stroke-width:10}
    .tick-min{stroke:#89bedd;stroke-width:2}
    .tick-hr{stroke:#4a93bf;stroke-width:4}
    .num{font-size:22px;fill:#222;text-anchor:middle;dominant-baseline:middle}
    .hand-min{stroke:#ff7f2a;stroke-width:8;stroke-linecap:round;transform-origin:160px 160px}
    .hand-hr{stroke:#111;stroke-width:10;stroke-linecap:round;transform-origin:160px 160px}
    .pin{fill:#ed4a38}

    /* è§£ç­”æ¬„ */
    .answerBox{margin-top:18px;text-align:center;font-size:2.2rem}
    .field{width:120px;font-size:2.8rem;padding:10px 12px;text-align:right;margin:0 8px;border:2px solid #bbb;border-radius:10px;background:#fff}
    .selectField{min-width:180px;font-size:2.4rem;padding:8px 12px;margin-left:8px;border:2px solid #bbb;border-radius:10px;background:#fff}
    .field:focus,.selectField:focus{outline:none;border-color:#2cc4ff;box-shadow:0 0 0 3px rgba(44,196,255,.2)}
    .incorrect{border-color:#d32f2f !important;background:#ffecec}
    .correct{border-color:#0a7a00 !important;background:#f1fff1}
    .btns{margin-top:14px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap}

    /* ãƒã‚¤ãƒ†ã‚£ãƒ–selectã®ç°¡æ˜“ã€Œå¼·åˆ¶ã‚ªãƒ¼ãƒ—ãƒ³ã€ç”¨ */
    select[size]{padding:6px 10px;}

    /* ç´™å¹é›ªã‚­ãƒ£ãƒ³ãƒã‚¹ */
    #confetti-canvas{position:fixed;inset:0;pointer-events:none;z-index:9999;display:none;}
/* â˜…è¿½åŠ ï¼šå•é¡Œæ å†…ã®ã‚¹ã‚³ã‚¢è¡Œã‚’éš ã™ */
#scoreLine { display: none !important; }

  </style>
</head>
<body>
  <h1 id="main-title">ï¼‘ï¼ã€€ãªã‚“ã˜ã€€ãªã‚“ã˜ã¯ã‚“</h1>
  <h2 id="sub-title">ã¨ã‘ã„ã®ã€€ã‚ˆã¿ã‹ãŸ</h2>

  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆ -->
  <div id="start-area" style="text-align:center; margin:40px 0;">
    <button id="start-btn" autofocus>ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
  </div>

  <!-- å•é¡Œ -->
  <div id="problems-section" style="display:none;">
    <div id="problems-wrapper">
      <div id="wrap">
        <div class="topRow">
          <div class="qbox">
            <div id="qText">ã¨ã‘ã„ã¯ <strong>ãªã‚“ã˜ï¼Ÿãªã‚“ã˜ã¯ã‚“ï¼Ÿ</strong></div>
            <div id="progress"   style="margin-top:8px;color:#1e88e5;font-weight:bold;"></div>
            <!-- â˜…ã‚¹ã‚³ã‚¢è¡Œï¼ˆãƒ™ãƒ¼ã‚¹ç‚¹ã®ã¿ã€100ç‚¹æº€ç‚¹ï¼‰ -->
            <div id="scoreLine" style="margin-top:4px;color:#00695c;font-weight:bold;">
              ã‚¹ã‚³ã‚¢ï¼š<span id="scoreValue">0</span> / 100
            </div>
          </div>
          <div class="rightBox">
            <div class="label">ã¨ã‘ã„</div>
            <svg class="clock" id="clock"></svg>
          </div>
        </div>

        <div class="answerBox" aria-label="è§£ç­”æ¬„">
          ç­”ãˆï¼š <input id="ansH" class="field" type="number" inputmode="numeric" min="1" max="12" aria-label="æ™‚"> æ™‚
          <select id="kindSelect" class="selectField" aria-label="ã˜ï¼ã˜ã¯ã‚“">
            <option value="" selected disabled>ãˆã‚‰ã‚“ã§ã­ â–¾</option>
            <option value="just">ã˜</option>
            <option value="half">ã˜ã¯ã‚“</option>
          </select>
          <div class="btns">
            <button id="checkBtn" class="primary">ã¾ã‚‹ã¤ã‘</button>
            <button id="nextBtn" disabled>æ¬¡ã®å•é¡Œ</button>
          </div>
          <div id="perQuestionResult" style="margin-top:8px;font-weight:bold;"></div>
        </div>
      </div>
    </div>
    <div class="button-area">
      <button id="retry">ã‚‚ã†ã„ã¡ã©</button>
    </div>
  </div>

  <!-- çµæœï¼ã‚«ã‚¦ãƒ³ã‚¿ï¼ˆå…±é€šã‚µãƒ³ãƒ—ãƒ«æº–æ‹ ã®IDæ§‹æˆï¼‰ -->
  <div id="result-area">
    <div id="result"></div>
    <div id="highScoreArea">ãƒã‚¤ã‚¹ã‚³ã‚¢ï¼š<span id="highScoreValue">0</span> ã¦ã‚“</div>
    <div id="dailyCountArea">ä»Šæ—¥ã®ã‚¯ãƒªã‚¢ï¼š<span id="dailyCountValue">0</span> ã‹ã„</div>
    <div id="monthlyCountArea">ä»Šæœˆã®ã‚¯ãƒªã‚¢ï¼š<span id="monthlyCountValue">0</span> ã‹ã„</div>
    <div id="clearCountArea">åˆè¨ˆã‚¯ãƒªã‚¢ï¼š<span id="clearCountValue">0</span> ã‹ã„</div>
    <div id="history-area">ã‚Šã‚Œãï¼ˆï¼‘ï¼ä»¶ï¼‰<br><ul id="history-list"></ul></div>
  </div>

  <!-- ç´™å¹é›ªç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
  <canvas id="confetti-canvas"></canvas>

<script>
/* ========= ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ï¼ˆå…±é€šã‚µãƒ³ãƒ—ãƒ«ã¨äº’æ›ï¼‰ ========= */
const APP_ID = "1nen-nanji-nanjihan-v1";
const KEY_HS             = `${APP_ID}:hs`;
const KEY_HISTORY        = `${APP_ID}:history`;
const KEY_CLEAR          = `${APP_ID}:clearCount`;
const KEY_MONTHLY_PREFIX = `${APP_ID}:monthlyClear-`;
const KEY_DAILY_PREFIX   = `${APP_ID}:dailyClear-`;

/* ========= ã‚«ã‚¦ãƒ³ã‚¿ï¼ã‚¹ã‚³ã‚¢é–¢é€£ ========= */
let totalClear = 0, monthly = 0, daily = 0, highScore = 0;
function loadPersistent(){
  const today = new Date().toISOString().slice(0,10);
  const month = new Date().toISOString().slice(0,7);
  highScore   = +(localStorage.getItem(KEY_HS) || 0);
  totalClear  = +(localStorage.getItem(KEY_CLEAR)||0);
  monthly     = +(localStorage.getItem(KEY_MONTHLY_PREFIX+month)||0);
  daily       = +(localStorage.getItem(KEY_DAILY_PREFIX+today)||0);
}
function savePersistent(){
  const today = new Date().toISOString().slice(0,10);
  const month = new Date().toISOString().slice(0,7);
  localStorage.setItem(KEY_HS, String(highScore));
  localStorage.setItem(KEY_CLEAR, String(totalClear));
  localStorage.setItem(KEY_MONTHLY_PREFIX+month, String(monthly));
  localStorage.setItem(KEY_DAILY_PREFIX+today, String(daily));
}
function saveHistoryScore(score){
  const h = JSON.parse(localStorage.getItem(KEY_HISTORY)||'[]');
  h.unshift({ datetime: new Date().toLocaleString(), score });
  if(h.length>10) h.pop();
  localStorage.setItem(KEY_HISTORY, JSON.stringify(h));
}
function refreshHeaderUI(){
  document.getElementById('highScoreValue').textContent   = highScore;
  document.getElementById('clearCountValue').textContent   = totalClear;
  document.getElementById('monthlyCountValue').textContent = monthly;
  document.getElementById('dailyCountValue').textContent   = daily;
  const h = JSON.parse(localStorage.getItem(KEY_HISTORY)||'[]');
  document.getElementById('history-list').innerHTML = h.map(x=>`<li>${x.datetime}ï¼š${x.score}ã¦ã‚“</li>`).join('');
}

/* ========= å•é¡Œãƒ»UIè¦ç´  ========= */
const qText       = document.getElementById("qText");
const progressEl  = document.getElementById("progress");
const scoreValue  = document.getElementById("scoreValue");
const ansH        = document.getElementById("ansH");
const kindSelect  = document.getElementById("kindSelect");
const checkBtn    = document.getElementById("checkBtn");
const nextBtn     = document.getElementById("nextBtn");
const perResult   = document.getElementById("perQuestionResult");
const startBtn    = document.getElementById("start-btn");
const startArea   = document.getElementById("start-area");
const problemsSec = document.getElementById("problems-section");
const retryBtn    = document.getElementById("retry");
const resultBox   = document.getElementById("result");

const clock = buildClock(document.getElementById("clock"));

/* ========= ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®š ========= */
const TOTAL = 5;
// 35-2å¼: åˆè¨ˆ = 100 + (ã‚¯ãƒªã‚¢ã‚¿ã‚¤ãƒ  / è¨­å®šã‚¿ã‚¤ãƒ ) Ã— 100
// 1å•ã‚ãŸã‚Šã®ã€Œè¨­å®šã‚¿ã‚¤ãƒ ã€ï¼ˆç§’ï¼‰ã‚’æ±ºã‚ã‚‹ã€‚ä¾‹: 8ç§’/å• â†’ å…¨ä½“ã§ 40ç§’
const TIME_LIMIT_PER_Q = 8;  // â†ãŠå¥½ã¿ã§ 6ã€œ10 ã«èª¿æ•´

let idx = 0, problem = null, startTime = 0, wrongTotal = 0;
let sessionScore = 0, currentMistakes = 0;

function randPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function createProblem(){
  const hour = randPick([1,2,3,4,5,6,7,8,9,10,11,12]);
  const isHalf = Math.random() < 0.5;
  const m = isHalf ? 30 : 0;
  return { h: hour, m, isHalf, answerH: hour, answerKind: isHalf ? "half" : "just" };
}

function renderNew(){
  problem = createProblem();
  clock.setTime(problem.h, problem.m);
  qText.innerHTML = `ã¨ã‘ã„ã¯ <strong>ãªã‚“ã˜ï¼Ÿãªã‚“ã˜ã¯ã‚“ï¼Ÿ</strong>`;
  progressEl.textContent = `ã®ã“ã‚Šã€€${TOTAL-idx}ã‚‚ã‚“`;

  currentMistakes = 0;
  ansH.value=""; kindSelect.value="";
  ansH.classList.remove("incorrect","correct");
  kindSelect.classList.remove("incorrect","correct");
  perResult.textContent=""; nextBtn.disabled=true;

  setTimeout(()=>ansH.focus(),0);
}

function check(){
  ansH.classList.remove("incorrect","correct");
  kindSelect.classList.remove("incorrect","correct");
  const h = Number(ansH.value.trim());
  const kind = kindSelect.value;
  let okForm = true;
  if(!Number.isInteger(h) || h<1 || h>12){ okForm=false; ansH.classList.add("incorrect"); }
  if(kind !== "just" && kind !== "half"){ okForm=false; kindSelect.classList.add("incorrect"); }
  if(!okForm){
    perResult.textContent="æ•°å­—ã‚’å…¥ã‚Œã¦ã€ã©ã¡ã‚‰ã‹é¸ã‚“ã§ã­ã€‚";
    perResult.style.color="#b20000"; nextBtn.disabled=true;
    if(ansH.classList.contains("incorrect")){ ansH.focus(); ansH.select(); } else { kindSelect.focus(); }
    return;
  }
  const ok = (h===problem.answerH) && (kind===problem.answerKind);
  if(ok){
    // å¾—ç‚¹åŠ ç®—ï¼šä¸€ç™ºæ­£è§£20ã€1ãƒŸã‚¹15ã€2ãƒŸã‚¹10ã€3ãƒŸã‚¹ä»¥ä¸Š5
    //const gained = Math.max(MIN_PER_Q, MAX_PER_Q - PENALTY*currentMistakes);
    //sessionScore += gained;
    //scoreValue.textContent = sessionScore;

    perResult.textContent="ã€‡ ã›ã„ã‹ã„ï¼ã€Œæ¬¡ã®å•é¡Œã€ã‚’æŠ¼ã—ã¦ã­ã€‚";
    perResult.style.color="#0a7a00";
    ansH.classList.add("correct"); kindSelect.classList.add("correct");
    nextBtn.disabled=false; nextBtn.focus();
  }else{
    currentMistakes++; wrongTotal++;
    perResult.textContent="Ã— ã‚‚ã†ã„ã¡ã©è€ƒãˆã‚ˆã†ã€‚";
    perResult.style.color="#b20000";
    if(h!==problem.answerH) ansH.classList.add("incorrect");
    if(kind!==problem.answerKind) kindSelect.classList.add("incorrect");
    nextBtn.disabled=true;
    if(h!==problem.answerH){ ansH.focus(); ansH.select(); } else { kindSelect.focus(); }
  }
}

function next(){
  if(nextBtn.disabled) return; // æ­£è§£ã—ãªã„ã¨é€²ã‚ãªã„
  idx++;
  if(idx < TOTAL){ renderNew(); }
  else { finishSession(); }
}

function finishSession(){
const elapsed = (Date.now() - startTime) / 1000;          // ã‚¯ãƒªã‚¢ã‚¿ã‚¤ãƒ (ç§’)
const timeLimit = TOTAL * TIME_LIMIT_PER_Q;                // è¨­å®šã‚¿ã‚¤ãƒ (ç§’)
const baseScore = TOTAL * 20;                              // 100ç‚¹å›ºå®š
const timeBonus = Math.floor((elapsed / timeLimit) * 100); // (çµŒé/è¨­å®š)Ã—100
const total = baseScore + timeBonus;

const isNewHS = total > highScore;
if (isNewHS) { highScore = total; }
  // â˜…ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨å¤‰æ•°ã‚’ç¢ºå®Ÿã«+1
  incrementClearCounters();
savePersistent();
saveHistoryScore(total);
refreshHeaderUI();
function incrementClearCounters() {
  const today = new Date().toISOString().slice(0,10);
  const month = new Date().toISOString().slice(0,7);

  // ç¾åœ¨å€¤ã‚’ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿ç›´ã—ã¦ +1
  const total = +(localStorage.getItem(KEY_CLEAR) || 0) + 1;
  const m     = +(localStorage.getItem(KEY_MONTHLY_PREFIX + month) || 0) + 1;
  const d     = +(localStorage.getItem(KEY_DAILY_PREFIX   + today) || 0) + 1;

  // ä¿å­˜
  localStorage.setItem(KEY_CLEAR, String(total));
  localStorage.setItem(KEY_MONTHLY_PREFIX + month, String(m));
  localStorage.setItem(KEY_DAILY_PREFIX   + today, String(d));

  // ãƒ¡ãƒ¢ãƒªä¸Šã®å¤‰æ•°ã‚‚åŒæœŸï¼ˆrefreshHeaderUI ã¯ã“ã®å€¤ã‚’è¡¨ç¤ºã«ä½¿ã£ã¦ã‚‹ï¼‰
  totalClear = total;
  monthly    = m;
  daily      = d;
}


  // çµæœè¡¨ç¤ºï¼ˆå‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«ã®æ›¸å¼ï¼‰
  resultBox.innerHTML =
    `ğŸ‰ å…¨å•æ­£è§£ï¼ ãŠã‚ã§ã¨ã†ï¼ ğŸ‰<br>` +
    `ã‚¹ã‚³ã‚¢: <strong>${total}ç‚¹</strong> (ã‚¿ã‚¤ãƒ : <strong>${elapsed.toFixed(1)}</strong> ç§’)` +
    (isNewHS ? `<br><span style="color:#e53935;font-weight:bold;">âœ¨ ãƒã‚¤ã‚¹ã‚³ã‚¢æ›´æ–°ï¼</span>` : ``);
  // è¦‹ãŸç›®ã‚’è¿‘ã¥ã‘ãŸã„å ´åˆï¼ˆä»»æ„ï¼‰
  resultBox.style.color = '#d32f2f';   // èµ¤ç³»
  resultBox.style.fontWeight = '700';

  // ç´™å¹é›ª
  celebrate(isNewHS ? 2200 : 1500);

  // ç”»é¢æˆ»ã—
  startArea.style.display=""; problemsSec.style.display="none";
}

function start(){
  idx=0; wrongTotal=0; sessionScore=0; currentMistakes=0;
  scoreValue.textContent = '0';
  startTime = Date.now();
  startArea.style.display="none"; problemsSec.style.display="block";
  renderNew();
}

function retry(){ start(); }

/* ========= ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æŒ™å‹• ========= */
window.addEventListener('DOMContentLoaded', ()=>{ try{ startBtn.focus(); }catch(e){} });
startBtn.addEventListener("click", start);
startBtn.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); start(); } });

ansH.addEventListener("input", ()=>{ ansH.classList.remove("incorrect","correct"); perResult.textContent=""; nextBtn.disabled=true; });
ansH.addEventListener("keydown", e=>{
  if(e.key==="ArrowUp"||e.key==="ArrowDown"){ e.preventDefault(); }
  if(e.key==="Enter"||e.key==="ArrowRight"||e.key==="ArrowDown"){ e.preventDefault(); openSelectDropdown(kindSelect); kindSelect.focus(); }
});

function openSelectDropdown(sel){
  if(typeof sel.showPicker === "function"){ try{ sel.showPicker(); return; }catch(e){} }
  if(!sel.hasAttribute('size')) sel.setAttribute('size', sel.options.length);
}
function closeSelectDropdown(sel){ if(sel.hasAttribute('size')) sel.removeAttribute('size'); }

kindSelect.addEventListener("focus", ()=>{
  openSelectDropdown(kindSelect);
  if(kindSelect.value===""){ kindSelect.selectedIndex = 1; } // ã˜
});
kindSelect.addEventListener("keydown", e=>{
  if(e.key==="ArrowDown"){ openSelectDropdown(kindSelect); }
  else if(e.key==="Escape"){ closeSelectDropdown(kindSelect); e.preventDefault(); }
  else if(e.key==="Enter"){ closeSelectDropdown(kindSelect); e.preventDefault(); checkBtn.focus(); }
  else if(e.key==="ArrowLeft"||e.key==="ArrowRight"){
    if(kindSelect.value==="" || kindSelect.selectedIndex===0){ kindSelect.value="just"; }
    else if(kindSelect.value==="just"){ kindSelect.value="half"; }
    else{ kindSelect.value="just"; }
    e.preventDefault();
  }
});
kindSelect.addEventListener("change", ()=>{ kindSelect.classList.remove("incorrect","correct"); perResult.textContent=""; nextBtn.disabled=true; closeSelectDropdown(kindSelect); });
kindSelect.addEventListener("blur", ()=> closeSelectDropdown(kindSelect));

/* ========= æ™‚è¨ˆæç”» ========= */
function buildClock(svg){
  const NS="http://www.w3.org/2000/svg"; const C=160, R=130;
  svg.setAttribute("viewBox","0 0 320 320");
  const face=document.createElementNS(NS,"circle");
  face.setAttribute("cx",C); face.setAttribute("cy",C); face.setAttribute("r",R); face.setAttribute("class","face"); svg.appendChild(face);
  for(let i=0;i<60;i++){
    const ang=(Math.PI*2)*(i/60)-Math.PI/2, r1=i%5===0?R-12:R-8, r2=R-2;
    const l=document.createElementNS(NS,"line");
    l.setAttribute("x1",C+r1*Math.cos(ang)); l.setAttribute("y1",C+r1*Math.sin(ang));
    l.setAttribute("x2",C+r2*Math.cos(ang)); l.setAttribute("y2",C+r2*Math.sin(ang));
    l.setAttribute("class", i%5===0?"tick-hr":"tick-min"); svg.appendChild(l);
  }
  for(let n=1;n<=12;n++){
    const ang=(Math.PI*2)*(n/12)-Math.PI/2, t=document.createElementNS(NS,"text");
    t.setAttribute("x",C+(R-34)*Math.cos(ang)); t.setAttribute("y",C+(R-34)*Math.sin(ang));
    t.setAttribute("class","num"); t.textContent=n; svg.appendChild(t);
  }
  const handHr=document.createElementNS(NS,"line");
  handHr.setAttribute("x1",C); handHr.setAttribute("y1",C); handHr.setAttribute("x2",C); handHr.setAttribute("y2",C-72);
  handHr.setAttribute("class","hand-hr"); svg.appendChild(handHr);
  const handMin=document.createElementNS(NS,"line");
  handMin.setAttribute("x1",C); handMin.setAttribute("y1",C); handMin.setAttribute("x2",C); handMin.setAttribute("y2",C-100);
  handMin.setAttribute("class","hand-min"); svg.appendChild(handMin);
  const pin=document.createElementNS(NS,"circle");
  pin.setAttribute("cx",C); pin.setAttribute("cy",C); pin.setAttribute("r",5); pin.setAttribute("class","pin"); svg.appendChild(pin);
  return {
    setTime(h,m){
      const hrDeg=((h%12)*30)+(m*0.5); const minDeg=m*6;
      handHr.style.transform=`rotate(${hrDeg}deg)`; handMin.style.transform=`rotate(${minDeg}deg)`;
    }
  };
}

/* ========= ç´™å¹é›ªï¼ˆå†…è”µãƒ»2ç§’ï¼‰ ========= */
function celebrate(durationMs=30000){
  const cvs = document.getElementById('confetti-canvas');
  const ctx = cvs.getContext('2d');
  const W = cvs.width = window.innerWidth;
  const H = cvs.height = window.innerHeight;
  cvs.style.display = 'block';

  const N = 180, G = 0.15; // ç²’æ•° / é‡åŠ›
  const parts = Array.from({length:N}, ()=>({
    x: Math.random()*W,
    y: -20 - Math.random()*H*0.3,
    vx: (Math.random()-0.5)*3,
    vy: 1 + Math.random()*2,
    r: 4 + Math.random()*6,
    rot: Math.random()*Math.PI*2,
    vr: (Math.random()-0.5)*0.2,
    s: Math.random()*0.7+0.3 // è½ä¸‹ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¹ã‚±ãƒ¼ãƒ«
  }));
  let t0 = performance.now();
  (function loop(t){
    const dt = (t - t0)/16.7; t0 = t;
    ctx.clearRect(0,0,W,H);
    for(const p of parts){
      p.vy += G*0.1; p.x += p.vx; p.y += p.vy*p.s; p.rot += p.vr;
      if(p.y > H+30){ p.y = -20; p.x = Math.random()*W; p.vy = 1 + Math.random()*2; }
      // ç°¡æ˜“è‰²
      ctx.save();
      ctx.translate(p.x,p.y); ctx.rotate(p.rot);
      ctx.fillStyle = `hsl(${(p.x/W)*360},90%,60%)`;
      ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r);
      ctx.restore();
    }
    if(loop.stopAt && performance.now() > loop.stopAt){ cvs.style.display = 'none'; return; }
    requestAnimationFrame(loop);
  })(performance.now());

}

/* ========= èµ·å‹• ========= */
loadPersistent(); refreshHeaderUI();
startBtn.addEventListener("click", start);
retryBtn.addEventListener("click", start);

/* â˜… è¿½åŠ ï¼šã¾ã‚‹ã¤ã‘ï¼æ¬¡ã®å•é¡Œ ãƒœã‚¿ãƒ³ã®æŒ™å‹• */
checkBtn.addEventListener("click", check);
checkBtn.addEventListener("keydown", (e)=>{ 
  if(e.key==="Enter"||e.key===" "){ e.preventDefault(); check(); }
});
nextBtn.addEventListener("click", next);
</script>
</body>
</html>
