<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>なんじ・なんじはん（5問＋スコア）</title>
  <!-- 既存の共通CSSを使っている場合はこのまま -->
  <link rel="stylesheet" href="common.css" />
  <style>
    /* 時計UI（既存ベース） */
    #wrap{max-width:1100px;margin:0 auto;background:#fff;border:2px solid #ccc;box-shadow:3px 3px 8px rgba(0,0,0,.2);padding:18px;border-radius:14px}
    .topRow{display:grid;grid-template-columns:minmax(420px,1fr) 360px;gap:24px;align-items:start}
    .qbox{border:3px solid #39b0a5;border-radius:12px;padding:18px;line-height:2;font-size:2.2rem;background:#fbfffd}
    .rightBox{display:flex;flex-direction:column;align-items:center}
    .label{font-size:2.2rem;margin-bottom:8px}

    /* 時計 */
    .clock{width:320px;aspect-ratio:1/1;margin:0 auto}
    .face{fill:#fff;stroke:#58a3d3;stroke-width:10}
    .tick-min{stroke:#89bedd;stroke-width:2}
    .tick-hr{stroke:#4a93bf;stroke-width:4}
    .num{font-size:22px;fill:#222;text-anchor:middle;dominant-baseline:middle}
    .hand-min{stroke:#ff7f2a;stroke-width:8;stroke-linecap:round;transform-origin:160px 160px}
    .hand-hr{stroke:#111;stroke-width:10;stroke-linecap:round;transform-origin:160px 160px}
    .pin{fill:#ed4a38}

    /* 解答欄 */
    .answerBox{margin-top:18px;text-align:center;font-size:2.2rem}
    .field{width:120px;font-size:2.8rem;padding:10px 12px;text-align:right;margin:0 8px;border:2px solid #bbb;border-radius:10px;background:#fff}
    .selectField{min-width:180px;font-size:2.4rem;padding:8px 12px;margin-left:8px;border:2px solid #bbb;border-radius:10px;background:#fff}
    .field:focus,.selectField:focus{outline:none;border-color:#2cc4ff;box-shadow:0 0 0 3px rgba(44,196,255,.2)}
    .incorrect{border-color:#d32f2f !important;background:#ffecec}
    .correct{border-color:#0a7a00 !important;background:#f1fff1}
    .btns{margin-top:14px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap}

    /* ネイティブselectの簡易「強制オープン」用 */
    select[size]{padding:6px 10px;}

    /* 紙吹雪キャンバス */
    #confetti-canvas{position:fixed;inset:0;pointer-events:none;z-index:9999;display:none;}

    /* 既定のスコア行は非表示に（参考表示のみ） */
    #scoreLine { display: none !important; }

    /* ヘッダの統計表示 */
    #statsBox{
      display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:16px 0;
      font-size:1.6rem; text-align:center;
    }
    #statsBox .stat{background:#f1faff;border:1px solid #bfe4ff;border-radius:10px;padding:6px 8px}
    #result{margin-top:20px;text-align:center;font-size:2.2rem}
  </style>
</head>
<body>
  <h1 id="main-title">１０　なんじ　なんじはん</h1>
  <h2 id="sub-title">とけいの　よみかた</h2>

  <!-- スタート -->
  <div id="start-area" style="text-align:center; margin:20px 0;">
    <button id="start-btn" autofocus>スタート！</button>
  </div>

  <!-- クリア回数・HS・履歴 -->
  <div id="statsBox" aria-label="記録エリア">
    <div class="stat">HS: <span id="highScoreValue">0</span></div>
    <div class="stat">クリア回数: <span id="clearCountValue">0</span></div>
    <div class="stat">今月: <span id="monthlyCountValue">0</span></div>
    <div class="stat">今日: <span id="dailyCountValue">0</span></div>
  </div>

  <!-- 問題 -->
  <div id="problems-section" style="display:none;">
    <div id="problems-wrapper">
      <div id="wrap">
        <div class="topRow">
          <div class="qbox">
            <div id="qText">とけいは <strong>なんじ？なんじはん？</strong></div>
            <div id="progress"   style="margin-top:8px;color:#1e88e5;font-weight:bold;"></div>
            <!-- スコア行（ベース点のみ、100点満点） -->
            <div id="scoreLine" style="margin-top:4px;color:#00695c;font-weight:bold;">
              スコア：<span id="scoreValue">0</span> / 100
            </div>
          </div>
          <div class="rightBox">
            <div class="label">とけい</div>
            <svg class="clock" id="clock" aria-label="時計表示"></svg>
          </div>
        </div>

        <div class="answerBox" aria-label="解答欄">
          答え： <input id="ansH" class="field" type="number" inputmode="numeric" min="1" max="12" aria-label="時"> 時
          <select id="kindSelect" class="selectField" aria-label="じ／じはん">
            <option value="" selected disabled>えらんでね ▾</option>
            <option value="just">じ</option>
            <option value="half">じはん</option>
          </select>
          <div class="btns">
            <button id="checkBtn">まるつけ</button>
            <button id="nextBtn" disabled>次の問題</button>
            <button id="retry">もう一度</button>
          </div>
          <div id="perQuestionResult" style="margin-top:10px;"></div>
        </div>

        <div id="result"></div>

        <div id="history-area" style="margin-top:18px">
          りれき（１０件）<br>
          <ul id="history-list" style="margin:6px 0 0 18px"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- 紙吹雪用キャンバス -->
  <canvas id="confetti-canvas"></canvas>

<script>
/* ========= ストレージキー（共通サンプルと互換） ========= */
/* ★ ここを app_data.json の id と完全一致にする（重要） */
const APP_ID = "1n-nanji-nanjihan";

const KEY_HS             = `${APP_ID}:hs`;
const KEY_HISTORY        = `${APP_ID}:history`;
const KEY_CLEAR          = `${APP_ID}:clearCount`;
const KEY_MONTHLY_PREFIX = `${APP_ID}:monthlyClear-`;
const KEY_DAILY_PREFIX   = `${APP_ID}:dailyClear-`;

/* ========= カウンタ／スコア関連 ========= */
let totalClear = 0, monthly = 0, daily = 0, highScore = 0;

function loadPersistent(){
  const today = new Date().toISOString().slice(0,10);
  const month = new Date().toISOString().slice(0,7);
  highScore   = +(localStorage.getItem(KEY_HS) || 0);
  totalClear  = +(localStorage.getItem(KEY_CLEAR)||0);
  monthly     = +(localStorage.getItem(KEY_MONTHLY_PREFIX+month)||0);
  daily       = +(localStorage.getItem(KEY_DAILY_PREFIX+today)||0);
}
function savePersistent(){
  const today = new Date().toISOString().slice(0,10);
  const month = new Date().toISOString().slice(0,7);
  localStorage.setItem(KEY_HS, String(highScore));
  localStorage.setItem(KEY_CLEAR, String(totalClear));
  localStorage.setItem(KEY_MONTHLY_PREFIX+month, String(monthly));
  localStorage.setItem(KEY_DAILY_PREFIX+today, String(daily));
}
function saveHistoryScore(score){
  const h = JSON.parse(localStorage.getItem(KEY_HISTORY)||'[]');
  h.unshift({ datetime: new Date().toLocaleString(), score });
  if(h.length>10) h.pop();
  localStorage.setItem(KEY_HISTORY, JSON.stringify(h));
}
function refreshHeaderUI(){
  document.getElementById('highScoreValue').textContent   = highScore;
  document.getElementById('clearCountValue').textContent   = totalClear;
  document.getElementById('monthlyCountValue').textContent = monthly;
  document.getElementById('dailyCountValue').textContent   = daily;
  const h = JSON.parse(localStorage.getItem(KEY_HISTORY)||'[]');
  document.getElementById('history-list').innerHTML =
    h.map(x=>`<li>${x.datetime}：${x.score}てん</li>`).join('');
}

/* ========= 問題・UI要素 ========= */
const qText       = document.getElementById("qText");
const progressEl  = document.getElementById("progress");
const scoreValue  = document.getElementById("scoreValue");
const ansH        = document.getElementById("ansH");
const kindSelect  = document.getElementById("kindSelect");
const checkBtn    = document.getElementById("checkBtn");
const nextBtn     = document.getElementById("nextBtn");
const perResult   = document.getElementById("perQuestionResult");
const startBtn    = document.getElementById("start-btn");
const startArea   = document.getElementById("start-area");
const problemsSec = document.getElementById("problems-section");
const retryBtn    = document.getElementById("retry");
const resultBox   = document.getElementById("result");

const clock = buildClock(document.getElementById("clock"));

/* ========= セッション設定 ========= */
const TOTAL = 5;
// 35-2式: 合計 = 100 + (クリアタイム / 設定タイム) × 100
// 1問あたりの「設定タイム」（秒）を決める。例: 8秒/問 → 全体で 40秒
const TIME_LIMIT_PER_Q = 8;  // ←お好みで 6〜10 に調整

let idx = 0, problem = null, startTime = 0, wrongTotal = 0;
let sessionScore = 0, currentMistakes = 0;

function randPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function createProblem(){
  const hour = randPick([1,2,3,4,5,6,7,8,9,10,11,12]);
  const isHalf = Math.random() < 0.5;
  const m = isHalf ? 30 : 0;
  return { h: hour, m, isHalf, answerH: hour, answerKind: isHalf ? "half" : "just" };
}

function renderNew(){
  problem = createProblem();
  clock.setTime(problem.h, problem.m);
  qText.innerHTML = `とけいは <strong>なんじ？なんじはん？</strong>`;
  progressEl.textContent = `のこり　${TOTAL-idx}もん`;

  currentMistakes = 0;
  ansH.value=""; kindSelect.value="";
  ansH.classList.remove("incorrect","correct");
  kindSelect.classList.remove("incorrect","correct");
  perResult.textContent=""; nextBtn.disabled=true;

  setTimeout(()=>ansH.focus(),0);
}

function check(){
  ansH.classList.remove("incorrect","correct");
  kindSelect.classList.remove("incorrect","correct");
  const h = Number(ansH.value.trim());
  const kind = kindSelect.value;
  let okForm = true;
  if(!Number.isInteger(h) || h<1 || h>12){ okForm=false; ansH.classList.add("incorrect"); }
  if(kind !== "just" && kind !== "half"){ okForm=false; kindSelect.classList.add("incorrect"); }
  if(!okForm){
    perResult.textContent="数字を入れて、どちらか選んでね。";
    perResult.style.color="#b20000"; nextBtn.disabled=true;
    if(ansH.classList.contains("incorrect")){ ansH.focus(); ansH.select(); } else { kindSelect.focus(); }
    return;
  }
  const ok = (h===problem.answerH) && (kind===problem.answerKind);
  if(ok){
    perResult.textContent="〇 せいかい！「次の問題」を押してね。";
    perResult.style.color="#0a7a00";
    ansH.classList.add("correct"); kindSelect.classList.add("correct");
    nextBtn.disabled=false; nextBtn.focus();
  }else{
    currentMistakes++; wrongTotal++;
    perResult.textContent="× もういちど考えよう。";
    perResult.style.color="#b20000";
    if(h!==problem.answerH) ansH.classList.add("incorrect");
    if(kind!==problem.answerKind) kindSelect.classList.add("incorrect");
    nextBtn.disabled=true;
    if(h!==problem.answerH){ ansH.focus(); ansH.select(); } else { kindSelect.focus(); }
  }
}

function next(){
  if(nextBtn.disabled) return; // 正解しないと進めない
  idx++;
  if(idx < TOTAL){ renderNew(); }
  else { finishSession(); }
}

/* スコア→★ 変換（閾値は運用に合わせて調整可） */
function starsFromScore(s){
  if (s >= 180) return "★★★★★";
  if (s >= 160) return "★★★★☆";
  if (s >= 140) return "★★★☆☆";
  if (s >= 120) return "★★☆☆☆";
  if (s >= 100) return "★☆☆☆☆";
  return "―";
}

function finishSession(){
  const elapsed = (Date.now() - startTime) / 1000;          // クリアタイム(秒)
  const timeLimit = TOTAL * TIME_LIMIT_PER_Q;                // 設定タイム(秒)
  const baseScore = TOTAL * 20;                              // 100点固定
  const timeBonus = Math.floor((elapsed / timeLimit) * 100); // (経過/設定)×100
  const total = baseScore + timeBonus;

  const isNewHS = total > highScore;
  if (isNewHS) { highScore = total; }

  // ★ ステータス保存（index の表示に必要）
  const stars = starsFromScore(total);
  localStorage.setItem(`${APP_ID}:status`, stars);
  localStorage.setItem(`${APP_ID}:overallStatus`, stars); // 互換キー

  // クリア回数カウンタを+1
  incrementClearCounters();

  // HS・各種カウンタ・履歴を保存・表示更新
  savePersistent();
  saveHistoryScore(total);
  refreshHeaderUI();

  // 結果表示（参考ファイルの書式）
  resultBox.innerHTML =
    `🎉 全問正解！ おめでとう！ 🎉<br>` +
    `スコア: <strong>${total}点</strong> (タイム: <strong>${elapsed.toFixed(1)}</strong> 秒)` +
    (isNewHS ? `<br><span style="color:#e53935;font-weight:bold;">✨ ハイスコア更新！</span>` : ``);
  resultBox.style.color = '#d32f2f';
  resultBox.style.fontWeight = '700';

  // 紙吹雪
  celebrate(isNewHS ? 2200 : 1500);

  // 画面戻し
  startArea.style.display=""; problemsSec.style.display="none";
}

function incrementClearCounters() {
  const today = new Date().toISOString().slice(0,10);
  const month = new Date().toISOString().slice(0,7);

  const total = +(localStorage.getItem(KEY_CLEAR) || 0) + 1;
  const m     = +(localStorage.getItem(KEY_MONTHLY_PREFIX + month) || 0) + 1;
  const d     = +(localStorage.getItem(KEY_DAILY_PREFIX   + today) || 0) + 1;

  localStorage.setItem(KEY_CLEAR, String(total));
  localStorage.setItem(KEY_MONTHLY_PREFIX + month, String(m));
  localStorage.setItem(KEY_DAILY_PREFIX   + today, String(d));

  totalClear = total; monthly = m; daily = d;
}

function start(){
  idx=0; wrongTotal=0; sessionScore=0; currentMistakes=0;
  scoreValue.textContent = '0';
  startTime = Date.now();
  startArea.style.display="none"; problemsSec.style.display="block";
  renderNew();
}

function retry(){ start(); }

/* ========= フォーカス＆ドロップダウン挙動 ========= */
window.addEventListener('DOMContentLoaded', ()=>{
  try{ startBtn.focus(); }catch(e){}
  loadPersistent();
  refreshHeaderUI();
});
startBtn.addEventListener("click", start);
startBtn.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); start(); } });

ansH.addEventListener("input", ()=>{ ansH.classList.remove("incorrect","correct"); perResult.textContent=""; nextBtn.disabled=true; });
ansH.addEventListener("keydown", e=>{
  if(e.key==="ArrowUp"||e.key==="ArrowDown"){ e.preventDefault(); }
  if(e.key==="Enter"||e.key==="ArrowRight"||e.key==="ArrowDown"){ e.preventDefault(); openSelectDropdown(kindSelect); kindSelect.focus(); }
});
function openSelectDropdown(sel){
  if(typeof sel.showPicker === "function"){ try{ sel.showPicker(); return; }catch(e){} }
  if(!sel.hasAttribute('size')) sel.setAttribute('size', sel.options.length);
}
function closeSelectDropdown(sel){ if(sel.hasAttribute('size')) sel.removeAttribute('size'); }
kindSelect.addEventListener("focus", ()=>{
  openSelectDropdown(kindSelect);
  if(kindSelect.value===""){ kindSelect.selectedIndex = 1; } // じ
});
kindSelect.addEventListener("keydown", e=>{
  if(e.key==="Enter"||e.key===" "||e.key==="ArrowRight"){ e.preventDefault(); checkBtn.focus(); }
});
kindSelect.addEventListener("blur", ()=> closeSelectDropdown(kindSelect));
checkBtn.addEventListener("click", check);
nextBtn.addEventListener("click", next);
retryBtn.addEventListener("click", retry);

/* ========= 時計描画 ========= */
function buildClock(svg){
  const NS = "http://www.w3.org/2000/svg";
  function E(n){ return document.createElementNS(NS,n); }
  svg.innerHTML = "";
  svg.setAttribute("viewBox","0 0 320 320");

  const face = E("circle"); face.setAttribute("cx",160); face.setAttribute("cy",160); face.setAttribute("r",150); face.setAttribute("class","face"); svg.appendChild(face);

  // 目盛
  for(let i=0;i<60;i++){
    const tick = E("line");
    const a = (Math.PI*2) * (i/60);
    const R1 = i%5===0 ? 135 : 145;
    const R2 = 150;
    tick.setAttribute("x1", 160 + R1*Math.sin(a));
    tick.setAttribute("y1", 160 - R1*Math.cos(a));
    tick.setAttribute("x2", 160 + R2*Math.sin(a));
    tick.setAttribute("y2", 160 - R2*Math.cos(a));
    tick.setAttribute("class", i%5===0 ? "tick-hr" : "tick-min");
    svg.appendChild(tick);
  }
  // 数字
  for(let h=1;h<=12;h++){
    const a = (Math.PI*2) * (h/12);
    const t = E("text"); t.textContent = h; t.setAttribute("class","num");
    t.setAttribute("x", 160 + 115*Math.sin(a));
    t.setAttribute("y", 160 - 115*Math.cos(a));
    svg.appendChild(t);
  }

  const handMin = E("line"); handMin.setAttribute("x1",160); handMin.setAttribute("y1",160); handMin.setAttribute("x2",160); handMin.setAttribute("y2",60); handMin.setAttribute("class","hand-min"); svg.appendChild(handMin);
  const handHr  = E("line"); handHr.setAttribute("x1",160); handHr.setAttribute("y1",160); handHr.setAttribute("x2",160); handHr.setAttribute("y2",90); handHr.setAttribute("class","hand-hr"); svg.appendChild(handHr);
  const pin = E("circle"); pin.setAttribute("cx",160); pin.setAttribute("cy",160); pin.setAttribute("r",6); pin.setAttribute("class","pin"); svg.appendChild(pin);

  function setTime(h,m){
    const degMin = m*6;
    const degHr  = (h%12)*30 + m*0.5;
    handMin.style.transform = `rotate(${degMin}deg)`;
    handHr.style.transform  = `rotate(${degHr}deg)`;
  }
  return { setTime };
}

/* ========= かんたん紙吹雪 ========= */
function celebrate(ms=1500){
  const canvas = document.getElementById('confetti-canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = innerWidth; canvas.height = innerHeight; canvas.style.display='block';
  const N = 120, parts=[];
  for(let i=0;i<N;i++){
    parts.push({x:Math.random()*canvas.width,y:Math.random()*-canvas.height,vx:(Math.random()*2-1)*1.2,vy:2+Math.random()*3,r:2+Math.random()*5,c:`hsl(${Math.random()*360},90%,60%)`});
  }
  const t0 = performance.now();
  (function loop(t){
    const dt = (t-t0);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(const p of parts){
      p.x += p.vx; p.y += p.vy; if(p.y>canvas.height){ p.y=-10; p.x=Math.random()*canvas.width; }
      ctx.fillStyle=p.c; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
    }
    if(dt < ms) requestAnimationFrame(loop); else canvas.style.display='none';
  })(t0);
}
</script>
</body>
</html>
