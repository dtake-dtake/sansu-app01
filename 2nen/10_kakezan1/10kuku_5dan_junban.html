<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>‰∫î„ÅÆÊÆµ„ÅÆ‰πù‰πùÔºà„Åò„ÇÖ„Çì„Å∞„ÇìÔºâ</title>
  
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  
  <style>
    body {
      font-family: 'HiraMaruProN-W4', '„Éí„É©„ÇÆ„Éé‰∏∏„Ç¥ ProN W4', '„É°„Ç§„É™„Ç™', Meiryo, sans-serif;
      background: #e0f2f7;
      margin: 20px;
      color: #333;
      font-size: 2.2rem;
      line-height: 1.6;
    }
    h1, h2 {
      text-align: center;
      margin: 15px 0;
      color: #1e88e5;
      text-shadow: 2px 2px 3px rgba(0,0,0,0.1);
      white-space: nowrap;
    }
    h1 { font-size: 3.5rem; }
    h2 { font-size: 2.5rem; margin-bottom: 40px; }
    #problems-wrapper {
      max-width: 650px;
      margin: 0 auto 30px;
      padding: 30px;
      border: 4px dashed #90caf9;
      background: #ffffff;
      box-shadow: 5px 5px 10px rgba(0,0,0,.15);
      border-radius: 20px;
    }
    .problem {
      display: flex;
      align-items: center;
      margin-bottom: 25px;
      background: #f0f8ff;
      padding: 10px 15px;
      border-radius: 10px;
      box-shadow: 1px 1px 3px rgba(0,0,0,.08);
    }
    .problem-number {
      width: 70px;
      text-align: right;
      margin-right: 25px;
      font-weight: bold;
      font-size: 2.5rem;
      color: #0d47a1;
      flex-shrink: 0;
    }
    .problem-equation {
      flex: 1;
      display: flex;
      align-items: center;
      font-size: 2.5rem;
      flex-shrink: 0;
    }
    .problem-equation span { margin: 0 12px; }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
      width: 80px;
      font-size: 2.5rem;
      margin-left: 15px;
      padding: 8px;
      border: 2px solid #64b5f6;
      border-radius: 8px;
    }
    .button-area { text-align: center; margin-bottom: 30px; }
    button {
      font-size: 2.5rem;
      margin: 0 15px;
      padding: 15px 30px;
      background: #42a5f5;
      color: white;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      box-shadow: 3px 3px 6px rgba(0,0,0,.2);
      transition: background 0.3s ease, transform 0.1s ease;
    }
    button:hover {
      background: #2196f3;
      transform: translateY(-2px);
    }
    button:disabled {
      background: #ccc;
      cursor: default;
      box-shadow: none;
      transform: none;
    }
    #result-area {
      text-align: center;
      margin-bottom: 25px;
      background: #e3f2fd;
      padding: 20px;
      border-radius: 15px;
      border: 2px solid #90caf9;
    }
    #result {
      font-size: 2.8rem;
      font-weight: bold;
      margin: 15px 0;
      min-height: 4rem;
      color: #1e88e5;
    }
    #highScoreArea, #clearCountArea, #monthlyCountArea, #dailyCountArea {
      font-size: 2.2rem;
      margin: 8px 0;
    }
    #overallStatusArea {
        font-size: 2.2rem;
        margin: 8px 0;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    #overallStatusText { margin-right: 10px; }
    #highScoreValue, #clearCountValue, #monthlyCountValue, #dailyCountValue {
      font-weight: bold;
      margin: 0 12px;
      color: #2e7d32;
    }
    #reset-highscore {
      font-size: 1.8rem;
      margin-left: 15px;
      padding: 8px 18px;
      background: #ef5350;
      color: white;
      border-radius: 10px;
      box-shadow: 2px 2px 4px rgba(0,0,0,.15);
    }
    #history-area {
      font-size: 1.8rem;
      margin: 20px auto;
      text-align: left;
      max-width: 500px;
      padding: 10px;
      background: #bbdefb;
      border-radius: 10px;
      border: 1px solid #90caf9;
    }
    #history-list { list-style: none; padding: 0; margin: 0; }
    #history-list li { margin: 6px 0; color: #1a237e; }
    .result-icon {
      margin-left: 15px;
      font-size: 2.5rem;
      font-weight: bold;
      white-space: nowrap;
    }
    .correct { color: #388e3c; }
    .wrong { color: #d32f2f; }

    .status-stars {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      vertical-align: middle;
      margin: 0 1px;
      font-size: 2.2rem;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      line-height: 1;
    }
    .stars-circle   { color: #42a5f5; }
    .stars-bronze   { color: #cd7f32; }
    .stars-silver   { color: #c0c0c0; }
    .stars-gold     { color: #ffd700; }
    .stars-platinum { color: #e5e4e2; text-shadow: 0 0 5px #fff; }
    .stars-rainbow {
      background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
      background-size: 200% 200%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: rainbow-animation 3s ease-in-out infinite;
    }
    @keyframes rainbow-animation {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes sparkle {
      0% { filter: brightness(1) drop-shadow(0 0 2px gold); transform: scale(1); }
      50% { filter: brightness(1.5) drop-shadow(0 0 6px gold); transform: scale(1.1); }
      100% { filter: brightness(1) drop-shadow(0 0 2px gold); transform: scale(1); }
    }
    .sparkle-animation {
        animation: sparkle 1.2s ease-in-out infinite;
    }
  </style>
</head>
<body>
  <h1>10„ÄÄ„Åã„ÅëÁÆó(1)</h1>
  <h2>‰∫î„ÅÆÊÆµ„ÅÆ‰πù‰πùÔºà„Åò„ÇÖ„Çì„Å∞„ÇìÔºâ</h2>

  <div id="start-area" style="text-align:center; margin:40px 0;">
    <button id="start-btn">„Çπ„Çø„Éº„ÉàÔºÅ</button>
  </div>

  <div id="problems-section" style="display:none;">
    <div id="problems-wrapper"></div>
    <div class="button-area">
      <button id="check-answers">„Åæ„Çã„Å§„Åë</button>
      <button id="retry">„ÇÇ„ÅÜ„ÅÑ„Å°„Å©</button>
    </div>
  </div>

  <div id="result-area">
    <div id="result"></div>
    <div id="highScoreArea">„Éè„Ç§„Çπ„Ç≥„Ç¢Ôºö<span id="highScoreValue">0</span> „Å¶„Çì <button id="reset-highscore">„É™„Çª„ÉÉ„Éà</button></div>
    <div id="dailyCountArea">‰ªäÊó•„ÅÆ„ÇØ„É™„Ç¢Ôºö<span id="dailyCountValue">0</span> „Åã„ÅÑ</div>
    <div id="monthlyCountArea">‰ªäÊúà„ÅÆ„ÇØ„É™„Ç¢Ôºö<span id="monthlyCountValue">0</span> „Åã„ÅÑ</div>
    <div id="clearCountArea">ÂêàË®à„ÇØ„É™„Ç¢Ôºö<span id="clearCountValue">0</span> „Åã„ÅÑ</div>
    <div id="overallStatusArea"><span id="overallStatusText">„Çπ„ÉÜ„Éº„Çø„ÇπÔºö</span><span id="overallStars" class="status-stars">‚Äï</span></div>
    <div id="history-area">„Çä„Çå„ÅçÔºàÔºëÔºê‰ª∂Ôºâ<br><ul id="history-list"></ul></div>
  </div>

  <script>
    const APP_ID = "kuku-5dan-junban-final";
    const KEY_HS             = `${APP_ID}:hs`;
    const KEY_HISTORY        = `${APP_ID}:history`;
    const KEY_CLEAR          = `${APP_ID}:clearCount`;
    const KEY_MONTHLY_PREFIX = `${APP_ID}:monthlyClear-`;
    const KEY_DAILY_PREFIX   = `${APP_ID}:dailyClear-`;
    const KEY_OVERALL_STATUS = `${APP_ID}:status`;

    const NUM_QUESTIONS = 9;
    const TIME_LIMIT    = NUM_QUESTIONS * 3;

    const SCORE_STARS_THRESHOLD = {
        star_circle: 100, star1: 110, star2: 120, star3: 130, star4: 140, star5: 150
    };

    let problems = [], startTime = 0, highScore = 0;
    let totalClearCount = 0, monthlyCount = 0, dailyCount = 0;
    let overallStatusStars = '‚Äï', incorrectIndices = [];
    
    // ‚òÖ‚òÖ‚òÖ „É´„Éº„Éó„Åô„ÇãÁ¥ôÂêπÈõ™„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ID„Çí‰øùÂ≠ò„Åô„ÇãÂ§âÊï∞ ‚òÖ‚òÖ‚òÖ
    let confettiIntervalId = null;

    const nowDT = () => new Date().toLocaleString();
    const scrollCenter = el => el.scrollIntoView({ behavior: "smooth", block: "center" });

    const ls = localStorage;
    function loadHighScore() { highScore = +ls.getItem(KEY_HS) || 0; }
    function saveHighScore(v) { ls.setItem(KEY_HS, String(v)); }

    function loadClearCounts() {
        const todayKey = KEY_DAILY_PREFIX + new Date().toISOString().slice(0, 10);
        const monthKey = KEY_MONTHLY_PREFIX + new Date().toISOString().slice(0, 7);
        totalClearCount = +ls.getItem(KEY_CLEAR) || 0;
        monthlyCount = +ls.getItem(monthKey) || 0;
        dailyCount = +ls.getItem(todayKey) || 0;
    }
    function saveClearCounts() {
        const todayKey = KEY_DAILY_PREFIX + new Date().toISOString().slice(0, 10);
        const monthKey = KEY_MONTHLY_PREFIX + new Date().toISOString().slice(0, 7);
        ls.setItem(KEY_CLEAR, String(totalClearCount));
        ls.setItem(monthKey, String(monthlyCount));
        ls.setItem(todayKey, String(dailyCount));
    }

    function loadHistory() { try { return JSON.parse(ls.getItem(KEY_HISTORY)) || []; } catch { return [] } }
    function saveHistory(e) {
      const h = loadHistory(); h.unshift(e);
      if (h.length > 10) h.pop();
      ls.setItem(KEY_HISTORY, JSON.stringify(h));
      renderHistory(h);
    }

    function loadOverallStatus() { overallStatusStars = ls.getItem(KEY_OVERALL_STATUS) || '‚Äï'; }
    function saveOverallStatus(starsHtml) { ls.setItem(KEY_OVERALL_STATUS, starsHtml); }

    function renderHistory(hist) {
      document.querySelector('#history-list').innerHTML =
        hist.map(x => `<li>${x.datetime}Ôºö${x.score}„Å¶„Çì</li>`).join('');
    }
    function updateHighScore() { document.querySelector('#highScoreValue').textContent = highScore; }
    function updateAllClearCountsDisplay() {
        document.querySelector('#clearCountValue').textContent = totalClearCount;
        document.querySelector('#monthlyCountValue').textContent = monthlyCount;
        document.querySelector('#dailyCountValue').textContent = dailyCount;
    }
    function updateOverallStatusDisplay() {
        document.querySelector('#overallStars').innerHTML = overallStatusStars;
    }

    function generateProblems() {
      problems = [];
      for (let b = 1; b <= 9; b++) {
          problems.push({ a: 5, b, op: '√ó' });
      }
    }

    function displayProblems() {
      const wrap = document.querySelector('#problems-wrapper'); wrap.innerHTML = '';
      problems.forEach((p, i) => {
        const row = document.createElement('div'); row.className = 'problem';
        const num = document.createElement('div'); num.className = 'problem-number'; num.textContent = (i + 1) + '.';
        const eq = document.createElement('div'); eq.className = 'problem-equation';
        eq.innerHTML = `<span>${p.a}</span><span>${p.op}</span><span>${p.b}</span>=`;
        const inp = document.createElement('input'); inp.type = 'number'; inp.id = `ans-${i}`;
        inp.addEventListener('focus', () => scrollCenter(inp));
        inp.addEventListener('keydown', e => {
          if (e.key === 'Enter') {
            e.preventDefault();
            const currentId = e.target.id;
            const currentProblemIndex = parseInt(currentId.replace('ans-', ''));
            let nextIndexToFocus = -1;

            if (incorrectIndices.length > 0) {
              const currentIndexInIncorrect = incorrectIndices.indexOf(currentProblemIndex);
              if (currentIndexInIncorrect > -1 && currentIndexInIncorrect < incorrectIndices.length - 1) {
                nextIndexToFocus = incorrectIndices[currentIndexInIncorrect + 1];
              }
            } else if (currentProblemIndex < NUM_QUESTIONS - 1) {
                nextIndexToFocus = currentProblemIndex + 1;
            }

            if (nextIndexToFocus !== -1) {
                document.querySelector(`#ans-${nextIndexToFocus}`).focus();
            } else {
                document.querySelector('#check-answers').focus();
            }
          }
        });
        const icon = document.createElement('span'); icon.id = `icon-${i}`; icon.className = 'result-icon';
        eq.append(inp, icon);
        row.append(num, eq);
        wrap.appendChild(row);
      });
    }

    function checkAnswers() {
      document.querySelector('#check-answers').disabled = true;
      let newIncorrectIndices = [];

      problems.forEach((p, i) => {
        const inputField = document.querySelector(`#ans-${i}`);
        const user = inputField.value;
        const ans = p.a * p.b;
        const icon = document.querySelector(`#icon-${i}`);
        icon.textContent = '';
        icon.classList.remove('correct', 'wrong');
        inputField.style.borderColor = '#64b5f6';

        if (user !== '' && +user === ans) {
          icon.textContent = '‚óã';
          icon.classList.add('correct');
          inputField.disabled = true;
        } else {
          icon.textContent = '√ó';
          icon.classList.add('wrong');
          inputField.disabled = false;
          inputField.value = '';
          inputField.style.borderColor = '#d32f2f';
          newIncorrectIndices.push(i);
        }
      });
      incorrectIndices = newIncorrectIndices;

      if (incorrectIndices.length === 0) { // ÂÖ®ÂïèÊ≠£Ëß£
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        const baseScore = 100;
        let timeBonus = 0;
        if (elapsed < TIME_LIMIT) {
            timeBonus = Math.floor(50 * ((TIME_LIMIT - elapsed) / TIME_LIMIT));
        }
        let score = baseScore + timeBonus;

        let message = 'üéâ ÂÖ®ÂïèÊ≠£Ëß£ÔºÅ„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ üéâ';
        if (score > highScore) {
            message = 'üèÜ „Éè„Ç§„Çπ„Ç≥„Ç¢ÈÅîÊàêÔºÅ„Åô„Åî„ÅÑÔºÅ üèÜ';
            highScore = score;
            saveHighScore(score);
            updateHighScore();
            
            // ‚òÖ‚òÖ‚òÖ „É´„Éº„Éó„Åô„ÇãÁ¥ôÂêπÈõ™„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÈñãÂßã ‚òÖ‚òÖ‚òÖ
            if (confettiIntervalId) clearInterval(confettiIntervalId); // Âøµ„ÅÆ„Åü„ÇÅÊó¢Â≠ò„ÅÆ„É´„Éº„Éó„Çí„ÇØ„É™„Ç¢
            
            confettiIntervalId = setInterval(function() {
              confetti({
                particleCount: 2,
                startVelocity: 10,
                spread: 360,
                origin: {
                  x: Math.random(),
                  y: Math.random() - 0.2 // ÁîªÈù¢‰∏äÈÉ®„Åã„ÇâÂ∞ë„Åó„É©„É≥„ÉÄ„É†„Å´
                },
                ticks: 400,
                gravity: 0.3,
                scalar: 0.8,
                colors: ['#FFC700', '#FF0000', '#FFFFFF', '#00FF00']
              });
            }, 300); // 300„Éü„É™Áßí„Åî„Å®„Å´Áô∫Â∞Ñ
        }

        document.querySelector('#result').innerHTML = `${message}<br>„Çπ„Ç≥„Ç¢: <strong>${score}ÁÇπ</strong> („Çø„Ç§„É†: ${elapsed} Áßí)`;

        let starsHtml = '‚Äï';
        if (score >= SCORE_STARS_THRESHOLD.star5) {
            starsHtml = `<span class="stars-rainbow status-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>`;
        } else if (score >= SCORE_STARS_THRESHOLD.star4) {
            starsHtml = `<span class="stars-platinum status-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span>`;
        } else if (score >= SCORE_STARS_THRESHOLD.star3) {
            starsHtml = `<span class="stars-gold status-stars">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span>`;
        } else if (score >= SCORE_STARS_THRESHOLD.star2) {
            starsHtml = `<span class="stars-silver status-stars">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ</span>`;
        } else if (score >= SCORE_STARS_THRESHOLD.star1) {
            starsHtml = `<span class="stars-bronze status-stars">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ</span>`;
        } else if (score >= SCORE_STARS_THRESHOLD.star_circle) {
            starsHtml = `<span class="stars-circle status-stars">‚óã</span>`;
        }
        
        overallStatusStars = starsHtml;
        saveOverallStatus(starsHtml);
        const overallStarsSpan = document.querySelector('#overallStars');
        overallStarsSpan.innerHTML = overallStatusStars;
        if (starsHtml !== '‚Äï') {
            overallStarsSpan.classList.add('sparkle-animation');
        }

        totalClearCount++; monthlyCount++; dailyCount++;
        saveClearCounts();
        updateAllClearCountsDisplay();
        saveHistory({ datetime: nowDT(), score });

        document.querySelectorAll('input[type=number]').forEach(i => i.disabled = true);
        const retryBtn = document.querySelector('#retry');
        retryBtn.focus();
        scrollCenter(retryBtn);

      } else { // „Åæ„Å†ÈñìÈÅï„ÅÑ„Åå„ÅÇ„Çã
        document.querySelector('#result').innerHTML = '„Åä„Åó„ÅÑÔºÅ„Åæ„Å°„Åå„ÅÑ„ÇíÁõ¥„Åó„Å¶„ÄÅ„ÇÇ„ÅÜ„ÅÑ„Å°„Å©„Äå„Åæ„Çã„Å§„Åë„Äç„Åó„Çà„ÅÜÔºÅ';
        document.querySelector('#result').style.color = '#d32f2f';
        document.querySelector('#check-answers').disabled = false;
        document.querySelector(`#ans-${incorrectIndices[0]}`).focus();
      }
    }
    
    // ‚òÖ‚òÖ‚òÖ Á¥ôÂêπÈõ™„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÂÅúÊ≠¢„Åô„ÇãÂÖ±ÈÄöÈñ¢Êï∞ ‚òÖ‚òÖ‚òÖ
    function stopConfetti() {
        if (confettiIntervalId) {
            clearInterval(confettiIntervalId);
            confettiIntervalId = null;
        }
    }

    function retry() {
      // ‚òÖ‚òÖ‚òÖ „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÂÅúÊ≠¢ ‚òÖ‚òÖ‚òÖ
      stopConfetti();

      startTime = Date.now();
      document.querySelector('#check-answers').disabled = false;
      incorrectIndices = [];
      generateProblems();
      displayProblems();
      document.querySelector('#result').textContent = '';
      document.querySelector('#result').style.color = '#1e88e5';
      const overallStarsSpan = document.querySelector('#overallStars');
      overallStarsSpan.classList.remove('sparkle-animation');
      if (overallStatusStars === '‚Äï') {
          overallStarsSpan.innerHTML = '‚Äï';
      }
      document.querySelector('#ans-0').focus();
    }

    function resetAll() {
        if (confirm('„Éè„Ç§„Çπ„Ç≥„Ç¢„Å®„Çπ„ÉÜ„Éº„Çø„Çπ„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
            // ‚òÖ‚òÖ‚òÖ „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÂÅúÊ≠¢ ‚òÖ‚òÖ‚òÖ
            stopConfetti();

            highScore = 0;
            ls.removeItem(KEY_HS);
            updateHighScore();
            overallStatusStars = '‚Äï';
            saveOverallStatus(overallStatusStars);
            updateOverallStatusDisplay();
            document.querySelector('#overallStars').classList.remove('sparkle-animation');
        }
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadHighScore();
      loadClearCounts();
      loadOverallStatus();
      updateHighScore();
      updateAllClearCountsDisplay();
      updateOverallStatusDisplay();
      renderHistory(loadHistory());
      document.querySelector('#check-answers').onclick = checkAnswers;
      document.querySelector('#retry').onclick = retry;
      document.querySelector('#reset-highscore').onclick = resetAll;

      const startBtn = document.querySelector('#start-btn');
      const startArea = document.querySelector('#start-area');
      const problemsSection = document.querySelector('#problems-section');

      startBtn.onclick = () => {
        startArea.style.display = 'none';
        problemsSection.style.display = 'block';
        retry();
      };
      document.addEventListener('keydown', e => {
          if (e.key === 'Enter' && startArea.style.display !== 'none') {
              startBtn.click();
          }
      });
    });
  </script>
</body>
</html>