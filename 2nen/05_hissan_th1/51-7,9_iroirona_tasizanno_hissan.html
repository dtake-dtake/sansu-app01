<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>５　たし算とひき算のひっ算⑴｜いろいろなたし算のひっ算</title>

  <!-- 共通スタイル -->
  <link rel="stylesheet" href="common.css" />

  <!-- 紙吹雪（ハイスコア更新時） -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <!-- テーマ定義 -->
  <script src="themes.js"></script>

  <!-- スコア/星/履歴/紙吹雪の共通ユーティリティ -->
  <script src="common.js"></script>

  <style>
    /* 筆算テーブル（最小スタイル） */
    .hissan-table{ border-collapse:collapse; margin:26px auto; font-family:"Kyokasho","教科書体",serif; direction:rtl }
    .hissan-table td{
      width:70px; height:70px; text-align:center; vertical-align:middle;
      font-size:3rem; padding:0; border:none; direction:ltr; position:relative;
    }
    .carry-row td{ height:46px } /* 上段は少し低め */
    .carry-input{
      font-size:2.2rem; color:#d32f2f; border:1px solid #ddd;
      width:100%; height:100%; border-radius:8px; background:transparent;
      text-align:center; box-sizing:border-box;
    }
    .answer-row td:not(.problem-number-cell){ border-top:3px solid #333 }
    .sign-col{ width:40px }
    .problem-number-cell{ font-size:2.0rem; color:var(--c-primary-dark); font-weight:bold; padding-right:10px; font-family:sans-serif }
  </style>
</head>
<body>
  <h1 id="main-title">５　たし算とひき算のひっ算⑴</h1>
  <h2 id="sub-title">いろいろなたし算のひっ算</h2>

  <div id="start-area" style="text-align:center; margin:24px 0;">
    <button id="start-btn">スタート！</button>
  </div>

  <div id="problems-section" style="display:none;">
    <div id="problems-wrapper"></div>
    <div class="button-area">
      <button id="check-answers">まるつけ</button>
      <button id="retry">もういちど</button>
    </div>
  </div>

  <div id="result-area">
    <div id="result"></div>
    <div id="highScoreArea">ハイスコア：<span id="highScoreValue">0</span> てん <button id="reset-highscore">リセット</button></div>
    <div id="dailyCountArea">今日のクリア：<span id="dailyCountValue">0</span> かい</div>
    <div id="monthlyCountArea">今月のクリア：<span id="monthlyCountValue">0</span> かい</div>
    <div id="clearCountArea">合計クリア：<span id="clearCountValue">0</span> かい</div>
    <div id="overallStatusArea">ステータス：<span id="overallStars" class="status-stars">―</span></div>
    <div id="history-area">りれき（１０件）<br><ul id="history-list"></ul></div>
  </div>

<script>
/* =========================
   設定
========================= */
/* name: 51-7,9_iroirona_tasizanno_hissan */
const APP_ID = 'g2_51_7_9_iroirona_tasizanno_hissan';
const STAR_THRESHOLDS = { circle:100, star1:110, star2:120, star3:130, star4:140, star5:150 };
const NUM_QUESTIONS = 4;

// ドリル固定テーマ（必要なら差し替え）
const SELECTED_THEME = (typeof theme_forest !== 'undefined') ? theme_forest : {};
function applyThemeColors(themeObj){
  const root = document.documentElement;
  Object.entries(themeObj || {}).forEach(([k,v])=> root.style.setProperty(k, v));
}

/* ヘルパ */
const randInt = (min,max)=> Math.floor(Math.random()*(max-min+1))+min;
const toD2 = n => toDigits(n,2); // common.js の toDigits を利用

/* =========================
   出題（全4問）
========================= */
let problems = [];

/* 1) たす数が 10n（きりのよい数）：A(10..99) + B∈{10,20,...,90}, A+B <= 99 */
function genQ1(){
  for(let k=0;k<1000;k++){
    const a = randInt(10,99);
    const b = randInt(1,9)*10;
    const s = a + b;
    if (s <= 99){
      const [at,ao] = toD2(a), [bt,bo] = toD2(b), [st,so]=toD2(s);
      const carryT = (ao+bo>=10)?1:null; // 10の位上：繰上がりがあれば1、なければ空欄
      return { numA:{t:at,o:ao}, numB:{t:bt,o:bo}, answer:{t:st,o:so}, carry:{o:null, t:carryT} };
    }
  }
  return null;
}

/* 2) 一の位どうし=10、解が10n：A(10..99)+B(10..99), a1+b1=10, A+B<=99 */
function genQ2(){
  for(let k=0;k<2000;k++){
    const ao = randInt(1,9);
    const bo = 10 - ao;
    const at = randInt(1,9);
    const bt = randInt(0,9);
    const a = at*10 + ao, b = bt*10 + bo, s = a + b;
    if (s <= 99){ // 10n かどうかは a1+b1=10 で保証
      const [st,so]=toD2(s);
      const carryT = 1; // 必ず繰上がり
      return { numA:{t:at,o:ao}, numB:{t:bt,o:bo}, answer:{t:st,o:so}, carry:{o:null, t:carryT} };
    }
  }
  return null;
}

/* 3) 1けた + 2桁（順番固定：1けたが上、2桁が下）。A(1..9)+B(10..99), A+B<=99 */
function genQ3(){
  for(let k=0;k<1000;k++){
    const a = randInt(1,9), b = randInt(10,99), s = a + b;
    if (s <= 99){
      const [bt,bo] = toD2(b), [st,so]=toD2(s);
      const ao = a%10, at = 0;
      const carryT = (ao+bo>=10)?1:null;
      return { numA:{t:at,o:ao}, numB:{t:bt,o:bo}, answer:{t:st,o:so}, carry:{o:null, t:carryT} };
    }
  }
  return null;
}

/* 4) 2桁 + 1けた（順番固定：2桁が上、1けたが下）。A(10..99)+B(1..9), A+B<=99 */
function genQ4(){
  for(let k=0;k<1000;k++){
    const a = randInt(10,99), b = randInt(1,9), s = a + b;
    if (s <= 99){
      const [at,ao] = toD2(a);
      const bt = 0, bo = b;
      const [st,so]=toD2(s);
      const carryT = (ao+bo>=10)?1:null;
      return { numA:{t:at,o:ao}, numB:{t:bt,o:bo}, answer:{t:st,o:so}, carry:{o:null, t:carryT} };
    }
  }
  return null;
}

function generateProblems(){
  problems = [];
  const q1 = genQ1(); if(q1) problems.push(q1);
  const q2 = genQ2(); if(q2) problems.push(q2);
  const q3 = genQ3(); if(q3) problems.push(q3);
  const q4 = genQ4(); if(q4) problems.push(q4);
}

/* =========================
   描画 + ナビ（同一問題内＋問題間）
========================= */
function displayProblems(){
  const wrap = document.getElementById('problems-wrapper'); wrap.innerHTML='';
  problems.forEach((p,i)=>{
    const tb=document.createElement('table'); tb.className='hissan-table';

    // 1桁のときは十の位を空文字にして見た目を整える
    const dispT = v => (v===0 ? '' : v);

    tb.innerHTML = `
      <tr class="carry-row">
        <td><input type="number" class="carry-input" id="carry-o-${i}" inputmode="numeric"></td>
        <td><input type="number" class="carry-input" id="carry-t-${i}" inputmode="numeric"></td>
        <td class="sign-col"></td>
        <td class="problem-number-cell"></td>
      </tr>
      <tr>
        <td>${p.numA.o}</td>
        <td>${dispT(p.numA.t)}</td>
        <td class="sign-col"></td>
        <td class="problem-number-cell">${i+1}.</td>
      </tr>
      <tr>
        <td>${p.numB.o}</td>
        <td>${dispT(p.numB.t)}</td>
        <td class="sign-col">+</td>
        <td class="problem-number-cell"></td>
      </tr>
      <tr class="answer-row">
        <td><input type="number" id="ans-o-${i}" inputmode="numeric"></td>
        <td><input type="number" id="ans-t-${i}" inputmode="numeric"></td>
        <td class="sign-col"></td>
        <td class="problem-number-cell"></td>
      </tr>`;
    wrap.appendChild(tb);

    // 参照
    const o  = document.getElementById(`ans-o-${i}`);   // 1の位（画面では右）
    const t  = document.getElementById(`ans-t-${i}`);   // 10の位（画面では左）
    const co = document.getElementById(`carry-o-${i}`); // 1の位 上
    const ct = document.getElementById(`carry-t-${i}`); // 10の位 上
    const F = el => { if(el){ el.focus(); el.select(); tb.scrollIntoView({behavior:'smooth', block:'center'}); } };

    // 問題間ナビ
    const gotoNextProblem = () => {
      const next = document.getElementById(`ans-o-${i+1}`);
      if (next) { next.focus(); next.select(); next.closest('table')?.scrollIntoView({behavior:'smooth', block:'center'}); }
      else { document.getElementById('check-answers').focus(); }
    };
    const gotoPrevProblemCarry = which => {
      if (i <= 0) return;
      const prev = document.getElementById(`${which}-${i-1}`);
      if (prev) { prev.focus(); prev.select(); prev.closest('table')?.scrollIntoView({behavior:'smooth', block:'center'}); }
    };

    // ---- 同一問題内の左右＆必要最小限のナビ ----
    // 1の位：Enter/← で 十の位、↑ で 1の位上、↓ で 次の問題の 1の位
    o.addEventListener('keydown', e=>{
      if (e.key==='Enter' || e.key==='ArrowLeft'){ e.preventDefault(); F(t); }
      else if (e.key==='ArrowUp'){ e.preventDefault(); F(co); }
      else if (e.key==='ArrowDown'){ e.preventDefault(); gotoNextProblem(); }
    });

    // 十の位：→ で 1の位、↑ で 十の位上、Enter/↓ で 次の問題の 1の位
    t.addEventListener('keydown', e=>{
      if (e.key==='ArrowRight'){ e.preventDefault(); F(o); }
      else if (e.key==='ArrowUp'){ e.preventDefault(); F(ct); }
      else if (e.key==='Enter' || e.key==='ArrowDown'){ e.preventDefault(); gotoNextProblem(); }
    });

    // 上段（キャリー）：左右で co↔ct、↓で下段へ、↑で 前の問題の同じ上段欄 へ
    co.addEventListener('keydown', e=>{
      if (e.key==='ArrowLeft'){ e.preventDefault(); F(ct); }
      else if (e.key==='ArrowDown'){ e.preventDefault(); F(o); }
      else if (e.key==='ArrowUp'){ e.preventDefault(); gotoPrevProblemCarry('carry-o'); }
    });
    ct.addEventListener('keydown', e=>{
      if (e.key==='ArrowRight'){ e.preventDefault(); F(co); }
      else if (e.key==='ArrowDown'){ e.preventDefault(); F(t); }
      else if (e.key==='ArrowUp'){ e.preventDefault(); gotoPrevProblemCarry('carry-t'); }
    });

    // フォーカス時に中央へスクロール
    [o,t,co,ct].forEach(el=>{
      el.addEventListener('focus', ()=> tb.scrollIntoView({behavior:'smooth', block:'center'}));
    });
  });
}

/* =========================
   上下キーで数値が増減しないようにする
========================= */
document.addEventListener('keydown', function(e){
  if (e.target && e.target.type === 'number' && (e.key === 'ArrowUp' || e.key === 'ArrowDown')){
    e.preventDefault();
  }
});

/* =========================
   採点（×の最初へ移動・スクロール）
========================= */
function checkAnswers(){
  let allCorrect = true;
  let firstWrongEl = null;

  problems.forEach((p,i)=>{
    const o  = document.getElementById(`ans-o-${i}`);
    const t  = document.getElementById(`ans-t-${i}`);
    const co = document.getElementById(`carry-o-${i}`);
    const ct = document.getElementById(`carry-t-${i}`);

    // 10の位上：繰上がりがあれば '1'、なければ空欄が正解
    const onesCarry = (p.numA.o + p.numB.o >= 10) ? 1 : null;

    const checks = [
      { el:o,  ok: o.value === String(p.answer.o) },
      { el:t,  ok: t.value === String(p.answer.t) },
      { el:ct, ok: (onesCarry === 1 ? ct.value === '1' : ct.value.trim() === '') },
      { el:co, ok: co.value.trim() === '' } // 1の位上は空欄が正解（加算では使わない）
    ];

    checks.forEach(({el, ok})=>{
      el.classList.remove('incorrect-field','correct-field');
      if (ok){ el.classList.add('correct-field'); el.disabled = true; }
      else{
        allCorrect = false;
        if (!firstWrongEl) firstWrongEl = el;
        el.classList.add('incorrect-field'); el.disabled = false;
      }
    });
  });

  if (!allCorrect){
    Common.showResultNG();
    if (firstWrongEl){
      firstWrongEl.focus(); firstWrongEl.select();
      const tbl = firstWrongEl.closest('table');
      if (tbl) tbl.scrollIntoView({ behavior:'smooth', block:'center' });
    }
    return;
  }

  const elapsed = Common.elapsedSec();
  const score = Common.computeScore(elapsed, 100);
  const starsHtml = Common.buildStarsHtml(score);
  const { isNewHigh } = Common.saveRun(score, starsHtml);
  Common.showResultOK({ score, elapsedSec: elapsed, starsHtml, isNewHigh });
}

/* =========================
   リトライ / 初期化
========================= */
function retry(){
  Common.resetResultArea();
  generateProblems(); displayProblems();
  Common.beginAttempt();
  // はじめは 1の位 にフォーカス
  setTimeout(()=>{ const el=document.getElementById('ans-o-0'); if(el) el.focus(); },0);
}

window.addEventListener('DOMContentLoaded', ()=>{
  // テーマ固定
  applyThemeColors(SELECTED_THEME);

  Common.setup({
    appId: APP_ID,
    starThresholds: STAR_THRESHOLDS,
    timeLimitSec: 60,
    confetti: true
  });

  const startBtn = document.getElementById('start-btn');
  const startArea = document.getElementById('start-area');
  const problemsSection = document.getElementById('problems-section');

  startBtn.onclick = ()=>{ startArea.style.display='none'; problemsSection.style.display='block'; retry(); };
  // Enterでスタート
  document.addEventListener('keydown', e=>{
    if (e.key==='Enter' && startArea.style.display!=='none'){ e.preventDefault(); startBtn.click(); }
  });

  document.getElementById('check-answers').onclick = checkAnswers;
  document.getElementById('retry').onclick = retry;
});
</script>
</body>
</html>
