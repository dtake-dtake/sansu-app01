<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>わくわく　算数ドリル</title>
<style>
body{font-family:'HiraMaruProN-W4','ヒラギノ丸ゴ ProN W4','メイリオ',Meiryo,system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans JP',sans-serif;background:#f0f8ff;margin:0;padding:20px;color:#333;}
h1{ text-align:center;color:#1a73e8;margin-bottom:30px;font-size:2.8em;text-shadow:1px 1px 2px rgba(0,0,0,.1); }
#grade-tabs{ display:flex;justify-content:center;margin-bottom:30px;flex-wrap:wrap;gap:10px; }
.grade-tab{ background:#bbdefb;color:#1a237e;border:none;padding:10px 16px;border-radius:9999px;font-size:1.1em;cursor:pointer;transition:.3s;box-shadow:0 4px 6px rgba(0,0,0,.1);white-space:nowrap; }
.grade-tab:hover{ background:#90caf9; transform:translateY(-2px); }
.grade-tab.active{ background:#2196f3; color:#fff; box-shadow:0 6px 10px rgba(0,0,0,.2); }

#units-container{ max-width:1100px;margin:0 auto; display:flex; flex-direction:column; gap:16px; }
.unit-section{ background:#fff;border-radius:14px;box-shadow:0 4px 10px rgba(0,0,0,.08);padding:14px 16px;border-left:8px solid #64b5f6; }
.unit-section.expanded{ border-left-color:#1e88e5; }

.unit-section h3{ margin:0;display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none; }
.unit-title{ font-size:1.25em;font-weight:700;color:#0d47a1; }
.count-badge{ background:#e3f2fd;color:#0d47a1;border-radius:9999px;padding:2px 10px;font-size:.85em;border:1px solid #bbdefb; }
.toggle-icon{ margin-left:auto;color:#1565c0;font-weight:700; }

.apps-list{ display:none; gap:10px; flex-wrap:wrap; margin-top:12px; }
.app-item{ flex:1 1 320px; display:flex; align-items:center; justify-content:space-between; gap:10px; box-sizing:border-box;
  background:#fafafa; padding:12px 14px; border-radius:12px; border:1px solid #e0e0e0; text-decoration:none; color:#333;
  box-shadow:0 2px 6px rgba(0,0,0,.06); transition:transform .15s, box-shadow .15s, background .15s;}
.app-item:hover{ transform:translateY(-2px); box-shadow:0 6px 12px rgba(0,0,0,.12); background:#fff; }

.app-title-section{ font-size:1.05em; font-weight:600; }
.app-status-section{ display:flex; gap:12px; align-items:center; }
.app-score{ font-size:.95em; color:#1976d2; }
.app-stars{ font-size:1.1em; }
.app-stars.no-data{ color:#999; }

/* レスポンシブ */
@media (max-width:640px){
  .app-item{ flex:1 1 100%; }
}
</style>
</head>
<body>
<h1>わくわく算数 ドリル</h1>

<div id="grade-tabs"></div>
<div id="units-container"></div>

<script>
/* ====== 定数（開閉状態など） ====== */
const LAST_SELECTED_GRADE_KEY = 'lastSelectedGrade';
const OPEN_UNITS_KEY_PREFIX   = 'openUnits:';  // 学年ごとに保存

document.addEventListener('DOMContentLoaded', () => {
  const gradeTabsContainer = document.getElementById('grade-tabs');
  const unitsContainer     = document.getElementById('units-container');

  /* ---------- id属性ベースのストレージ読取（互換込み） ---------- */
  function appIdFromItemId(itemId){
    // "app-<id>" → "<id>"
    return String(itemId || '').replace(/^app-/, '');
  }
  function firstExisting(keys){
    for (const k of keys){
      const v = localStorage.getItem(k);
      if (v !== null) return v;
    }
    return null;
  }
  function getStatsByAppId(appId){
    const hsRaw = firstExisting([
      `${appId}:hs`,
      `${appId}_highScore`,
      `${appId}:highScore`
    ]);
    const statusRaw = firstExisting([
      `${appId}:status`,
      `${appId}_overallStatus`,
      `${appId}:overallStatus`
    ]);
    return {
      highScore: hsRaw !== null ? parseInt(hsRaw, 10) : null,
      overallStatus: statusRaw
    };
  }
  function getStatsByElement(el){
    const appId = appIdFromItemId(el.id);
    return getStatsByAppId(appId);
  }

  /* ---------- 学年ごとの開閉保存 ---------- */
  const getOpenUnitsForGrade = (grade) => {
    try{ return JSON.parse(localStorage.getItem(OPEN_UNITS_KEY_PREFIX + grade)) || []; }
    catch{ return []; }
  };
  const setOpenUnitsForGrade = (grade, arr) =>
    localStorage.setItem(OPEN_UNITS_KEY_PREFIX + grade, JSON.stringify(arr));

  /* ---------- 実ファイル(.html)だけを残す前処理 ---------- */
  const isImplemented = (app) =>
    app && typeof app.path === 'string' && /\.html?$/i.test(app.path);

  function sanitizeAppData(data){
    return (data || []).map(grade => ({
      ...grade,
      units: (grade.units || [])
        .map(u => ({ ...u, apps: (u.apps || []).filter(isImplemented) }))
        .filter(u => u.apps.length > 0)
    })).filter(g => (g.units || []).length > 0);
  }

  /* ---------- UI初期化 ---------- */
  function initializeUI(appData){
    let initialGradeIndex = 0;
    const last = localStorage.getItem(LAST_SELECTED_GRADE_KEY);
    if (last){
      const i = appData.findIndex(g => g.grade === last);
      if (i !== -1) initialGradeIndex = i;
    }

    appData.forEach((gradeData, idx) => {
      const tab = document.createElement('button');
      tab.textContent = gradeData.grade;
      tab.className = 'grade-tab';
      if (idx === initialGradeIndex){
        tab.classList.add('active');
        displayUnits(gradeData.grade, gradeData.units);
      }
      tab.addEventListener('click', () => {
        document.querySelectorAll('.grade-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        localStorage.setItem(LAST_SELECTED_GRADE_KEY, gradeData.grade);
        displayUnits(gradeData.grade, gradeData.units);
      });
      gradeTabsContainer.appendChild(tab);
    });
  }

  /* ---------- 単元＆アプリ描画 ---------- */
  function displayUnits(gradeName, units){
    unitsContainer.innerHTML = '';
    let openUnits = getOpenUnitsForGrade(gradeName);

    units.forEach(unit => {
      const unitSection = document.createElement('div');
      unitSection.className = 'unit-section';

      const apps = Array.isArray(unit.apps) ? unit.apps : [];
      const appsCount = apps.length;

      const unitHeader = document.createElement('h3');
      unitHeader.innerHTML = `
        <span class="unit-title">${unit.name}</span>
        <span class="count-badge" title="この単元のドリル数">${appsCount}</span>
        <span class="toggle-icon">▼</span>
      `;
      unitSection.appendChild(unitHeader);

      const appsList = document.createElement('div');
      appsList.className = 'apps-list';

      // 実体(.html)のみ（sanitizeAppData 済み）
      apps.forEach(app => {
        const a = document.createElement('a');
        a.href  = app.path;
        a.className = 'app-item';
        a.id = `app-${app.id}`;

        const title = document.createElement('div');
        title.className = 'app-title-section';
        title.textContent = app.title;

        const status = document.createElement('div');
        status.className = 'app-status-section';

        const scoreSpan = document.createElement('span');
        scoreSpan.className = 'app-score';
        scoreSpan.textContent = 'ハイスコア: -';

        const starsSpan = document.createElement('span');
        starsSpan.className = 'app-stars no-data';
        starsSpan.textContent = '―';

        status.appendChild(scoreSpan);
        status.appendChild(starsSpan);

        // localStorage からスコア/★を復元
        const stats = getStatsByElement(a);
        if (stats.highScore !== null) scoreSpan.textContent = `ハイスコア: ${stats.highScore}点`;
        if (stats.overallStatus){
          starsSpan.classList.remove('no-data');
          starsSpan.innerHTML = stats.overallStatus;
        }

        a.appendChild(title);
        a.appendChild(status);
        appsList.appendChild(a);
      });

      unitSection.appendChild(appsList);
      unitsContainer.appendChild(unitSection);

      // 開閉状態の適用
      if (openUnits.includes(unit.name)){
        appsList.style.display = 'flex';
        unitSection.classList.add('expanded');
        unitHeader.querySelector('.toggle-icon').textContent = '▲';
      } else {
        appsList.style.display = 'none';
      }

      unitHeader.addEventListener('click', () => {
        const isClosed = (appsList.style.display === 'none');
        if (isClosed){
          appsList.style.display = 'flex';
          unitSection.classList.add('expanded');
          unitHeader.querySelector('.toggle-icon').textContent = '▲';
          if (!openUnits.includes(unit.name)){
            openUnits.push(unit.name);
            setOpenUnitsForGrade(gradeName, openUnits);
          }
        } else {
          appsList.style.display = 'none';
          unitSection.classList.remove('expanded');
          unitHeader.querySelector('.toggle-icon').textContent = '▼';
          openUnits = openUnits.filter(n => n !== unit.name);
          setOpenUnitsForGrade(gradeName, openUnits);
        }
      });
    });
  }

  /* ---------- app_data.json 読み込み ---------- */
  async function loadAppData(){
    try{
      const res = await fetch('app_data.json');
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      const clean = sanitizeAppData(data);   // ← 追加：実体のみ抽出
      initializeUI(clean);
    }catch(err){
      console.error(err);
      unitsContainer.innerHTML = "<p style='text-align:center;color:red;'>アプリデータを読み込めませんでした。'app_data.json' を確認してください。</p>";
    }
  }
  loadAppData();
});
</script>
</body>
</html>
